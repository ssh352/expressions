
set search_path to sipro_data_store,sipro_stage;
set time zone 'utc';
set work_mem to '1200MB';
set constraint_exclusion = on;


-- select * from sipro_data_store.si_finecon;


explain analyze
select 
    sq.start_date
  , sq.growing_netinc_4q_q
  -- , count(sq.w52_pradchg_52w_ann) the_count -- DOES WORK ( 't' 1 PERCENT OF CASES )
  , avg(sq.w52_pradchg_52w_ann) w52_pradchg_52w_ann
  , avg(sq.w26_pradchg_26w_ann) w26_pradchg_26w_ann
  , avg(sq.w13_pradchg_13w_ann) w13_pradchg_13w_ann
from
( select 
      to_timestamp(dateindex_ci*3600*24)::date start_date 
    , ticker_ci 
    , netinc_q1::numeric(15,2)/nullif(assets_q1::numeric(15,2),0.00) > netinc_q2::numeric(15,2)/nullif(assets_q2::numeric(15,2),0.00) and 
      netinc_q2::numeric(15,2)/nullif(assets_q2::numeric(15,2),0.00) > netinc_q3::numeric(15,2)/nullif(assets_q3::numeric(15,2),0.00) and 
      netinc_q3::numeric(15,2)/nullif(assets_q3::numeric(15,2),0.00) > netinc_q4::numeric(15,2)/nullif(assets_q4::numeric(15,2),0.00) and 
      netinc_q4::numeric(15,2)/nullif(assets_q4::numeric(15,2),0.00) > netinc_q5::numeric(15,2)/nullif(assets_q5::numeric(15,2),0.00) growing_netinc_4q_q
    , w52_pradchg_52w_ann
    , w26_pradchg_26w_ann
    , w13_pradchg_13w_ann
  from sipro_data_store.si_finecon 
  where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq_ci is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
  -- and dateindex_ci in (16465,16555)
) sq group by cube(sq.start_date, growing_netinc_4q_q);

-- growing_netinc_4q_q
-- LONG TERM: -4.6  PERCENT BETTER RETURN
-- SHORT TERM: SAME PERCENT              
-- LONGER THAN SHORT TERM: -5 PERCENT 
-- LONGER THAN 'LONGER THAT SHORT TERM' -4 PERCENT
-- 'f' 9.23
-- 't' 4.89 



select 
    sq.start_date
  , sq.growing_netinc_4q_q_mktcap
  -- , count(sq.w52_pradchg_52w_ann) the_count -- DOES WORK ( 't' 1 PERCENT OF CASES )
  , avg(sq.w52_pradchg_52w_ann) w52_pradchg_52w_ann
  , avg(sq.w26_pradchg_26w_ann) w26_pradchg_26w_ann
  , avg(sq.w13_pradchg_13w_ann) w13_pradchg_13w_ann
from
( select 
      to_timestamp(dateindex_ci*3600*24)::date start_date 
    , ticker_ci 
    , netinc_q1::numeric(15,2)/nullif(mktcap_q1::numeric(15,2),0.00) > netinc_q2::numeric(15,2)/nullif(mktcap_q2::numeric(15,2),0.00) and 
      netinc_q2::numeric(15,2)/nullif(mktcap_q2::numeric(15,2),0.00) > netinc_q3::numeric(15,2)/nullif(mktcap_q3::numeric(15,2),0.00) and 
      netinc_q3::numeric(15,2)/nullif(mktcap_q3::numeric(15,2),0.00) > netinc_q4::numeric(15,2)/nullif(mktcap_q4::numeric(15,2),0.00) and 
      netinc_q4::numeric(15,2)/nullif(mktcap_q4::numeric(15,2),0.00) > netinc_q5::numeric(15,2)/nullif(mktcap_q5::numeric(15,2),0.00) growing_netinc_4q_q_mktcap
    , w52_pradchg_52w_ann
    , w26_pradchg_26w_ann
    , w13_pradchg_13w_ann
  from sipro_data_store.si_finecon 
  where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq_ci is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
  -- and dateindex_ci in (16465,16555)
) sq group by cube(sq.start_date, growing_netinc_4q_q_mktcap);

-- growing_netinc_4q_q_mktcap
-- PERFORMANCE: PUZZLING: GENERALLY WORSE OVER TIME, 
-- RECENTLY LAST YEAR 10-15 PERCENT WORSE, BEFORE THAT 1-3% WORSE
-- 'f' 10.57
-- 't' 4.92 


select 
    sq.start_date
  , sq.growing_netinc_4q_q_assets_and_mktcap
  , count(sq.w52_pradchg_52w_ann) the_count -- DOES WORK ( 't'  0.5 PERCENT OF CASES )
  , avg(sq.w52_pradchg_52w_ann) w52_pradchg_52w_ann
  , avg(sq.w26_pradchg_26w_ann) w26_pradchg_26w_ann
  , avg(sq.w13_pradchg_13w_ann) w13_pradchg_13w_ann
from
( select 
      to_timestamp(dateindex_ci*3600*24)::date start_date 
    , ticker_ci 
    , (
      netinc_q1::numeric(15,2)/nullif(assets_q1::numeric(15,2),0.00) > netinc_q2::numeric(15,2)/nullif(assets_q2::numeric(15,2),0.00) and 
      netinc_q2::numeric(15,2)/nullif(assets_q2::numeric(15,2),0.00) > netinc_q3::numeric(15,2)/nullif(assets_q3::numeric(15,2),0.00) and 
      netinc_q3::numeric(15,2)/nullif(assets_q3::numeric(15,2),0.00) > netinc_q4::numeric(15,2)/nullif(assets_q4::numeric(15,2),0.00) and 
      netinc_q4::numeric(15,2)/nullif(assets_q4::numeric(15,2),0.00) > netinc_q5::numeric(15,2)/nullif(assets_q5::numeric(15,2),0.00)
      ) 
      and 
      (
      netinc_q1::numeric(15,2)/nullif(mktcap_q1::numeric(15,2),0.00) > netinc_q2::numeric(15,2)/nullif(mktcap_q2::numeric(15,2),0.00) and 
      netinc_q2::numeric(15,2)/nullif(mktcap_q2::numeric(15,2),0.00) > netinc_q3::numeric(15,2)/nullif(mktcap_q3::numeric(15,2),0.00) and 
      netinc_q3::numeric(15,2)/nullif(mktcap_q3::numeric(15,2),0.00) > netinc_q4::numeric(15,2)/nullif(mktcap_q4::numeric(15,2),0.00) and 
      netinc_q4::numeric(15,2)/nullif(mktcap_q4::numeric(15,2),0.00) > netinc_q5::numeric(15,2)/nullif(mktcap_q5::numeric(15,2),0.00) 
      ) growing_netinc_4q_q_assets_and_mktcap
    , w52_pradchg_52w_ann
    , w26_pradchg_26w_ann
    , w13_pradchg_13w_ann
  from sipro_data_store.si_finecon 
  where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq_ci is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
  -- and dateindex_ci in (16465,16555)
) sq group by cube(sq.start_date, growing_netinc_4q_q_assets_and_mktcap);
--
-- growing_netinc_4q_q_assets_and_mktcap
-- 'f' 9.24 PERCENT
-- 't' 1.77


select 
    sq.start_date
  , sq.pfs_return_on_assets_sig
  , avg(sq.w52_pradchg_52w_ann) w52_pradchg_52w_ann
  , avg(sq.w26_pradchg_26w_ann) w26_pradchg_26w_ann
  , avg(sq.w13_pradchg_13w_ann) w13_pradchg_13w_ann
from
( select 
      to_timestamp(dateindex_ci*3600*24)::date start_date 
    , ticker_ci 
    , ( netinc_q1::numeric(15,2) + netinc_q2::numeric(15,2) + netinc_q3::numeric(15,2) + netinc_q4::numeric(15,2) ) /  nullif(assets_q5::numeric(15,2),0.00) > 0.00 pfs_return_on_assets_sig
    , w52_pradchg_52w_ann
    , w26_pradchg_26w_ann
    , w13_pradchg_13w_ann
  from sipro_data_store.si_finecon 
  where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq_ci is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
  -- and dateindex_ci in (16465,16555)
) sq group by cube(sq.start_date, pfs_return_on_assets_sig);

-- pfs_return_on_assets_sig ALONE 1

-- BEFORE MID 2015 sq.pfs_return_on_assets_sig = 't' WINS MOST OF THE TIME BY A LITTLE
--  AFTER MID 2015 sq.pfs_return_on_assets_sig = 'f' WINS BY A LOT
-- 't' 7 PERCENT BETTER THAN 'f' OVER TIME-
-- 'f' 3.96 
-- 't' 10.56


-- veriant of above: replace assets with mktcap

select 
    sq.start_date
  , sq.pfs_return_on_mktcap_sig
  , avg(sq.w52_pradchg_52w_ann) w52_pradchg_52w_ann
  , avg(sq.w26_pradchg_26w_ann) w26_pradchg_26w_ann
  , avg(sq.w13_pradchg_13w_ann) w13_pradchg_13w_ann
from
( select 
      to_timestamp(dateindex_ci*3600*24)::date start_date 
    , ticker_ci 
    , ( netinc_q1::numeric(15,2) + netinc_q2::numeric(15,2) + netinc_q3::numeric(15,2) + netinc_q4::numeric(15,2) ) /  nullif(mktcap_q5::numeric(15,2),0.00) > 0.00 pfs_return_on_mktcap_sig
    , w52_pradchg_52w_ann
    , w26_pradchg_26w_ann
    , w13_pradchg_13w_ann
  from sipro_data_store.si_finecon 
  where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq_ci is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
  -- and dateindex_ci in (16465,16555)
) sq group by cube(sq.start_date, pfs_return_on_mktcap_sig);

-- pfs_return_on_mktcap_sig
-- 't' 6 PERCENT BETTER THAN 'f' OVER TIME
-- KEY: BETTER resistant to down-turns
-- 'f'  5.0006
-- 't' 11.88



select 
    sq.start_date
  , sq.pfs_cash_flow_f_operations_sig
  , avg(sq.w52_pradchg_52w_ann) w52_pradchg_52w_ann
  , avg(sq.w26_pradchg_26w_ann) w26_pradchg_26w_ann
  , avg(sq.w13_pradchg_13w_ann) w13_pradchg_13w_ann
from
( select 
      to_timestamp(dateindex_ci*3600*24)::date start_date 
    , ticker_ci 
    , ( tco_q1::numeric(15,2) + tco_q2::numeric(15,2) + tco_q3::numeric(15,2) + tco_q4::numeric(15,2) ) /  nullif(assets_q5::numeric(15,2),0.00) > 0.00 pfs_cash_flow_f_operations_sig
    , w52_pradchg_52w_ann
    , w26_pradchg_26w_ann
    , w13_pradchg_13w_ann
  from sipro_data_store.si_finecon 
  where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq_ci is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
  -- and dateindex_ci in (16465,16555)
) sq group by cube(sq.start_date, pfs_cash_flow_f_operations_sig);

-- pfs_cash_flow_f_operations_sig ALONE 2

-- RECENTLY WINS very WELL ( CASES WHEN 'NEGATIVE' STILL BEATAS OUT FALSE BY 30 PERCENT )
-- LONG TERM 7 PERCENT BETTER OVER 'f' ALL TIME
-- LONG TERN NOTE: 'f' BARELY POSITIVE
--
-- 't' 9.9
-- 'f' 2.51

-- mktcap variant

select 
    sq.start_date
  , sq.pfs_cash_flow_f_operations_sig_mktcap
  , avg(sq.w52_pradchg_52w_ann) w52_pradchg_52w_ann
  , avg(sq.w26_pradchg_26w_ann) w26_pradchg_26w_ann
  , avg(sq.w13_pradchg_13w_ann) w13_pradchg_13w_ann
from
( select 
      to_timestamp(dateindex_ci*3600*24)::date start_date 
    , ticker_ci 
    , ( tco_q1::numeric(15,2) + tco_q2::numeric(15,2) + tco_q3::numeric(15,2) + tco_q4::numeric(15,2) ) /  nullif(mktcap_q5::numeric(15,2),0.00) > 0.00 pfs_cash_flow_f_operations_sig_mktcap
    , w52_pradchg_52w_ann
    , w26_pradchg_26w_ann
    , w13_pradchg_13w_ann
  from sipro_data_store.si_finecon 
  where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq_ci is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
  -- and dateindex_ci in (16465,16555)
) sq group by cube(sq.start_date, pfs_cash_flow_f_operations_sig_mktcap);

-- MKTCAP -1 PERCENT BETTER THAN ASSETS
-- pfs_cash_flow_f_operations_sig ALONE 2 
-- ALL TIME:  8 PERCENT BETTER OVER 'f' A
-- NOTE: 'f' BARELY POSITIVE
--
-- 't' 11.18
-- 'f'  3.33



select 
    sq.start_date
  , sq.pfs_alt_delta_return_on_assets_sig
  , avg(sq.w52_pradchg_52w_ann) w52_pradchg_52w_ann
  , avg(sq.w26_pradchg_26w_ann) w26_pradchg_26w_ann
  , avg(sq.w13_pradchg_13w_ann) w13_pradchg_13w_ann
from
( select 
      to_timestamp(dateindex_ci*3600*24)::date start_date 
    , ticker_ci 
    , ( ( ( netinc_q1::numeric(15,2) + netinc_q2::numeric(15,2) + netinc_q3::numeric(15,2) + netinc_q4::numeric(15,2) ) / nullif(assets_q1::numeric(15,2),0.00) ) - 
      ( ( netinc_q5::numeric(15,2) + netinc_q6::numeric(15,2) + netinc_q7::numeric(15,2) + netinc_q8::numeric(15,2) ) / nullif(assets_q5::numeric(15,2),0.00) ) ) / 
        nullif( abs( ( nullif(assets_q5::numeric(15,2),0.00) + netinc_q6::numeric(15,2) + netinc_q7::numeric(15,2) + netinc_q8::numeric(15,2) ) / nullif(assets_q5::numeric(15,2),0.00) ), 0.00) * 100 > 0.00 pfs_alt_delta_return_on_assets_sig
    , w52_pradchg_52w_ann
    , w26_pradchg_26w_ann
    , w13_pradchg_13w_ann
  from sipro_data_store.si_finecon 
  where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq_ci is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
  -- and dateindex_ci in (16465,16555)
) sq group by cube(sq.start_date, pfs_alt_delta_return_on_assets_sig);
-- pfs_alt_delta_return_on_assets_sig ALONE 3
-- RECENTLY IN THE SHORT RUN:  WORSE -20,-10
-- OVER THE LONG RUN: ABSOLUTELY NO DIFFERENCE
-- 'f' 9.13
-- 't' 9.28

-- mktcap variant

select 
    sq.start_date
  , sq.pfs_alt_delta_return_on_mktcap_sig
  , avg(sq.w52_pradchg_52w_ann) w52_pradchg_52w_ann
  , avg(sq.w26_pradchg_26w_ann) w26_pradchg_26w_ann
  , avg(sq.w13_pradchg_13w_ann) w13_pradchg_13w_ann
from
( select 
      to_timestamp(dateindex_ci*3600*24)::date start_date 
    , ticker_ci 
    , ( ( ( netinc_q1::numeric(15,2) + netinc_q2::numeric(15,2) + netinc_q3::numeric(15,2) + netinc_q4::numeric(15,2) ) / nullif(mktcap_q1::numeric(15,2),0.00) ) - 
      ( ( netinc_q5::numeric(15,2) + netinc_q6::numeric(15,2) + netinc_q7::numeric(15,2) + netinc_q8::numeric(15,2) ) / nullif(mktcap_q5::numeric(15,2),0.00) ) ) / 
        nullif( abs( ( nullif(mktcap_q5::numeric(15,2),0.00) + netinc_q6::numeric(15,2) + netinc_q7::numeric(15,2) + netinc_q8::numeric(15,2) ) / nullif(mktcap_q5::numeric(15,2),0.00) ), 0.00) * 100 > 0.00 pfs_alt_delta_return_on_mktcap_sig
    , w52_pradchg_52w_ann
    , w26_pradchg_26w_ann
    , w13_pradchg_13w_ann
  from sipro_data_store.si_finecon 
  where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq_ci is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
  -- and dateindex_ci in (16465,16555)
) sq group by cube(sq.start_date, pfs_alt_delta_return_on_mktcap_sig);

-- RECENTLY IN THE SHORT RUN WORSE   -2,-3
-- OVER THE LONG RUN: ABSOLUTELY NO DIFFERENCE
-- 'f' 10.72
-- 't' 10.26



select 
    sq.start_date
  , sq.pfs_accural_sig
  , avg(sq.w52_pradchg_52w_ann) w52_pradchg_52w_ann
  , avg(sq.w26_pradchg_26w_ann) w26_pradchg_26w_ann
  , avg(sq.w13_pradchg_13w_ann) w13_pradchg_13w_ann
from
( select 
      to_timestamp(dateindex_ci*3600*24)::date start_date 
    , ticker_ci 
    , ( netinc_q1::numeric(15,2) - tco_q1::numeric(15,2) + netinc_q2::numeric(15,2) - tco_q2::numeric(15,2) + 
        netinc_q3::numeric(15,2) - tco_q3::numeric(15,2) + netinc_q4::numeric(15,2) - tco_q4::numeric(15,2) ) / nullif(assets_q5::numeric(15,2),0.00) > 0 pfs_accural_sig
    , w52_pradchg_52w_ann
    , w26_pradchg_26w_ann
    , w13_pradchg_13w_ann
  from sipro_data_store.si_finecon 
  where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq_ci is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
  -- and dateindex_ci in (16465,16555)
) sq group by cube(sq.start_date, pfs_accural_sig);
-- pfs_accural_sig ALONE 4
-- pfs_accural_sig = 't' LONG TERM  - NO DIFFERENCE
-- SHORT TERM - MUCH WORSEWORSE
-- LITTLE LONGER THAN SHORT TURM - SLIGHTLY WORSE
-- 'f' 9.02
-- 't' 8.32

-- mktcap variant

select 
    sq.start_date
  , sq.pfs_accural_sig_mktcap
  , avg(sq.w52_pradchg_52w_ann) w52_pradchg_52w_ann
  , avg(sq.w26_pradchg_26w_ann) w26_pradchg_26w_ann
  , avg(sq.w13_pradchg_13w_ann) w13_pradchg_13w_ann
from
( select 
      to_timestamp(dateindex_ci*3600*24)::date start_date 
    , ticker_ci 
    , ( netinc_q1::numeric(15,2) - tco_q1::numeric(15,2) + netinc_q2::numeric(15,2) - tco_q2::numeric(15,2) + 
        netinc_q3::numeric(15,2) - tco_q3::numeric(15,2) + netinc_q4::numeric(15,2) - tco_q4::numeric(15,2) ) / nullif(mktcap_q5::numeric(15,2),0.00) > 0 pfs_accural_sig_mktcap
    , w52_pradchg_52w_ann
    , w26_pradchg_26w_ann
    , w13_pradchg_13w_ann
  from sipro_data_store.si_finecon 
  where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq_ci is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
  -- and dateindex_ci in (16465,16555)
) sq group by cube(sq.start_date, pfs_accural_sig_mktcap);
-- 'f' 10.16
-- 't' 10.56

-- SEEMS: same as ABOVE


select 
    sq.start_date
  , sq.pfs_delta_lever_sig
  , avg(sq.w52_pradchg_52w_ann) w52_pradchg_52w_ann
  , avg(sq.w26_pradchg_26w_ann) w26_pradchg_26w_ann
  , avg(sq.w13_pradchg_13w_ann) w13_pradchg_13w_ann
from
( select 
      to_timestamp(dateindex_ci*3600*24)::date start_date 
    , ticker_ci 
    , (-1) * ( ( liab_q1::numeric(15,2) / nullif( ( assets_q1::numeric(15,2) +  assets_q2::numeric(15,2) +  assets_q3::numeric(15,2) +  assets_q4::numeric(15,2) ), 0.00) / 4 ) - 
         ( liab_q5::numeric(15,2) / nullif( ( assets_q5::numeric(15,2) +  assets_q6::numeric(15,2) +  assets_q7::numeric(15,2) +  assets_q8::numeric(15,2) ), 0.00) / 4 )  ) / 
            nullif( abs(  liab_q5::numeric(15,2) / nullif( ( assets_q5::numeric(15,2) +  assets_q6::numeric(15,2) +  assets_q7::numeric(15,2) +  assets_q8::numeric(15,2) ), 0.00) / 4 ), 0.00) * 100.00 > 0 pfs_delta_lever_sig
    , w52_pradchg_52w_ann
    , w26_pradchg_26w_ann
    , w13_pradchg_13w_ann
  from sipro_data_store.si_finecon 
  where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq_ci is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
  -- and dateindex_ci in (16465,16555)
) sq group by cube(sq.start_date, pfs_delta_lever_sig);
--pfs_delta_lever_sig ALONE 5
-- LONG TERM: NO DIFFERENCE
-- SHORT TERM: ABOUT THE SAME, -10 WORSE, ABOUT THE SAME
-- LONGER THAT SHORT TERM:LITTLE WORSE
-- FAR LONGER THAN 'LONGER THAT SHORT', AT 52 WEEKS, EXACTLY THE SAME 
-- WEIRD: IS THIS A RECESSION INDICATOR
-- 'f' 9.17
-- 't' 9.32

-- mktcap variant pfs_delta_lever_sig_mktcap

select 
    sq.start_date
  , sq.pfs_delta_lever_sig_mktcap
  , avg(sq.w52_pradchg_52w_ann) w52_pradchg_52w_ann
  , avg(sq.w26_pradchg_26w_ann) w26_pradchg_26w_ann
  , avg(sq.w13_pradchg_13w_ann) w13_pradchg_13w_ann
from
( select 
      to_timestamp(dateindex_ci*3600*24)::date start_date 
    , ticker_ci 
    , (-1) * ( ( liab_q1::numeric(15,2) / nullif( ( mktcap_q1::numeric(15,2) +  mktcap_q2::numeric(15,2) +  mktcap_q3::numeric(15,2) +  mktcap_q4::numeric(15,2) ), 0.00) / 4 ) - 
         ( liab_q5::numeric(15,2) / nullif( ( mktcap_q5::numeric(15,2) +  mktcap_q6::numeric(15,2) +  mktcap_q7::numeric(15,2) +  mktcap_q8::numeric(15,2) ), 0.00) / 4 )  ) / 
            nullif( abs(  liab_q5::numeric(15,2) / nullif( ( mktcap_q5::numeric(15,2) +  mktcap_q6::numeric(15,2) +  mktcap_q7::numeric(15,2) +  mktcap_q8::numeric(15,2) ), 0.00) / 4 ), 0.00) * 100.00 > 0 pfs_delta_lever_sig_mktcap
    , w52_pradchg_52w_ann
    , w26_pradchg_26w_ann
    , w13_pradchg_13w_ann
  from sipro_data_store.si_finecon 
  where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq_ci is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
  -- and dateindex_ci in (16465,16555)
) sq group by cube(sq.start_date, pfs_delta_lever_sig_mktcap);

-- LONG TERM: 3 PERCENT WORSE RETURN ( DIFFERENT THAN ASSETS: ABOVE )
-- SHORT TERM: 10-15 PERCENT WORSE
-- LONGER THAT SHORT TERM:LITTLE WORSE
-- FAR LONGER THAN 'LONGER THAT SHORT', AT 52 WEEKS, A LITTLE WORSE
-- 'f' 12.49
-- 't' 9.45 

-- mktcap variant pfs_delta_lever_sig_mktcap percentile ranks

select 
    sq.start_date
  , sq.pfs_delta_lever_sig_mktcap
  , avg(sq.w52_pradchg_52w_ann) w52_pradchg_52w_ann
  , avg(sq.w26_pradchg_26w_ann) w26_pradchg_26w_ann
  , avg(sq.w13_pradchg_13w_ann) w13_pradchg_13w_ann
from
( select 
      to_timestamp(dateindex_ci*3600*24)::date start_date 
    , ticker_ci 

    , percent_rank() over (partition by dateindex_ci order by ( 
      (-1) * ( ( liab_q1::numeric(15,2) / nullif( ( mktcap_q1::numeric(15,2) +  mktcap_q2::numeric(15,2) +  mktcap_q3::numeric(15,2) +  mktcap_q4::numeric(15,2) ), 0.00) / 4 ) - 
         ( liab_q5::numeric(15,2) / nullif( ( mktcap_q5::numeric(15,2) +  mktcap_q6::numeric(15,2) +  mktcap_q7::numeric(15,2) +  mktcap_q8::numeric(15,2) ), 0.00) / 4 )  ) / 
            nullif( abs(  liab_q5::numeric(15,2) / nullif( ( mktcap_q5::numeric(15,2) +  mktcap_q6::numeric(15,2) +  mktcap_q7::numeric(15,2) +  mktcap_q8::numeric(15,2) ), 0.00) / 4 ), 0.00) * 100.00  
      ) desc nulls last ) < 0.10 pfs_delta_lever_sig_mktcap
    , w52_pradchg_52w_ann
    , w26_pradchg_26w_ann
    , w13_pradchg_13w_ann
  from sipro_data_store.si_finecon 
  where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq_ci is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
  -- and dateindex_ci in (16465,16555)
) sq group by cube(sq.start_date, pfs_delta_lever_sig_mktcap);
-- 'f' 10.66
-- 't' 6.99

-- < 0.005 
-- 'f' 10.50
-- 't' 6.66

-- >= 0.85
-- 'f' 9.8 
-- 't' 0.12   *** QUITE LOW ***

-- pair test netinc/mktcap - netinc/assets ( NO - NO ADVANTAGE )

select 
    sq.start_date
  , sq.netinc_div_mktcap_less_netinc_div_assets
  , avg(sq.w52_pradchg_52w_ann) w52_pradchg_52w_ann
  , avg(sq.w26_pradchg_26w_ann) w26_pradchg_26w_ann
  , avg(sq.w13_pradchg_13w_ann) w13_pradchg_13w_ann
from
( select 
      to_timestamp(dateindex_ci*3600*24)::date start_date 
    , ticker_ci 
    , percent_rank() over (partition by dateindex_ci order by ( 
        ( netinc_q1::numeric(15,2) + netinc_q2::numeric(15,2) + netinc_q3::numeric(15,2) + netinc_q4::numeric(15,2) ) /  nullif(mktcap_q5::numeric(15,2),0.00) -
        ( netinc_q1::numeric(15,2) + netinc_q2::numeric(15,2) + netinc_q3::numeric(15,2) + netinc_q4::numeric(15,2) ) /  nullif(assets_q5::numeric(15,2),0.00)
      ) desc nulls last ) >= 0.95 netinc_div_mktcap_less_netinc_div_assets
    , w52_pradchg_52w_ann
    , w26_pradchg_26w_ann
    , w13_pradchg_13w_ann
  from sipro_data_store.si_finecon 
  where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq_ci is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
  -- and dateindex_ci in (16465,16555)
) sq group by cube(sq.start_date, netinc_div_mktcap_less_netinc_div_assets);
-- < 0.10
-- 't' 10.38
-- 'f'  7.37

-- < 0.01
-- 't' 10.55
-- 'f'  6.61

-- >= 0.90
-- 'f' 9.47
-- 't' 1.91

-- >= 0.90+ NOT ENOUGH CASES



-- pfs_delta_liquid_sig

select 
    sq.start_date
  , sq.pfs_delta_liquid_sig
  , avg(sq.w52_pradchg_52w_ann) w52_pradchg_52w_ann
  , avg(sq.w26_pradchg_26w_ann) w26_pradchg_26w_ann
  , avg(sq.w13_pradchg_13w_ann) w13_pradchg_13w_ann
from
( select 
      to_timestamp(dateindex_ci*3600*24)::date start_date 
    , ticker_ci 
    , ( ca_q1::numeric(15,2)/nullif( cl_q1::numeric(15,2) , 0.00) - ca_q5::numeric(15,2)/nullif( cl_q5::numeric(15,2) , 0.00) ) /  nullif( abs( ca_q5::numeric(15,2)/nullif( cl_q5::numeric(15,2), 0.00) ), 0.00) * 100 > 0 pfs_delta_liquid_sig
    , w52_pradchg_52w_ann
    , w26_pradchg_26w_ann
    , w13_pradchg_13w_ann
  from sipro_data_store.si_finecon 
  where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq_ci is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
  -- and dateindex_ci in (16465,16555)
) sq group by cube(sq.start_date, pfs_delta_liquid_sig);

-- pfs_delta_liquid_sig ALONE 6 

-- LONG TERM: 1 PERCENT WORSE RETURN
-- SHORT TERN: 10 PERCCENT WORSE RETURN
-- LONGER THAT SHORT TERM: 2 OR 3 PERCENT BETTER RETURN
-- LONGER THAN 'LONGER THAT SHORT TERM' ABOUT THE SAME
-- 'f' 7.9
-- 't' 8.8


-- VARIANT pfs_delta_liquid_sig WITH percentile ranks

select 
    sq.start_date
  , sq.pfs_delta_liquid_sig
  , avg(sq.w52_pradchg_52w_ann) w52_pradchg_52w_ann
  , avg(sq.w26_pradchg_26w_ann) w26_pradchg_26w_ann
  , avg(sq.w13_pradchg_13w_ann) w13_pradchg_13w_ann
from
( select 
      to_timestamp(dateindex_ci*3600*24)::date start_date 
    , ticker_ci 
    , percent_rank() over (partition by dateindex_ci order by ( 
      ( ca_q1::numeric(15,2)/nullif( cl_q1::numeric(15,2) , 0.00) - ca_q5::numeric(15,2)/nullif( cl_q5::numeric(15,2) , 0.00) ) /  nullif( abs( ca_q5::numeric(15,2)/nullif( cl_q5::numeric(15,2), 0.00) ), 0.00) * 100  
      ) desc nulls last ) < 0.10 pfs_delta_liquid_sig
    , w52_pradchg_52w_ann
    , w26_pradchg_26w_ann
    , w13_pradchg_13w_ann
  from sipro_data_store.si_finecon 
  where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq_ci is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
  -- and dateindex_ci in (16465,16555)
) sq group by cube(sq.start_date, pfs_delta_liquid_sig);
-- 'f' 9.37
-- 't' 6.70

-- ANDRE TRY: VARIANT OF ABOVE: sq_net_curr_over_mktcap

select rs.* from (
  select 
      sq.start_date
    , coalesce(sq.pfs_eq_offer_sig12::text,'cNONE') sq_net_curr_over_mktcap12 
    , coalesce(sq.pfs_eq_offer_sig23::text,'cNONE') sq_net_curr_over_mktcap23 
    , coalesce(sq.pfs_eq_offer_sig34::text,'cNONE') sq_net_curr_over_mktcap34 
    , coalesce(sq.pfs_eq_offer_sig45::text,'cNONE') sq_net_curr_over_mktcap45 
    , count(sq.w52_pradchg_52w_ann) w52_ann_ct
    , avg(sq.w52_pradchg_52w_ann) w52_pradchg_52w_ann
    , count(sq.w26_pradchg_26w_ann) w26_ann_ct
    , avg(sq.w26_pradchg_26w_ann) w26_pradchg_26w_ann
    , count(sq.w13_pradchg_13w_ann) w13_ann_ct
    , avg(sq.w13_pradchg_13w_ann) w13_pradchg_13w_ann
  from
  ( select 
        to_timestamp(dateindex_ci*3600*24)::date start_date 
      , ticker_ci 
      , (coalesce(ca_q1::numeric(15,2), 0.00) - coalesce(cl_q1::numeric(15,2), 0.00))   * nullif(shr_aq1::numeric(15,2), 0.00) / nullif(mktcap_q1::numeric(15,2), 0.00) < 
          (coalesce(ca_q2::numeric(15,2), 0.00) - coalesce(cl_q2::numeric(15,2), 0.00)) * nullif(shr_aq2::numeric(15,2), 0.00) / nullif(mktcap_q2::numeric(15,2), 0.00) pfs_eq_offer_sig12  
      , (coalesce(ca_q2::numeric(15,2), 0.00) - coalesce(cl_q2::numeric(15,2), 0.00))   * nullif(shr_aq2::numeric(15,2), 0.00) / nullif(mktcap_q2::numeric(15,2), 0.00) < 
          (coalesce(ca_q3::numeric(15,2), 0.00) - coalesce(cl_q3::numeric(15,2), 0.00)) * nullif(shr_aq3::numeric(15,2), 0.00) / nullif(mktcap_q3::numeric(15,2), 0.00) pfs_eq_offer_sig23  
      , (coalesce(ca_q3::numeric(15,2), 0.00) - coalesce(cl_q3::numeric(15,2), 0.00))   * nullif(shr_aq3::numeric(15,2), 0.00) / nullif(mktcap_q3::numeric(15,2), 0.00) < 
          (coalesce(ca_q4::numeric(15,2), 0.00) - coalesce(cl_q4::numeric(15,2), 0.00)) * nullif(shr_aq4::numeric(15,2), 0.00) / nullif(mktcap_q4::numeric(15,2), 0.00) pfs_eq_offer_sig34 
      , (coalesce(ca_q4::numeric(15,2), 0.00) - coalesce(cl_q4::numeric(15,2), 0.00))   * nullif(shr_aq4::numeric(15,2), 0.00) / nullif(mktcap_q4::numeric(15,2), 0.00) < 
          (coalesce(ca_q5::numeric(15,2), 0.00) - coalesce(cl_q5::numeric(15,2), 0.00)) * nullif(shr_aq5::numeric(15,2), 0.00) / nullif(mktcap_q5::numeric(15,2), 0.00) pfs_eq_offer_sig45 
      , w52_pradchg_52w_ann
      , w26_pradchg_26w_ann
      , w13_pradchg_13w_ann
    from sipro_data_store.si_finecon 
    where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq_ci is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
    -- and dateindex_ci in (16465,16555)
  ) sq group by cube(sq.start_date, sq_net_curr_over_mktcap12, sq_net_curr_over_mktcap23, sq_net_curr_over_mktcap34, sq_net_curr_over_mktcap45)
) rs 
  where start_date is null
--order by rs.w52_pradchg_52w_ann nulls first;
order by rs.sq_net_curr_over_mktcap12 nulls first, rs.sq_net_curr_over_mktcap23 nulls first, rs.sq_net_curr_over_mktcap34 nulls first, rs.sq_net_curr_over_mktcap45 nulls first;
-- JUST RANDOMNESS



-- pfs_eq_offer_sig

-- SO A COMPANY THAT IS IN THE BUSINESS OF 'BUYING BACK SHARES' IN THE PAST 
-- IS LIKE GIVING INVESTORS 'CASH IN THE BANK' IN THE FUTURE

select 
    sq.start_date
  , sq.pfs_eq_offer_sig
  , avg(sq.w52_pradchg_52w_ann) w52_pradchg_52w_ann
  , avg(sq.w26_pradchg_26w_ann) w26_pradchg_26w_ann
  , avg(sq.w13_pradchg_13w_ann) w13_pradchg_13w_ann
from
( select 
      to_timestamp(dateindex_ci*3600*24)::date start_date 
    , ticker_ci 
    -- LONG TERM: 4.25 PERCENT BETTER RETURN ( 100 >= 0 )
    -- buy accident I discovered bought back ANY stock, such that the result is a lesser number, then a better return
    , (-1) * ( shr_aq1::numeric(15,2) - shr_aq5::numeric(15,2) ) / nullif( abs( shr_aq5::numeric(15,2) ), 0.00) * 100 > 0  pfs_eq_offer_sig
    , w52_pradchg_52w_ann
    , w26_pradchg_26w_ann
    , w13_pradchg_13w_ann
  from sipro_data_store.si_finecon 
  where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq_ci is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
  -- and dateindex_ci in (16465,16555)
) sq group by cube(sq.start_date, pfs_eq_offer_sig);

-- pfs_eq_offer_sig ALONE 7 # USING AAII (NEW ARTICLE) MORE LIBERAL DEFINITION # NOT_ISSUE_NEW_SHARES # BETTER_NET_SHARES_DID_NOT_INCREASE
-- LONG TERM: 4.25 PERCENT BETTER RETURN  ( 100 >= 0 )
-- SHORT TERM: 5-10 PERCENT LESS GOOD RETURN
-- LONGER THAN SHORT TERM: 3-4 PERCENT BETTER RETURN
-- LONGER THAN 'LONGER THAT SHORT TERM' 4-5 PERCENT BETTER RETURN
-- SUPRISING

-- LONG TERM:5.5 PERCENT BETTER RETURN  ( 100 > 0 )
-- SHORT TERM: 10 PERCENT BETTER RETURN
-- LONGER THAN SHORT TERM: 4  PERCENT BETTER RETURN
-- LONGER THAN 'LONGER THAT SHORT TERM' 2-3 PERCENT BETTER RETURN
-- 'f' 7.56 
-- 't' 13.18 PERCENT

-- ANDRE SPECIAL VARIANT pfs_eq_offer_sig ( 4 quarters ) ( ** SEEMS TO BE A POWERFUL PATTERN HERE ** )

select rs.* from (
  select 
      sq.start_date
    , coalesce(sq.pfs_eq_offer_sig12::text,'cNONE') sq_pfs_eq_offer_sig12 
    , coalesce(sq.pfs_eq_offer_sig23::text,'cNONE') sq_pfs_eq_offer_sig23 
    , coalesce(sq.pfs_eq_offer_sig34::text,'cNONE') sq_pfs_eq_offer_sig34 
    , coalesce(sq.pfs_eq_offer_sig45::text,'cNONE') sq_pfs_eq_offer_sig45 
    , count(sq.w52_pradchg_52w_ann) w52_ann_ct
    , avg(sq.w52_pradchg_52w_ann) w52_pradchg_52w_ann
    , count(sq.w26_pradchg_26w_ann) w26_ann_ct
    , avg(sq.w26_pradchg_26w_ann) w26_pradchg_26w_ann
    , count(sq.w13_pradchg_13w_ann) w13_ann_ct
    , avg(sq.w13_pradchg_13w_ann) w13_pradchg_13w_ann
  from
  ( select 
        to_timestamp(dateindex_ci*3600*24)::date start_date 
      , ticker_ci 
      , shr_aq1::numeric(15,2) < shr_aq2::numeric(15,2)  pfs_eq_offer_sig12
      , shr_aq2::numeric(15,2) < shr_aq3::numeric(15,2)  pfs_eq_offer_sig23
      , shr_aq3::numeric(15,2) < shr_aq4::numeric(15,2)  pfs_eq_offer_sig34
      , shr_aq3::numeric(15,2) < shr_aq5::numeric(15,2)  pfs_eq_offer_sig45  -- MISTAKE:  shr_aq3::numeric(15,2)
      , w52_pradchg_52w_ann
      , w26_pradchg_26w_ann
      , w13_pradchg_13w_ann
    from sipro_data_store.si_finecon 
    where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq_ci is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
    -- and dateindex_ci in (16465,16555)
  ) sq group by cube(sq.start_date, sq_pfs_eq_offer_sig12, sq_pfs_eq_offer_sig23, sq_pfs_eq_offer_sig34, sq_pfs_eq_offer_sig45)
) rs 
  where start_date is null
--order by rs.w52_pradchg_52w_ann nulls first;
order by rs.sq_pfs_eq_offer_sig12 nulls first, rs.sq_pfs_eq_offer_sig23 nulls first, rs.sq_pfs_eq_offer_sig34 nulls first, rs.sq_pfs_eq_offer_sig45 nulls first;

 start_date | sq_pfs_eq_offer_sig12 | sq_pfs_eq_offer_sig23 | sq_pfs_eq_offer_sig34 | sq_pfs_eq_offer_sig45 | w52_ann_ct |     w52_pradchg_52w_ann     | w26_ann_ct |     w26_pradchg_26w_ann     | w13_ann_ct |     w13_pradchg_13w_ann
------------+-----------------------+-----------------------+-----------------------+-----------------------+------------+-----------------------------+------------+-----------------------------+------------+-----------------------------

            | true                  | true                  |                       |                       |      28709 | 12.830336878988847227449780 |      33091 | 11.254427877148963723999136 |      35582 | 12.490655263627457350178982
            | true                  | true                  |                       | cNONE                 |         28 |     -5.85850102155982276811 |         28 |      4.60408954644984511879 |         28 |     41.53778148111376814571
            | true                  | true                  |                       | false                 |      10868 |     10.64506713503051440952 |      12224 |  8.846046583213333141439133 |      13086 | 10.687038941480400072840995
            | true                  | true                  |                       | true                  |      17813 | 14.192982084094922780426415 |      20839 | 12.676101777543835049982121 |      22468 | 13.504933510802407271354427
            | true                  | true                  | cNONE                 |                       |          6 |     -4.24618701463520775317 |          6 |     -8.26082087704058688767 |          6 |     75.59070091475246987200
            | true                  | true                  | cNONE                 | cNONE                 |          6 |     -4.24618701463520775317 |          6 |     -8.26082087704058688767 |          6 |     75.59070091475246987200
            | true                  | true                  | false                 |                       |       8787 |     10.98780622078437416019 |       9938 |  9.906130501302462482451999 |      10694 | 12.780260344005410661738630
            | true                  | true                  | false                 | cNONE                 |         11 |    -18.19969614334624484636 |         11 |    -13.90578921248441284691 |         11 |      2.56071499851729606400
            | true                  | true                  | false                 | false                 |       5801 |      9.71684137479604808154 |       6543 |  7.938895488151178847013292 |       6990 | 11.140382619076384755179529
            | true                  | true                  | false                 | true                  |       2975 |     13.57400104350158975392 |       3384 |     13.78720313957093306617 |       3693 |     15.91461189993670238863
            | true                  | true                  | true                  |                       |      19916 | 13.648411594644824791813202 |      23147 | 11.838368379749199894654747 |      24882 | 12.350970471268781086657166
            | true                  | true                  | true                  | cNONE                 |         11 |      5.60325009644953657473 |         11 |     30.13119217274252054255 |         11 |     61.94052827263458474036
            | true                  | true                  | true                  | false                 |       5067 |     11.70775464936249372047 |       5681 |      9.89084320616557316053 |       6096 | 10.167210807229098739253994
            | true                  | true                  | true                  | true                  |      14838 | 14.317086990131124812630795 |      17455 | 12.460692610594554059619675 |      18775 | 13.030955226324487065329815

-- >,>,>.> ( BUT * DOES 'NOT' WORK, WHILE TRYING TO FIND THE WORST COMPANIES )

 start_date | sq_pfs_eq_offer_sig12 | sq_pfs_eq_offer_sig23 | sq_pfs_eq_offer_sig34 | sq_pfs_eq_offer_sig45 | w52_ann_ct |     w52_pradchg_52w_ann     | w26_ann_ct |     w26_pradchg_26w_ann     | w13_ann_ct |     w13_pradchg_13w_ann
------------+-----------------------+-----------------------+-----------------------+-----------------------+------------+-----------------------------+------------+-----------------------------+------------+-----------------------------
            | true                  | true                  |                       |                       |      86476 |  8.112887733825832110523291 |      98330 |  7.503345059969199240919813 |     104034 |  8.969139461605567440034058
            | true                  | true                  |                       | cNONE                 |        254 |      0.60109919567497326598 |        272 |     -4.27994530130770605972 |        288 |     -5.40465415927178125917
            | true                  | true                  |                       | false                 |      12056 |     10.97667681493394112465 |      14012 |      9.76009086561773179290 |      14775 |  9.745078775453072626318723
            | true                  | true                  |                       | true                  |      74166 |  7.673092586815759514888778 |      84046 |  7.165238936531082972726522 |      88971 |  8.886810941084451428052782
            | true                  | true                  | cNONE                 |                       |        104 |     -3.84043295349720280764 |        110 |     -9.36503068495987911196 |        123 |    -13.17392835818462911385
            | true                  | true                  | cNONE                 | cNONE                 |         99 |     -4.11691946630009183833 |        105 |    -11.96374643186273049825 |        118 |    -13.37350159370092695766
            | true                  | true                  | cNONE                 | true                  |          5 |          1.6340000000000000 |          5 |         45.2080000000000000 |          5 |         -8.4640000000000000
            | true                  | true                  | false                 |                       |      15015 |      9.69850974634626858560 |      17225 |      9.37947807797519371670 |      18112 |  9.309071279606147008771209
            | true                  | true                  | false                 | cNONE                 |         54 |      6.74951736183807440806 |         62 |      8.63966351854440439568 |         65 |      5.15800069746545903034
            | true                  | true                  | false                 | false                 |       8869 |     10.76103002342716794292 |      10358 |      9.87447420457245199551 |      10891 |  9.630812433167197690109487
            | true                  | true                  | false                 | true                  |       6092 |      8.17778637985463137048 |       6805 |      8.63277692050132269334 |       7156 |  8.857106031479503876873912
            | true                  | true                  | true                  |                       |      71357 |  7.796661306614587831170664 |      80995 |  7.127261722686514430419251 |      85799 |  8.929124452738420935146599
            | true                  | true                  | true                  | cNONE                 |        101 |      1.93841866659303251009 |        105 |     -4.22486556914154684248 |        105 |     -2.98797385856017579627
            | true                  | true                  | true                  | false                 |       3187 |     11.57679334893882702010 |       3654 |      9.43584822060049264167 |       3884 | 10.065489366038928427105228
            | true                  | true                  | true                  | true                  |      68069 |  7.628367394374872642058383 |      77236 |  7.033476419230409376425543 |      81810 |  8.890469691699760399246722





select 
    sq.start_date
  , sq.pfs_delta_margin_sig
  , avg(sq.w52_pradchg_52w_ann) w52_pradchg_52w_ann
  , avg(sq.w26_pradchg_26w_ann) w26_pradchg_26w_ann
  , avg(sq.w13_pradchg_13w_ann) w13_pradchg_13w_ann
from
( select 
      to_timestamp(dateindex_ci*3600*24)::date start_date 
    , ticker_ci 
    , (-1) * ( ( cgs_q1::numeric(15,2) +  cgs_q2::numeric(15,2) +  cgs_q3::numeric(15,2) +  cgs_q4::numeric(15,2) ) / nullif( ( sales_q1::numeric(15,2) +  sales_q2::numeric(15,2) +  sales_q3::numeric(15,2) +  sales_q4::numeric(15,2) ), 0.00) - ( cgs_q5::numeric(15,2) + cgs_q6::numeric(15,2) +  cgs_q7::numeric(15,2) +  cgs_q8::numeric(15,2) ) / nullif( ( sales_q5::numeric(15,2) +  sales_q6::numeric(15,2) +  sales_q7::numeric(15,2) +  sales_q8::numeric(15,2) ), 0.00) ) /
                   nullif( abs( ( cgs_q1::numeric(15,2) +  cgs_q2::numeric(15,2) +  cgs_q3::numeric(15,2) +  cgs_q4::numeric(15,2))/ nullif( ( sales_q1::numeric(15,2) + sales_q2::numeric(15,2) +  sales_q3::numeric(15,2) +  sales_q4::numeric(15,2)), 0.00) ), 0.00 ) * 100 > 0 pfs_delta_margin_sig                    
    , w52_pradchg_52w_ann
    , w26_pradchg_26w_ann
    , w13_pradchg_13w_ann
  from sipro_data_store.si_finecon 
  where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq_ci is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
  -- and dateindex_ci in (16465,16555)
) sq group by cube(sq.start_date, pfs_delta_margin_sig);
--
-- pfs_delta_margin_sig ALONE 8
-- LONG TERM: -1 PERCENT BETTER RETURN 
-- SHORT TERM:  -10 PERCENT 
-- LONGER THAN SHORT TERM: ABOUT SAME PERCENT 
-- LONGER THAN 'LONGER THAT SHORT TERM' 2-3 PERCENT
-- 'f' 9.80
-- 't' 8.52


select 
    sq.start_date
  , sq.pfs_alt_delta_turn_sig
  , avg(sq.w52_pradchg_52w_ann) w52_pradchg_52w_ann
  , avg(sq.w26_pradchg_26w_ann) w26_pradchg_26w_ann
  , avg(sq.w13_pradchg_13w_ann) w13_pradchg_13w_ann
from
( select 
      to_timestamp(dateindex_ci*3600*24)::date start_date 
    , ticker_ci 
    , ( (  sales_q1::numeric(15,2) +  sales_q2::numeric(15,2) +  sales_q3::numeric(15,2) +  sales_q4::numeric(15,2) ) / nullif(assets_q1::numeric(15,2), 0.00) - (  sales_q5::numeric(15,2) +  sales_q6::numeric(15,2) +  sales_q7::numeric(15,2) +  sales_q8::numeric(15,2) ) / nullif(assets_q5::numeric(15,2), 0.00) ) / nullif( abs( (  sales_q5::numeric(15,2) + sales_q6::numeric(15,2) +  sales_q7::numeric(15,2) +  sales_q8::numeric(15,2) ) / nullif(assets_q5::numeric(15,2), 0.00) ), 0.00) * 100 > 0 pfs_alt_delta_turn_sig               
    , w52_pradchg_52w_ann
    , w26_pradchg_26w_ann
    , w13_pradchg_13w_ann
  from sipro_data_store.si_finecon 
  where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq_ci is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
  -- and dateindex_ci in (16465,16555)
) sq group by cube(sq.start_date, pfs_alt_delta_turn_sig);

-- pfs_alt_delta_turn_sig ALONE 9
--
-- LONG TERM: -1 PERCENT BETTER RETURN 
-- SHORT TERM: 0 or 1  PERCENT 
-- LONGER THAN SHORT TERM: 0 PERCENT 
-- LONGER THAN 'LONGER THAT SHORT TERM' 1, 2 PERCENT 2011:-2 PERCENT
-- 'f' 10.02
-- 't'  9.09

-- mktcap variation

select 
    sq.start_date
  , sq.pfs_alt_delta_turn_sig
  , avg(sq.w52_pradchg_52w_ann) w52_pradchg_52w_ann
  , avg(sq.w26_pradchg_26w_ann) w26_pradchg_26w_ann
  , avg(sq.w13_pradchg_13w_ann) w13_pradchg_13w_ann
from
( select 
      to_timestamp(dateindex_ci*3600*24)::date start_date 
    , ticker_ci 
    , ( (  sales_q1::numeric(15,2) +  sales_q2::numeric(15,2) +  sales_q3::numeric(15,2) +  sales_q4::numeric(15,2) ) / nullif(mktcap_q1::numeric(15,2), 0.00) - (  sales_q5::numeric(15,2) +  sales_q6::numeric(15,2) +  sales_q7::numeric(15,2) +  sales_q8::numeric(15,2) ) / nullif(mktcap_q5::numeric(15,2), 0.00) ) / nullif( abs( (  sales_q5::numeric(15,2) + sales_q6::numeric(15,2) +  sales_q7::numeric(15,2) +  sales_q8::numeric(15,2) ) / nullif(mktcap_q5::numeric(15,2), 0.00) ), 0.00) * 100 > 0 pfs_alt_delta_turn_sig               
    , w52_pradchg_52w_ann
    , w26_pradchg_26w_ann
    , w13_pradchg_13w_ann
  from sipro_data_store.si_finecon 
  where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq_ci is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
  -- and dateindex_ci in (16465,16555)
) sq group by cube(sq.start_date, pfs_alt_delta_turn_sig);
-- pfs_alt_delta_turn_sig_mktcap ALONE 9
-- LONG TERM: -3 PERCENT BETTER RETURN ( 26W:-5, 13W:-4 ) 
-- SHORT TERM: +10 PERCENT               ( WIERD ) 
-- LONGER THAN SHORT TERM: -10 PERCENT 
-- LONGER THAN 'LONGER THAT SHORT TERM' -3 PERCENT
-- 'f' 11.97
-- 't' 9.044

--------------------------------------------------------------
                   -- millenial values --

select 
    sq.start_date
  , sq.mill_inv_earn_quality_best_10
  , avg(sq.w52_pradchg_52w_ann) w52_pradchg_52w_ann
  , avg(sq.w26_pradchg_26w_ann) w26_pradchg_26w_ann
  , avg(sq.w13_pradchg_13w_ann) w13_pradchg_13w_ann
from
( select 
      to_timestamp(dateindex_ci*3600*24)::date start_date 
    , ticker_ci 
    , percent_rank() over (partition by dateindex_ci order by ( 
        (    tco_q1::numeric(15,2)  +    tco_q2::numeric(15,2)  +    tco_q3::numeric(15,2) +    tco_q4::numeric(15,2) - 
          netinc_q1::numeric(15,2)  - netinc_q2::numeric(15,2)  - netinc_q3::numeric(15,2) - netinc_q4::numeric(15,2)    )/ 
          nullif(mktcap::numeric(15,2),0.00::numeric(15,2)) 
      ) desc nulls last ) < 0.10 mill_inv_earn_quality_best_10     
    , w52_pradchg_52w_ann
    , w26_pradchg_26w_ann
    , w13_pradchg_13w_ann
  from sipro_data_store.si_finecon 
  where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq_ci is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
  -- and dateindex_ci in (16465,16555)
) sq group by cube(sq.start_date,mill_inv_earn_quality_best_10);

-- mill_inv_earn_quality_best_10
-- LONG TERM: 
-- 'f' 9.5
-- 't' 5.23
-- SHORT TERM: +40 PERCENT               
-- LONGER THAN SHORT TERM: -20 PERCENT 
-- LONGER THAN 'LONGER THAT SHORT TERM' -20 PERCENT ( similary to part of  my R program )

-- >= 0.90
-- 'f' 9.43
-- 't' 3.49


--strange: missing
--finance_econ=# select cash_q1::numeric(15,2) from sipro_data_store.si_finecon limit 20;
--ERROR:  column "cash_q1" does not exist ( RE-ADDED FIXED): cash_q1 )

select 
    sq.start_date
  , sq.mill_inv_ret_inv_cap_best_10
  , avg(sq.w52_pradchg_52w_ann) w52_pradchg_52w_ann
  , avg(sq.w26_pradchg_26w_ann) w26_pradchg_26w_ann
  , avg(sq.w13_pradchg_13w_ann) w13_pradchg_13w_ann
from
( select 
      to_timestamp(dateindex_ci*3600*24)::date start_date 
    , ticker_ci 
    , percent_rank() over (partition by dateindex_ci order by ( 
        ( epsdc_q1::numeric(15,2) + epsdc_q2::numeric(15,2)  + epsdc_q3::numeric(15,2) + epsdc_q4::numeric(15,2) ) * shr_aq1::numeric(15,2) / 
            nullif( equity_q1::numeric(15,2) + liab_q1::numeric(15,2) - coalesce(cash_q1::numeric(15,2),0.00), 0.00)  
      ) desc nulls last ) < 0.10 mill_inv_ret_inv_cap_best_10  
    , w52_pradchg_52w_ann
    , w26_pradchg_26w_ann
    , w13_pradchg_13w_ann
  from sipro_data_store.si_finecon 
  where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq_ci is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
  -- and dateindex_ci in (16465,16555)
) sq group by cube(sq.start_date, mill_inv_ret_inv_cap_best_10);
-- mill_inv_ret_inv_cap_best_10  ( LEFT_OFF: WRONG: NEXT RE-RUN WITH cash_q1 )
-- LONG TERM: 
-- 'f' 9.09
-- 't' 9.21 ( NO DIFFERENCE )
-- SHORTEST TERM -18 PERCENT
-- SHORT TERM: +18  PERCENT               
-- LONGER THAN SHORT TERM: SAME PERCENT 
-- LONGER THAN 'LONGER THAT SHORT TERM' SAME PERCENT 


select 
    sq.start_date
  , sq.mill_inv_sharehold_orient_best_10
  , avg(sq.w52_pradchg_52w_ann) w52_pradchg_52w_ann
  , avg(sq.w26_pradchg_26w_ann) w26_pradchg_26w_ann
  , avg(sq.w13_pradchg_13w_ann) w13_pradchg_13w_ann
from
( select 
      to_timestamp(dateindex_ci*3600*24)::date start_date 
    , ticker_ci 
    , percent_rank() over (partition by dateindex_ci order by ( 
        (-1) * ( tcf_q1::numeric(15,2) + tcf_q2::numeric(15,2)  + tcf_q3::numeric(15,2) + tcf_q4::numeric(15,2) )  / 
            nullif( mktcap::numeric(15,2), 0.00)  
      ) desc nulls last ) < 0.10 mill_inv_sharehold_orient_best_10  
    , w52_pradchg_52w_ann
    , w26_pradchg_26w_ann
    , w13_pradchg_13w_ann
  from sipro_data_store.si_finecon 
  where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq_ci is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
  -- and dateindex_ci in (16465,16555)
) sq group by cube(sq.start_date, mill_inv_sharehold_orient_best_10);
-- mill_inv_sharehold_orient_best_10
-- LONG TERM: 1.5 PERCENT BETTER ; NOTE: instead of mktcap USE mktcap_q1: f: 10.31  t: 7.45 ( -3 PERCENT BETTER )
-- 'f' 8.95
-- 't' 10.45
-- SHORTEST TERM +20 PERCENT
-- SHORT TERM: -3  PERCENT               
-- LONGER THAN SHORT TERM: -2,-3 PERCENT 
-- LONGER THAN 'LONGER THAT SHORT TERM' 2,-3 PERCENT 

select 
    sq.start_date
  , sq.mill_inv_aaii_free_cash_plus_divs_over_price_best_10
  , avg(sq.w52_pradchg_52w_ann) w52_pradchg_52w_ann
  , avg(sq.w26_pradchg_26w_ann) w26_pradchg_26w_ann
  , avg(sq.w13_pradchg_13w_ann) w13_pradchg_13w_ann
from
( select 
      to_timestamp(dateindex_ci*3600*24)::date start_date 
    , ticker_ci 
    , percent_rank() over (partition by dateindex_ci order by ( 
        ( coalesce(fcfps_q1::numeric(15,2), 0.00) + coalesce(fcfps_q2::numeric(15,2), 0.00)  + 
          coalesce(fcfps_q3::numeric(15,2), 0.00) + coalesce(fcfps_q4::numeric(15,2),0.00)  + 
          coalesce(dps_q1::numeric(15,2), 0.00) + coalesce(dps_q2::numeric(15,2), 0.00) + 
          coalesce(dps_q3::numeric(15,2), 0.00) + coalesce(dps_q4::numeric(15,2), 0.00) )  / 
            nullif( price::numeric(15,2), 0.00)  
      ) desc nulls last ) < 0.10 mill_inv_aaii_free_cash_plus_divs_over_price_best_10  
    , w52_pradchg_52w_ann
    , w26_pradchg_26w_ann
    , w13_pradchg_13w_ann
  from sipro_data_store.si_finecon 
  where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq_ci is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
  -- and dateindex_ci in (16465,16555)
) sq group by cube(sq.start_date, mill_inv_aaii_free_cash_plus_divs_over_price_best_10);

-- mill_inv_aaii_free_cash_plus_divs_over_price_best_10
-- LONG TERM:   PERCENT BETTER 
-- 'f' 8.85
-- 't' 11.36
-- SHORTEST TERM +4 PERCENT
-- SHORT TERM:  +4  PERCENT               
-- LONGER THAN SHORT TERM:  +2 PERCENT 
-- LONGER THAN 'LONGER THAT SHORT TERM' +5  PERCENT 



--Price Change 4 week, 13 week, 26 week, 52 week
--Data Table Name: PRCHG_04W, 13W, 26W, 52W
--Data Category: Price and Share Statistics

explain
-- LEFT_OFF: RERUN:  WHY DO SLOW AFTER ADD_COLUMN/UPDATES?

select 
    sq.start_date
  , sq.mill_inv_price_pct_chge_since_26w_best_10
  , avg(sq.w52_pradchg_52w_ann) w52_pradchg_52w_ann
  , avg(sq.w26_pradchg_26w_ann) w26_pradchg_26w_ann
  , avg(sq.w13_pradchg_13w_ann) w13_pradchg_13w_ann
from
( select 
      to_timestamp(dateindex_ci*3600*24)::date start_date 
    , ticker_ci 
    , percent_rank() over (partition by dateindex_ci order by ( 
        coalesce(prchg_26w::numeric(15,2), 0.00) 
      ) desc nulls last ) < 0.10 mill_inv_price_pct_chge_since_26w_best_10  
    , w52_pradchg_52w_ann
    , w26_pradchg_26w_ann
    , w13_pradchg_13w_ann
  from sipro_data_store.si_finecon 
  where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq_ci is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
  -- and dateindex_ci in (16465,16555)
) sq group by cube(sq.start_date, mill_inv_price_pct_chge_since_26w_best_10);

-- mill_inv_price_pct_chge_since_26w_best_10
-- LONG TERM: ZERO PERCENT BETTER 
-- 'f' 9.07 
-- 't' 9.34 
-- SHORTEST TERM -20  PERCENT
-- SHORT TERM:  -15 PERCENT               
-- LONGER THAN SHORT TERM:    PERCENT 
-- LONGER THAN 'LONGER THAT SHORT TERM' 5 PERCENT 

-- TWO ITEMS

select * from (
select 
    sq.start_date
  , sq.mill_inv_price_pct_chge_since_13w_best_10
  , sq.mill_inv_price_pct_chge_since_26w_best_10
  , sq.mill_inv_price_pct_chge_since_52w_best_10
  , count(sq.w52_pradchg_52w_ann) w13_ann_ct
  , avg(sq.w52_pradchg_52w_ann) w52_pradchg_52w_ann
  , count(sq.w26_pradchg_26w_ann) w26_ann_ct
  , avg(sq.w26_pradchg_26w_ann) w26_pradchg_26w_ann
  , count(sq.w13_pradchg_13w_ann) w13_ann_ct
  , avg(sq.w13_pradchg_13w_ann) w13_pradchg_13w_ann
from
( select 
      to_timestamp(dateindex*3600*24)::date start_date 
    , ticker 
    , percent_rank() over (partition by dateindex order by ( 
        coalesce(prchg_52w::numeric(15,2), 0.00) 
      ) desc nulls last ) < 0.005 mill_inv_price_pct_chge_since_52w_best_10  
    , percent_rank() over (partition by dateindex order by ( 
        coalesce(prchg_26w::numeric(15,2), 0.00) 
      ) desc nulls last ) < 0.005 mill_inv_price_pct_chge_since_26w_best_10  
    , percent_rank() over (partition by dateindex order by ( 
        coalesce(prchg_13w::numeric(15,2), 0.00) 
      ) desc nulls last ) < 0.005 mill_inv_price_pct_chge_since_13w_best_10
    , w52_pradchg_52w_ann
    , w26_pradchg_26w_ann
    , w13_pradchg_13w_ann
  from sipro_data_store.si_finecon 
  where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
  -- and dateindex_ci in (16465,16555)
) sq group by cube(sq.start_date, sq.mill_inv_price_pct_chge_since_13w_best_10, mill_inv_price_pct_chge_since_26w_best_10, mill_inv_price_pct_chge_since_52w_best_10)
) rq where rq.start_date is null
order by rq.mill_inv_price_pct_chge_since_13w_best_10 nulls first, rq.mill_inv_price_pct_chge_since_26w_best_10 nulls first, rq.mill_inv_price_pct_chge_since_52w_best_10 nulls first;

--  13  26
-- LONG TERM: ZERO( 0.5 % worse that average ) PERCENT BETTER 
-- 'f'  'f'  9.03
-- 't'  't'  8.69

-- < 0.005 
-- WHATEVER GOES UP MUST COME DOWN - OR - RANDOM-ISH


-- SEE FAR BELOW
-- mill_earnings_quality == cash_f_ops_less_ni_over_market

---------------------------------------------------------
---------- andre experiments ---------------------------

select 
    sq.start_date
  , sq.non_operating_interest_over_assets
  , avg(sq.w52_pradchg_52w_ann) w52_pradchg_52w_ann
  , avg(sq.w26_pradchg_26w_ann) w26_pradchg_26w_ann
  , avg(sq.w13_pradchg_13w_ann) w13_pradchg_13w_ann
from
( select 
      to_timestamp(dateindex_ci*3600*24)::date start_date 
    , ticker_ci 
    , percent_rank() over (partition by dateindex_ci order by ( 
       (-1) * ( coalesce(intno_q1::numeric(15,2), 0.00)  + coalesce(intno_q2::numeric(15,2), 0.00) + coalesce(intno_q3::numeric(15,2), 0.00) + coalesce(intno_q4::numeric(15,2), 0.00) ) /
            nullif( assets_q1::numeric(15,2), 0.00)
      ) desc nulls last ) < 0.10 non_operating_interest_over_assets  
    , w52_pradchg_52w_ann
    , w26_pradchg_26w_ann
    , w13_pradchg_13w_ann
  from sipro_data_store.si_finecon 
  where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq_ci is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
  -- and dateindex_ci in (16465,16555)
) sq group by cube(sq.start_date, non_operating_interest_over_assets);
-- non_operating_interest_over_assets
-- LONG TERM:   PERCENT BETTER 
-- 'f' 8.6
-- 't' 9.6
-- SHORTEST TERM   PERCENT
-- SHORT TERM:     PERCENT               
-- LONGER THAN SHORT TERM:    PERCENT 
-- LONGER THAN 'LONGER THAT SHORT TERM'    PERCENT 

select 
    sq.start_date
  , sq.accounts_payable_over_assets
  , avg(sq.w52_pradchg_52w_ann) w52_pradchg_52w_ann
  , avg(sq.w26_pradchg_26w_ann) w26_pradchg_26w_ann
  , avg(sq.w13_pradchg_13w_ann) w13_pradchg_13w_ann
from
( select 
      to_timestamp(dateindex_ci*3600*24)::date start_date 
    , ticker_ci 
    , percent_rank() over (partition by dateindex_ci order by ( 
       (-1) * ( coalesce(ap_q1::numeric(15,2), 0.00)  + coalesce(ap_q2::numeric(15,2), 0.00) + coalesce(ap_q3::numeric(15,2), 0.00) + coalesce(ap_q4::numeric(15,2), 0.00) ) /
            nullif( assets_q1::numeric(15,2), 0.00)
      ) desc nulls last ) < 0.10 accounts_payable_over_assets  
    , w52_pradchg_52w_ann
    , w26_pradchg_26w_ann
    , w13_pradchg_13w_ann
  from sipro_data_store.si_finecon 
  where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq_ci is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
  -- and dateindex_ci in (16465,16555)
) sq group by cube(sq.start_date, accounts_payable_over_assets);
-- LONG TERM:   PERCENT BETTER 
-- 'f'  9.10
-- 't' 10.48 
-- SHORTEST TERM   PERCENT
-- SHORT TERM:     PERCENT               
-- LONGER THAN SHORT TERM:    PERCENT 
-- LONGER THAN 'LONGER THAT SHORT TERM'    PERCENT



----------- PUT IN R CODE [ ] -------------------
-- AFTER 'ADD COLUMS/UPDATE' RUN THIS
-- REQUIRED


set search_path to sipro_data_store,sipro_stage;
set time zone 'utc';
set work_mem to '1200MB';
set constraint_exclusion = on;

CREATE TABLE sipro_data_store.si_finecon_new
AS
select * from  sipro_data_store.si_finecon
order by dateindex_ci,adr,exchange,mktcap::numeric(15,2),company_id_unq_ci;
-- 07:49 minutes ( CREATE TABLE AS because 'CLUSTER ON does not work THAT well )

ALTER TABLE sipro_data_store.si_finecon RENAME TO si_finecon_old;

  -- DROP TABLE sipro_data_store.si_finecon_old;

ALTER TABLE sipro_data_store.si_finecon_new RENAME TO si_finecon;

DROP INDEX IF EXISTS sipro_data_store.si_finecon_cluster_idx;

CREATE INDEX si_finecon_cluster_idx
  ON sipro_data_store.si_finecon(dateindex_ci,adr,exchange);
-- 02:45

ALTER TABLE sipro_data_store.si_finecon CLUSTER ON si_finecon_cluster_idx;
-- 01:15 ( 0:00 if physically done by 'order by dateindex_ci,adr,exchang' )

DROP INDEX IF EXISTS sipro_data_store.si_finecon_dateindex_ci_brin_idx;

CREATE INDEX si_finecon_dateindex_ci_brin_idx
  ON sipro_data_store.si_finecon
  USING brin
  (dateindex_ci);  -- 1:36 ( 0:21 if physically done by 'order by dateindex_ci,adr,exchang' )

DROP INDEX IF EXISTS sipro_data_store.si_finecon_jamesos_partial_idx;

CREATE INDEX si_finecon_jamesos_partial_idx ON sipro_data_store.si_finecon(adr,exchange,mktcap,company_id_unq_ci,company) 
  where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq_ci is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%']);
  -- 1:17 ( 0:28 if physically done by 'order by dateindex_ci,adr,exchang' )

-- QUERIES 'ABOVE' ONLY TAKE '14 SECONDS NOW'

-- NOTE: explain analyze MAY MAKE run FASTER

finance_econ=# explain
finance_econ-# select
finance_econ-#     sq.start_date
finance_econ-#   , sq.growing_netinc_4q_q
finance_econ-#   -- , count(sq.w52_pradchg_52w_ann) the_count -- DOES WORK ( 't' 1 PERCENT OF CASES )
finance_econ-#   , avg(sq.w52_pradchg_52w_ann) w52_pradchg_52w_ann
finance_econ-#   , avg(sq.w26_pradchg_26w_ann) w26_pradchg_26w_ann
finance_econ-#   , avg(sq.w13_pradchg_13w_ann) w13_pradchg_13w_ann
finance_econ-# from
finance_econ-# ( select
finance_econ(#       to_timestamp(dateindex_ci*3600*24)::date start_date
finance_econ(#     , ticker_ci
finance_econ(#     , netinc_q1::numeric(15,2)/nullif(assets_q1::numeric(15,2),0.00) > netinc_q2::numeric(15,2)/nullif(assets_q2::numeric(15,2),0.00) and
finance_econ(#       netinc_q2::numeric(15,2)/nullif(assets_q2::numeric(15,2),0.00) > netinc_q3::numeric(15,2)/nullif(assets_q3::numeric(15,2),0.00) and
finance_econ(#       netinc_q3::numeric(15,2)/nullif(assets_q3::numeric(15,2),0.00) > netinc_q4::numeric(15,2)/nullif(assets_q4::numeric(15,2),0.00) and
finance_econ(#       netinc_q4::numeric(15,2)/nullif(assets_q4::numeric(15,2),0.00) > netinc_q5::numeric(15,2)/nullif(assets_q5::numeric(15,2),0.00) growing_netinc_4q_q
finance_econ(#     , w52_pradchg_52w_ann
finance_econ(#     , w26_pradchg_26w_ann
finance_econ(#     , w13_pradchg_13w_ann
finance_econ(#   from sipro_data_store.si_finecon
finance_econ(#   where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq_ci is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
finance_econ(#   -- and dateindex_ci in (16465,16555)
finance_econ(# ) sq group by cube(sq.start_date, growing_netinc_4q_q);

                                                                                                                                                                                        QUERY PLAN
-- BAD NEWS: BRIN never used
-- Bitmap Index Scan on si_finecon_jamesos_partial_idx ( only index used )

---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
---------------------------------------------------------------------------------------------------------------------------
 GroupAggregate  (cost=214029.13..226338.82 rows=44 width=74)
   Group Key: ((to_timestamp((((si_finecon.dateindex_ci * 3600) * 24))::double precision))::date), (((((si_finecon.netinc_q1)::numeric(15,2) / NULLIF((si_finecon.assets_q1)::numeric(15,2), 0.00)) > ((si_finecon.netinc_q2)::numeric(15,2) / NULLIF((si_finec
on.assets_q2)::numeric(15,2), 0.00))) AND (((si_finecon.netinc_q2)::numeric(15,2) / NULLIF((si_finecon.assets_q2)::numeric(15,2), 0.00)) > ((si_finecon.netinc_q3)::numeric(15,2) / NULLIF((si_finecon.assets_q3)::numeric(15,2), 0.00))) AND (((si_finecon.net
inc_q3)::numeric(15,2) / NULLIF((si_finecon.assets_q3)::numeric(15,2), 0.00)) > ((si_finecon.netinc_q4)::numeric(15,2) / NULLIF((si_finecon.assets_q4)::numeric(15,2), 0.00))) AND (((si_finecon.netinc_q4)::numeric(15,2) / NULLIF((si_finecon.assets_q4)::num
eric(15,2), 0.00)) > ((si_finecon.netinc_q5)::numeric(15,2) / NULLIF((si_finecon.assets_q5)::numeric(15,2), 0.00)))))
   Group Key: ((to_timestamp((((si_finecon.dateindex_ci * 3600) * 24))::double precision))::date)
   Group Key: ()
   Sort Key: (((((si_finecon.netinc_q1)::numeric(15,2) / NULLIF((si_finecon.assets_q1)::numeric(15,2), 0.00)) > ((si_finecon.netinc_q2)::numeric(15,2) / NULLIF((si_finecon.assets_q2)::numeric(15,2), 0.00))) AND (((si_finecon.netinc_q2)::numeric(15,2) / NU
LLIF((si_finecon.assets_q2)::numeric(15,2), 0.00)) > ((si_finecon.netinc_q3)::numeric(15,2) / NULLIF((si_finecon.assets_q3)::numeric(15,2), 0.00))) AND (((si_finecon.netinc_q3)::numeric(15,2) / NULLIF((si_finecon.assets_q3)::numeric(15,2), 0.00)) > ((si_f
inecon.netinc_q4)::numeric(15,2) / NULLIF((si_finecon.assets_q4)::numeric(15,2), 0.00))) AND (((si_finecon.netinc_q4)::numeric(15,2) / NULLIF((si_finecon.assets_q4)::numeric(15,2), 0.00)) > ((si_finecon.netinc_q5)::numeric(15,2) / NULLIF((si_finecon.asset
s_q5)::numeric(15,2), 0.00)))))
     Group Key: (((((si_finecon.netinc_q1)::numeric(15,2) / NULLIF((si_finecon.assets_q1)::numeric(15,2), 0.00)) > ((si_finecon.netinc_q2)::numeric(15,2) / NULLIF((si_finecon.assets_q2)::numeric(15,2), 0.00))) AND (((si_finecon.netinc_q2)::numeric(15,2) /
 NULLIF((si_finecon.assets_q2)::numeric(15,2), 0.00)) > ((si_finecon.netinc_q3)::numeric(15,2) / NULLIF((si_finecon.assets_q3)::numeric(15,2), 0.00))) AND (((si_finecon.netinc_q3)::numeric(15,2) / NULLIF((si_finecon.assets_q3)::numeric(15,2), 0.00)) > ((s
i_finecon.netinc_q4)::numeric(15,2) / NULLIF((si_finecon.assets_q4)::numeric(15,2), 0.00))) AND (((si_finecon.netinc_q4)::numeric(15,2) / NULLIF((si_finecon.assets_q4)::numeric(15,2), 0.00)) > ((si_finecon.netinc_q5)::numeric(15,2) / NULLIF((si_finecon.as
sets_q5)::numeric(15,2), 0.00)))))
   ->  Sort  (cost=214029.13..214305.32 rows=110474 width=74)
         Sort Key: ((to_timestamp((((si_finecon.dateindex_ci * 3600) * 24))::double precision))::date), (((((si_finecon.netinc_q1)::numeric(15,2) / NULLIF((si_finecon.assets_q1)::numeric(15,2), 0.00)) > ((si_finecon.netinc_q2)::numeric(15,2) / NULLIF((si_
finecon.assets_q2)::numeric(15,2), 0.00))) AND (((si_finecon.netinc_q2)::numeric(15,2) / NULLIF((si_finecon.assets_q2)::numeric(15,2), 0.00)) > ((si_finecon.netinc_q3)::numeric(15,2) / NULLIF((si_finecon.assets_q3)::numeric(15,2), 0.00))) AND (((si_fineco
n.netinc_q3)::numeric(15,2) / NULLIF((si_finecon.assets_q3)::numeric(15,2), 0.00)) > ((si_finecon.netinc_q4)::numeric(15,2) / NULLIF((si_finecon.assets_q4)::numeric(15,2), 0.00))) AND (((si_finecon.netinc_q4)::numeric(15,2) / NULLIF((si_finecon.assets_q4)
::numeric(15,2), 0.00)) > ((si_finecon.netinc_q5)::numeric(15,2) / NULLIF((si_finecon.assets_q5)::numeric(15,2), 0.00)))))
         ->  Bitmap Heap Scan on si_finecon  (cost=4103.36..204775.09 rows=110474 width=74)
               Recheck Cond: ((company_id_unq_ci IS NOT NULL) AND (exchange <> 'O'::text) AND ((mktcap)::numeric(15,2) >= 200.00) AND (company !~~ ANY ('{%iShares%,%Vanguard%,SPDR,%PowerShares%,%Fund%}'::text[])))
               Filter: (NOT adr)
               ->  Bitmap Index Scan on si_finecon_jamesos_partial_idx  (cost=0.00..4075.74 rows=102332 width=0)
                     Index Cond: ((adr = false) AND (company_id_unq_ci IS NOT NULL))
(13 rows)


finance_econ=#


----------------------------------------------------------
----------------------------------------------------------


--------------- capital expenditures ---------------

-- assume less spending on capital expenditures is good

select 
    sq.start_date
  , sq.ce_over_mktcap
  , avg(sq.w52_pradchg_52w_ann) w52_pradchg_52w_ann
  , avg(sq.w26_pradchg_26w_ann) w26_pradchg_26w_ann
  , avg(sq.w13_pradchg_13w_ann) w13_pradchg_13w_ann
from
( select 
      to_timestamp(dateindex_ci*3600*24)::date start_date 
    , ticker_ci 
    , percent_rank() over (partition by dateindex_ci order by ( 
        ( ce_q1::numeric(15,2) + ce_q2::numeric(15,2)  + ce_q3::numeric(15,2) + ce_q4::numeric(15,2) )  / 
            nullif( mktcap::numeric(15,2), 0.00)  
      ) desc nulls last ) < 0.10 ce_over_mktcap  
    , w52_pradchg_52w_ann
    , w26_pradchg_26w_ann
    , w13_pradchg_13w_ann
  from sipro_data_store.si_finecon 
  where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq_ci is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
  -- and dateindex_ci in (16465,16555)
) sq group by cube(sq.start_date, ce_over_mktcap);
-- ce_over_mktcap
-- LONG TERM: -8.5 PERCENT BETTER 
-- 'f' 9.97
-- 't' 1.5
-- SHORTEST TERM  +60  PERCENT
-- SHORT TERM: +17  PERCENT               
-- LONGER THAN SHORT TERM: -10   PERCENT 
-- LONGER THAN 'LONGER THAT SHORT TERM'  -15  PERCENT 



select 
    sq.start_date
  , sq.ce_over_assets
  , avg(sq.w52_pradchg_52w_ann) w52_pradchg_52w_ann
  , avg(sq.w26_pradchg_26w_ann) w26_pradchg_26w_ann
  , avg(sq.w13_pradchg_13w_ann) w13_pradchg_13w_ann
from
( select 
      to_timestamp(dateindex_ci*3600*24)::date start_date 
    , ticker_ci 
    , percent_rank() over (partition by dateindex_ci order by ( 
        ( ce_q1::numeric(15,2) + ce_q2::numeric(15,2)  + ce_q3::numeric(15,2) + ce_q4::numeric(15,2) )  / 
            nullif( assets_q1::numeric(15,2), 0.00)  
      ) desc nulls last ) < 0.01 ce_over_assets  
    , w52_pradchg_52w_ann
    , w26_pradchg_26w_ann
    , w13_pradchg_13w_ann
  from sipro_data_store.si_finecon 
  where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq_ci is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
  -- and dateindex_ci in (16465,16555)
) sq group by cube(sq.start_date, ce_over_assets);
-- LONG TERM:  PERCENT BETTER 
-- 'f' 10.34
-- 't' -1.68
-- SHORTEST TERM +15  PERCENT
-- SHORT TERM: -2   PERCENT               
-- LONGER THAN SHORT TERM: -20 PERCENT 
-- LONGER THAN 'LONGER THAT SHORT TERM' -8 PERCENT 
--  < 0.10
-- 'f' 10.34
-- 't' -1.6

-- < 0.01 ( DOES NOT GET WORSE )
-- 'f'   9.20
-- 't'  -0.01



-- OTHER SIDE
-- ce_over_assets_opposite ( and unweighted )

select 
    sq.start_date
  , sq.ce_over_assets_opposite
  , avg(sq.w52_pradchg_52w_ann) w52_pradchg_52w_ann
  , avg(sq.w26_pradchg_26w_ann) w26_pradchg_26w_ann
  , avg(sq.w13_pradchg_13w_ann) w13_pradchg_13w_ann
from
( select 
      to_timestamp(dateindex_ci*3600*24)::date start_date 
    , ticker_ci 
    , percent_rank() over (partition by dateindex_ci order by ( 
        (-1) * ( ce_q1::numeric(15,2) + ce_q2::numeric(15,2)  + ce_q3::numeric(15,2) + ce_q4::numeric(15,2) )  / 
            nullif( assets_q1::numeric(15,2), 0.00)  
      ) desc nulls last ) >= 0.99 ce_over_assets_opposite  
    , w52_pradchg_52w_ann
    , w26_pradchg_26w_ann
    , w13_pradchg_13w_ann
  from sipro_data_store.si_finecon 
  where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq_ci is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
  -- and dateindex_ci in (16465,16555)
) sq group by cube(sq.start_date, ce_over_assets_opposite);

-- < 0.10
-- 'f' 9.21
-- 't' 8.08

--  < 0.01
-- 't' 9.16
-- 'f' 8.36 (  LITTLE WORSE: LOWEST SPENDER ON CAPITAL EXPENDITURES )

-- >= 0.90
-- 'f'  9.79
-- 't' -2.54  

--  >= 0.99 # BUT RARER TRUER CASES 
-- 'f'   9.11 
-- 't' -11.31 



-- ce_over_price_opposite_div_share_weighted ( per share weighted )

select 
    sq.start_date
  , sq.ce_over_price_opposite_div_share_weighted
  , count(sq.w52_pradchg_52w_ann) w52_ann_ct
  , avg(sq.w52_pradchg_52w_ann) w52_pradchg_52w_ann
  , stddev_pop(sq.w52_pradchg_52w_ann) w52_ann_sd
  , count(sq.w26_pradchg_26w_ann) w26_ann_ct
  , avg(sq.w26_pradchg_26w_ann) w26_pradchg_26w_ann
  , stddev_pop(sq.w26_pradchg_26w_ann) w26_ann_sd
  , count(sq.w13_pradchg_13w_ann) w13_ann_ct
  , avg(sq.w13_pradchg_13w_ann) w13_pradchg_13w_ann
  , stddev_pop(sq.w13_pradchg_13w_ann) w13_ann_sd
from
( select 
      to_timestamp(dateindex_ci*3600*24)::date start_date 
    , ticker_ci 
    , percent_rank() over (partition by dateindex_ci order by ( 
        (-1) * ( 
         coalesce(ce_q1::numeric(15,2), 0.00) / nullif(shr_aq1::numeric(15,2),0.00) +  
         coalesce(ce_q2::numeric(15,2), 0.00) / nullif(shr_aq2::numeric(15,2),0.00) + 
         coalesce(ce_q3::numeric(15,2), 0.00) / nullif(shr_aq3::numeric(15,2),0.00) + 
         coalesce(ce_q4::numeric(15,2), 0.00) / nullif(shr_aq4::numeric(15,2),0.00)   )  / 
            nullif( price::numeric(15,2), 0.00)  
      ) desc nulls last ) >= 0.99 ce_over_price_opposite_div_share_weighted  
    , w52_pradchg_52w_ann
    , w26_pradchg_26w_ann
    , w13_pradchg_13w_ann
  from sipro_data_store.si_finecon 
  where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq_ci is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
  -- and dateindex_ci in (16465,16555)
) sq group by cube(sq.start_date, ce_over_price_opposite_div_share_weighted);

-- same as above ( non _ci version )
-- ce_over_price_opposite_div_share_weighted ( per share weighted )

select 
    sq.start_date
  , sq.ce_over_price_opposite_div_share_weighted
  , count(sq.w52_pradchg_52w_ann) w52_ann_ct
  , avg(sq.w52_pradchg_52w_ann) w52_pradchg_52w_ann
  , stddev_pop(sq.w52_pradchg_52w_ann) w52_ann_sd
  , count(sq.w26_pradchg_26w_ann) w26_ann_ct
  , avg(sq.w26_pradchg_26w_ann) w26_pradchg_26w_ann
  , stddev_pop(sq.w26_pradchg_26w_ann) w26_ann_sd
  , count(sq.w13_pradchg_13w_ann) w13_ann_ct
  , avg(sq.w13_pradchg_13w_ann) w13_pradchg_13w_ann
  , stddev_pop(sq.w13_pradchg_13w_ann) w13_ann_sd
from
( select 
      to_timestamp(dateindex*3600*24)::date start_date 
    , ticker 
    , percent_rank() over (partition by dateindex order by ( 
        (-1) * ( 
         coalesce(ce_q1::numeric(15,2), 0.00) / nullif(shr_aq1::numeric(15,2),0.00) +  
         coalesce(ce_q2::numeric(15,2), 0.00) / nullif(shr_aq2::numeric(15,2),0.00) + 
         coalesce(ce_q3::numeric(15,2), 0.00) / nullif(shr_aq3::numeric(15,2),0.00) + 
         coalesce(ce_q4::numeric(15,2), 0.00) / nullif(shr_aq4::numeric(15,2),0.00)   )  / 
            nullif( price::numeric(15,2), 0.00)  
      ) desc nulls last ) >= 0.99 ce_over_price_opposite_div_share_weighted  
    , w52_pradchg_52w_ann
    , w26_pradchg_26w_ann
    , w13_pradchg_13w_ann
  from sipro_data_store.si_finecon 
  where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
  -- and dateindex in (16465,16555)
) sq group by cube(sq.start_date, ce_over_price_opposite_div_share_weighted);


-- END OF APRIL DATA
-- < 0.10
-- 'f' 9.19
-- 't' 8.24

-- < 0.01
-- 'f' 9.17
-- 't' 8.35

--  >= 0.90
-- 'f'  10.31
-- 't'  -3.87  ( HIGEST SPENDING CAPITAL EXPENDITURE COMPANIES )

  -- >= 0.98
  -- 'f' 9.35
  -- 't' -12.05

--  >= 0.99
-- 'f'  9.19
-- 't' -19.33 (*** ONE TAILED BIGGEST LOOSER ***)

-- 13W
-- 't' -15.66 sd: 123.91 (*** 13W VOLITILITY WNNER USEFULL ***) - 881 CASES
-- 26W
-- 't' -25.29 st:73 *** OPTIMIAL 26 WEEK TO HOLD ***



-- find the 'worst companies that match all of these criteria
--
-- worst companies, have the 'lowest value number'
--
-- note: this 30 seconds, this is 'relatively too slow'
-- "QUERY PLAN: "Filter: ((NOT adr) AND (dateindex = 17011))"

  select 
      to_timestamp(dateindex*3600*24)::date start_date 
    , ticker 
    , company
    ,   (-1) * ( 
         coalesce(ce_q1::numeric(15,2), 0.00) / nullif(shr_aq1::numeric(15,2),0.00) +  
         coalesce(ce_q2::numeric(15,2), 0.00) / nullif(shr_aq2::numeric(15,2),0.00) + 
         coalesce(ce_q3::numeric(15,2), 0.00) / nullif(shr_aq3::numeric(15,2),0.00) + 
         coalesce(ce_q4::numeric(15,2), 0.00) / nullif(shr_aq4::numeric(15,2),0.00)   )  / 
            nullif( price::numeric(15,2), 0.00)  ce_over_price_opposite_div_share_weighted  
  from sipro_data_store.si_finecon 
  where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
  and dateindex in (17011)
  order by ce_over_price_opposite_div_share_weighted desc nulls last

-- clearest loosers
-- "start_date","ticker","company","ce_over_price_opposite_div_share_weighted"
-- "2016-07-29","SALT","Scorpio Bulkers Inc",-11.7640867302384640
-- "2016-07-29","FRO","Frontline Ltd",-21.27073351742698212575

-- > getSymbols("FRO")
-- [1] "FRO"
-- > tail(FRO,30)
-- FRO.Close ( 8.25 )

-- NOTE: today is august 28,
--   BE BETTER to check this sept 1+ ( eom data is better )
--
-- FRO_o <- flipsideR::getOptionChain("FRO")
-- FRO_o$strike_min_premium <-  FRO_o$strike - FRO_o$premium
-- head( FRO_o[FRO_o$type == "Put" & substr(FRO_o$expiry,1,7) == "2016-11",][rev(order(FRO_o[FRO_o$type == "Put" & substr(FRO_o$expiry,1,7) == "2016-11",]$premium)),],50)


--    symbol type     expiry strike premium   bid   ask volume open.interest           retrieved strike_min_premium
-- 64    FRO  Put 2016-11-18     16      NA  8.10  9.30     NA             0 2016-08-28 19:07:25                 NA
-- 62    FRO  Put 2016-11-18     14      NA  4.80  8.50     NA             0 2016-08-28 19:07:25                 NA
-- 61    FRO  Put 2016-11-18     13      NA  5.30  5.80     NA             0 2016-08-28 19:07:25                 NA
-- 59    FRO  Put 2016-11-18     11      NA  2.10  5.50     NA             0 2016-08-28 19:07:25                 NA
-- 66    FRO  Put 2016-11-18     18   10.20 10.10 11.40     NA            25 2016-08-28 19:07:25               7.80
-- 65    FRO  Put 2016-11-18     17    9.20  9.10 10.30     NA            25 2016-08-28 19:07:25               7.80
-- 63    FRO  Put 2016-11-18     15    7.90  7.00  7.90     NA            55 2016-08-28 19:07:25               7.10
-- 60    FRO  Put 2016-11-18     12    5.30  4.10  5.70     NA            12 2016-08-28 19:07:25               6.70
-- 58    FRO  Put 2016-11-18     10    2.71  2.35  3.00     NA            43 2016-08-28 19:07:25               7.29
-- 57    FRO  Put 2016-11-18      9    1.83  1.60  2.05     NA           509 2016-08-28 19:07:25               7.17
-- 56    FRO  Put 2016-11-18      8    1.15  1.10  1.30     15          1287 2016-08-28 19:07:25               6.85
-- 55    FRO  Put 2016-11-18      7    0.69  0.60  0.70     52          1624 2016-08-28 19:07:25               6.31
-- 53    FRO  Put 2016-11-18      5    0.46  0.05  0.30     NA            66 2016-08-28 19:07:25               4.54
-- 54    FRO  Put 2016-11-18      6    0.41  0.25  0.45     NA           214 2016-08-28 19:07:25               5.59
-- 52    FRO  Put 2016-11-18      4    0.20  0.05  0.20     NA            97 2016-08-28 19:07:25               3.80
-- 51    FRO  Put 2016-11-18      3    0.10    NA  0.15     NA           100 2016-08-28 19:07:25               2.90
-- 50    FRO  Put 2016-11-18      2    0.10    NA  0.05     NA           155 2016-08-28 19:07:25               1.90
-- 49    FRO  Put 2016-11-18      1    0.05    NA  0.05     NA             1 2016-08-28 19:07:25               0.95
-- need more work: need probability bell curves and 'percent premium of '



-- ce_over_price_opposite_div_share_weighted_2q ( per share weighted )
-- ( 2 QUARTERS AS GOOD AD 4 QUARTERS )
-- ( AT THE 'WORST PERFORMANCE' END, 4 QUARTERS IS STILL A SLIGHTLY BETTER PREDICTOR THAN 2 QUARTERS )

select 
    sq.start_date
  , sq.ce_over_price_opposite_div_share_weighted_2q
  , count(sq.w52_pradchg_52w_ann) w52_ann_ct
  , avg(sq.w52_pradchg_52w_ann) w52_pradchg_52w_ann
  , stddev_pop(sq.w52_pradchg_52w_ann) w52_ann_sd
  , count(sq.w26_pradchg_26w_ann) w26_ann_ct
  , avg(sq.w26_pradchg_26w_ann) w26_pradchg_26w_ann
  , stddev_pop(sq.w26_pradchg_26w_ann) w26_ann_sd
  , count(sq.w13_pradchg_13w_ann) w13_ann_ct
  , avg(sq.w13_pradchg_13w_ann) w13_pradchg_13w_ann
  , stddev_pop(sq.w13_pradchg_13w_ann) w13_ann_sd
  , count(1) w0_ann_ct
from
( select 
      to_timestamp(dateindex_ci*3600*24)::date start_date 
    , ticker_ci 
    , percent_rank() over (partition by dateindex_ci order by ( 
        (-1) * ( 
         coalesce(ce_q1::numeric(15,2), 0.00) / nullif(shr_aq1::numeric(15,2),0.00) +  
         coalesce(ce_q2::numeric(15,2), 0.00) / nullif(shr_aq2::numeric(15,2),0.00)  
                                                                                       )  / 
            nullif( price::numeric(15,2), 0.00)  
      ) desc nulls last ) >= 0.99 ce_over_price_opposite_div_share_weighted_2q  
    , w52_pradchg_52w_ann
    , w26_pradchg_26w_ann
    , w13_pradchg_13w_ann
  from sipro_data_store.si_finecon 
  where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq_ci is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
  -- and dateindex_ci in (16465,16555)
) sq group by cube(sq.start_date, ce_over_price_opposite_div_share_weighted_2q);

-- < 0.10
-- 'f' 9.22
-- 't' 8.08

-- < 0.01
-- 'f' 9.15
-- 't' 8.54

--  >= 0.90
-- 'f'  10.33
-- 't'  -4.02

--  >= 0.99 ( 925 cases )
-- 'f'   9.25
-- 't' -18.58
-- 13W
-- 't' -14:45 sd: 118 *** 13W VOLITILITY HIGH USEFULL - 1263 CASES





-- ce_over_price_opposite_div_share_weighted_momentum ( per share weighted )

select 
    sq.start_date
  , sq.ce_over_price_opposite_div_share_weighted_momentum
  , count(sq.w52_pradchg_52w_ann) w52_ann_ct
  , avg(sq.w52_pradchg_52w_ann) w52_pradchg_52w_ann
  -- , ( 0.0 - avg(sq.w52_pradchg_52w_ann) ) / nullif(stddev_pop(sq.w52_pradchg_52w_ann),0.00) sharpe_short_52w
  -- , ( 0.0 - avg(sq.w52_pradchg_52w_ann) ) / nullif(stddev_pop(case when  sq.w52_pradchg_52w_ann < 0.00 then NULL else sq.w52_pradchg_52w_ann end ), 0.00) sortino_short_52w
  -- , ( 0.0 - avg(sq.w52_pradchg_52w_ann) ) / nullif(stddev_pop(case when  sq.w52_pradchg_52w_ann < 0.00 then 0.00 else sq.w52_pradchg_52w_ann end ), 0.00) sortino_true_short_52w
  , stddev_pop(sq.w52_pradchg_52w_ann) w52_ann_sd
  , count(sq.w26_pradchg_26w_ann) w26_ann_ct
  , avg(sq.w26_pradchg_26w_ann) w26_pradchg_26w_ann
  , stddev_pop(sq.w26_pradchg_26w_ann) w26_ann_sd
  , count(sq.w13_pradchg_13w_ann) w13_ann_ct
  , avg(sq.w13_pradchg_13w_ann) w13_pradchg_13w_ann
  , stddev_pop(sq.w13_pradchg_13w_ann) w13_ann_sd
  , count(1) w0_ann_ct
from
( select 
      to_timestamp(dateindex_ci*3600*24)::date start_date 
    , ticker_ci 
    , percent_rank() over (partition by dateindex_ci order by ( 
        (-1) * ( 
         coalesce(ce_q1::numeric(15,2), 0.00) / nullif(shr_aq1::numeric(15,2),0.00) +  
         coalesce(ce_q2::numeric(15,2), 0.00) / nullif(shr_aq2::numeric(15,2),0.00) + 
         coalesce(ce_q3::numeric(15,2), 0.00) / nullif(shr_aq3::numeric(15,2),0.00) + 
         coalesce(ce_q4::numeric(15,2), 0.00) / nullif(shr_aq4::numeric(15,2),0.00)   )  / 
            nullif( price::numeric(15,2), 0.00)  
      ) desc nulls last ) >= 0.99  -- so more companies to choose from
      and tcf_q1::numeric(15,2) > 0.00  and  tcf_q2::numeric(15,2) > 0.00
      and liab_q1::numeric(15,2)  < liab_q2::numeric(15,2) 
      and intno_q1::numeric(15,2) > intno_q2::numeric(15,2)
                                                  ce_over_price_opposite_div_share_weighted_momentum  
    , w52_pradchg_52w_ann
    , w26_pradchg_26w_ann
    , w13_pradchg_13w_ann
  from sipro_data_store.si_finecon 
  where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq_ci is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
  -- and dateindex_ci in (16465,16555)
) sq group by cube(sq.start_date, ce_over_price_opposite_div_share_weighted_momentum);

--  >= 0.99 and tcf_q1::numeric(15,2) > 0.00 and tcf_q2::numeric(15,2) > 0.00
-- 'f' 9.15
-- 't' -33.45


--  >= 0.99  and 
-- tcf_q1::numeric(15,2) > 0.00  and tcf_q2::numeric(15,2) > 0.00  and 
-- liab_q1::numeric(15,2) < liab_q2::numeric(15,2) 
-- 13 WEEK ** GREATEST LOOSER ** ( 69 CASES )
-- 'f'   9.38
-- 't' -57.00

-- >= 0.99  
--    and tcf_q1::numeric(15,2) > 0.00  and  tcf_q2::numeric(15,2) > 0.00
--    and liab_q1::numeric(15,2)  < liab_q2::numeric(15,2) 
--    and intno_q1::numeric(15,2) > intno_q2::numeric(15,2)
-- 13 WEEK ** GREATEST LOOSER ** ( 36 CASES )
-- 'f'   9.38
-- 't' -91.0
-- 26 WEEK ** GREATEST LOOSER ** ( 30 CASES )
-- 'f' 7.99
-- 't' -78.06


----------------------------------------
------------ BEGIN OTHERS --------------

select 
    sq.ce_fcf_over_price
  , sq.something
  , count(sq.w52_pradchg_52w_ann) w52_ann_ct
  , avg(sq.w52_pradchg_52w_ann) w52_pradchg_52w_ann
  , stddev_pop(sq.w52_pradchg_52w_ann) w52_ann_sd
  , count(sq.w26_pradchg_26w_ann) w26_ann_ct
  , avg(sq.w26_pradchg_26w_ann) w26_pradchg_26w_ann
  , stddev_pop(sq.w26_pradchg_26w_ann) w26_ann_sd
  , count(sq.w13_pradchg_13w_ann) w13_ann_ct
  , avg(sq.w13_pradchg_13w_ann) w13_pradchg_13w_ann
  , stddev_pop(sq.w13_pradchg_13w_ann) w13_ann_sd
  , count(1) w0_ann_ct
from
( select 
      to_timestamp(dateindex_ci*3600*24)::date start_date 
    , ticker_ci 
    , percent_rank() over (partition by dateindex_ci order by ( 
        (-1) * ( 
         coalesce(ce_q1::numeric(15,2), 0.00) / nullif(shr_aq1::numeric(15,2),0.00) +  
         coalesce(ce_q2::numeric(15,2), 0.00) / nullif(shr_aq2::numeric(15,2),0.00) + 
         coalesce(ce_q3::numeric(15,2), 0.00) / nullif(shr_aq3::numeric(15,2),0.00) + 
         coalesce(ce_q4::numeric(15,2), 0.00) / nullif(shr_aq4::numeric(15,2),0.00)   )  / 
            nullif( price::numeric(15,2), 0.00)  
      ) desc nulls last ) >= 0.99  
     and
      percent_rank() over (partition by dateindex_ci order by ( 
       (-1) *  ( 
        coalesce(tcf_q1::numeric(15,2), 0.00) * shr_aq1::numeric(15,2)  + coalesce(tcf_q2::numeric(15,2), 0.00) * shr_aq2::numeric(15,2)  +
        coalesce(tcf_q3::numeric(15,2), 0.00) * shr_aq3::numeric(15,2)  + coalesce(tcf_q4::numeric(15,2), 0.00) * shr_aq4::numeric(15,2) 
                                                                                            )  /   
            nullif( price::numeric(15,2), 0.00)  
      ) desc nulls last ) < 0.10
                               ce_fcf_over_price  
    , w52_pradchg_52w_ann
    , w26_pradchg_26w_ann
    , w13_pradchg_13w_ann
  from sipro_data_store.si_finecon 
  where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq_ci is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
  -- and dateindex_ci in (16465,16555)
) sq group by cube(sq.start_date, ce_fcf_over_price);
-- 13W
-- 't' -59 sd:193 ( 23 CASES ) : "(1) *" and "< 0.10" will not work
-- ** GREATES WORST VOLITILITY ** ( TOO FEW CASES TO BE USEFULE )


select 
    sq.start_date
  , sq.ce_and_fcf
  , count(sq.w52_pradchg_52w_ann) w52_ann_ct
  , avg(sq.w52_pradchg_52w_ann) w52_pradchg_52w_ann
  , stddev_pop(sq.w52_pradchg_52w_ann) w52_ann_sd
  , count(sq.w26_pradchg_26w_ann) w26_ann_ct
  , avg(sq.w26_pradchg_26w_ann) w26_pradchg_26w_ann
  , stddev_pop(sq.w26_pradchg_26w_ann) w26_ann_sd
  , count(sq.w13_pradchg_13w_ann) w13_ann_ct
  , avg(sq.w13_pradchg_13w_ann) w13_pradchg_13w_ann
  , stddev_pop(sq.w13_pradchg_13w_ann) w13_ann_sd
  , count(1) w0_ann_ct
from
( select 
      to_timestamp(dateindex_ci*3600*24)::date start_date 
    , ticker_ci 
    , percent_rank() over (partition by dateindex_ci order by ( 
        (-1) * ( 
         coalesce(ce_q1::numeric(15,2), 0.00) / nullif(shr_aq1::numeric(15,2),0.00) +  
         coalesce(ce_q2::numeric(15,2), 0.00) / nullif(shr_aq2::numeric(15,2),0.00) + 
         coalesce(ce_q3::numeric(15,2), 0.00) / nullif(shr_aq3::numeric(15,2),0.00) + 
         coalesce(ce_q4::numeric(15,2), 0.00) / nullif(shr_aq4::numeric(15,2),0.00)   )  / 
            nullif( price::numeric(15,2), 0.00)  
      ) desc nulls last ) >= 0.99 
     and
      percent_rank() over (partition by dateindex_ci order by ( 
      ( fcfps_q1::numeric(15,2) * nullif( shr_aq1::numeric(15,2), 0.00) + fcfps_q2::numeric(15,2) * nullif( shr_aq2::numeric(15,2), 0.00)  +
          fcfps_q3::numeric(15,2) * nullif( shr_aq3::numeric(15,2), 0.00) + fcfps_q4::numeric(15,2) * nullif( shr_aq4::numeric(15,2), 0.00) )  / 
            nullif( price::numeric(15,2), 0.00)  
      ) desc nulls last )  >= 0.90  -- THIS IS AN 'optimal' number
                               ce_and_fcf 
    , w52_pradchg_52w_ann
    , w26_pradchg_26w_ann
    , w13_pradchg_13w_ann
  from sipro_data_store.si_finecon 
  where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq_ci is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
  -- and dateindex_ci in (16465,16555)
) sq group by cube(sq.start_date, ce_and_fcf);
--  >= 0.99 and >= 0.90
-- 'f' 9.12
-- 't' -19.22 ( 887 cases ) BUT OTHERS HAVE 'JUST ONE MEASURE
-- 13W
-- 't' -16.63 sd:123

--------------- END OTHERS -------------
----------------------------------------


----- J_OSAM traditional fundamental values ---------------

-- diluted_earnings_over_price_ratio ( BUT SEE BELOW )

select 
    sq.start_date
  , sq.diluted_earnings_over_priepsd_ratio
  , avg(sq.w52_pradchg_52w_ann) w52_pradchg_52w_ann
  , avg(sq.w26_pradchg_26w_ann) w26_pradchg_26w_ann
  , avg(sq.w13_pradchg_13w_ann) w13_pradchg_13w_ann
from
( select 
      to_timestamp(dateindex_ci*3600*24)::date start_date 
    , ticker_ci 
    , percent_rank() over (partition by dateindex_ci order by ( 
        ( epsd_q1::numeric(15,2) + epsd_q2::numeric(15,2)  + epsd_q3::numeric(15,2) + epsd_q4::numeric(15,2) )  / 
            nullif( price::numeric(15,2), 0.00)  
      ) desc nulls last ) < 0.10 diluted_earnings_over_priepsd_ratio  
    , w52_pradchg_52w_ann
    , w26_pradchg_26w_ann
    , w13_pradchg_13w_ann
  from sipro_data_store.si_finecon 
  where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq_ci is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
  -- and dateindex_ci in (16465,16555)
) sq group by cube(sq.start_date, diluted_earnings_over_priepsd_ratio);
-- LONG TERM: -5 PERCENT BETTER 
-- 'f' 9.66
-- 't' 4.038
-- SHORTEST TERM +50 PERCENT
-- SHORT TERM: -50   PERCENT               
-- LONGER THAN SHORT TERM: -30  PERCENT 
-- LONGER THAN 'LONGER THAT SHORT TERM' 0  PERCENT 


-- OTHER WAY HOW TO DO IT ( SEEMS MORE CORRECT )


select 
    sq.start_date
  , sq.diluted_earnings_over_mktcap_ratio
  , avg(sq.w52_pradchg_52w_ann) w52_pradchg_52w_ann
  , avg(sq.w26_pradchg_26w_ann) w26_pradchg_26w_ann
  , avg(sq.w13_pradchg_13w_ann) w13_pradchg_13w_ann
from
( select 
      to_timestamp(dateindex_ci*3600*24)::date start_date 
    , ticker_ci 
    , percent_rank() over (partition by dateindex_ci order by ( 
        ( epsd_q1::numeric(15,2) * shr_aq1::numeric(15,2) + 
          epsd_q2::numeric(15,2) * shr_aq2::numeric(15,2) + 
          epsd_q3::numeric(15,2) * shr_aq3::numeric(15,2) + 
          epsd_q4::numeric(15,2) * shr_aq4::numeric(15,2))  / 
            nullif( mktcap::numeric(15,2), 0.00)  
      ) desc nulls last ) < 0.10 diluted_earnings_over_mktcap_ratio  
    , w52_pradchg_52w_ann
    , w26_pradchg_26w_ann
    , w13_pradchg_13w_ann
  from sipro_data_store.si_finecon 
  where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq_ci is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
  -- and dateindex_ci in (16465,16555)
) sq group by cube(sq.start_date, diluted_earnings_over_mktcap_ratio);

-- LONG TERM: 1 PERCENT BETTER 
-- 'f' 8.23
-- 't' 9.19
-- SHORTEST TERM 2  PERCENT
-- SHORT TERM: -6  PERCENT               
-- LONGER THAN SHORT TERM: -5  PERCENT 
-- LONGER THAN 'LONGER THAT SHORT TERM' +1 PERCENT 




-- sales_over_price_ratio


select 
    sq.start_date
  , sq.sales_over_price_ratio
  , count(sq.w52_pradchg_52w_ann) w52_ann_ct
  , avg(sq.w52_pradchg_52w_ann) w52_pradchg_52w_ann
  , count(sq.w26_pradchg_26w_ann) w26_ann_ct
  , avg(sq.w26_pradchg_26w_ann) w26_pradchg_26w_ann
  , count(sq.w13_pradchg_13w_ann) w13_ann_ct
  , avg(sq.w13_pradchg_13w_ann) w13_pradchg_13w_ann
from
( select 
      to_timestamp(dateindex_ci*3600*24)::date start_date 
    , ticker_ci 
    , percent_rank() over (partition by dateindex_ci order by ( 
      ( sales_q1::numeric(15,2) / nullif( shr_aq1::numeric(15,2), 0.00) + sales_q2::numeric(15,2) / nullif( shr_aq2::numeric(15,2), 0.00)  +
          sales_q3::numeric(15,2) / nullif( shr_aq3::numeric(15,2), 0.00) + sales_q4::numeric(15,2) / nullif( shr_aq4::numeric(15,2), 0.00) )  / 
            nullif( price::numeric(15,2), 0.00)  
      ) desc nulls last ) < 0.10 sales_over_price_ratio  
    , w52_pradchg_52w_ann
    , w26_pradchg_26w_ann
    , w13_pradchg_13w_ann
  from sipro_data_store.si_finecon 
  where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq_ci is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
  -- and dateindex_ci in (16465,16555)
) sq group by cube(sq.start_date, sales_over_price_ratio);
-- LONG TERM: 3.2 PERCENT BETTER 
-- < 0.10
-- 'f' 8.76
-- 't' 12.05
-- SHORTEST TERM  +30  PERCENT
-- SHORT TERM: +18   PERCENT               
-- LONGER THAN SHORT TERM: -5  PERCENT 
-- LONGER THAN 'LONGER THAT SHORT TERM' +9 PERCENT 

-- < 0.01    ** BIG WINNER **
-- 'f' 9.04
-- 't' 15.28 

-- < 0.005 
-- 'f'  9.06
-- 't' 16.48  ( *** HIGHEST PERCENT WINNER *** )

 start_date | sales_over_price_ratio | w52_ann_ct |     w52_pradchg_52w_ann      | w26_ann_ct |     w26_pradchg_26w_ann      | w13_ann_ct |     w13_pradchg_13w_ann
------------+------------------------+------------+------------------------------+------------+------------------------------+------------+------------------------------
            | t                      |        891 |      16.48766521476267660620 |       1019 |      13.11373525982406577306 |       1083 |      13.21033250587346334067

-- >= 0.90
-- 'f' 9.8.0
-- 't' 0.23

-- >= 0.99
-- 'f' 9.0
-- 't' NO CASES



-- sales_over_price_ratio_2q ( SIMILAR NUMBERS: SO I ONLY NEED TO GO BACK 2 QUARTERS )


select 
    sq.start_date
  , sq.sales_over_price_ratio_2q
  , count(sq.w52_pradchg_52w_ann) w52_ann_ct
  , avg(sq.w52_pradchg_52w_ann) w52_pradchg_52w_ann
  , count(sq.w26_pradchg_26w_ann) w26_ann_ct
  , avg(sq.w26_pradchg_26w_ann) w26_pradchg_26w_ann
  , count(sq.w13_pradchg_13w_ann) w13_ann_ct
  , avg(sq.w13_pradchg_13w_ann) w13_pradchg_13w_ann
from
( select 
      to_timestamp(dateindex_ci*3600*24)::date start_date 
    , ticker_ci 
    , percent_rank() over (partition by dateindex_ci order by ( 
      ( sales_q1::numeric(15,2) / nullif( shr_aq1::numeric(15,2), 0.00) + sales_q2::numeric(15,2) / nullif( shr_aq2::numeric(15,2), 0.00)  )  / 
          nullif( price::numeric(15,2), 0.00)  
      ) desc nulls last ) >= 0.99 sales_over_price_ratio_2q  
    , w52_pradchg_52w_ann
    , w26_pradchg_26w_ann
    , w13_pradchg_13w_ann
  from sipro_data_store.si_finecon 
  where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq_ci is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
  -- and dateindex_ci in (16465,16555)
) sq group by cube(sq.start_date, sales_over_price_ratio_2q);

-- < 0.10
-- 'f'  8.37
-- 't' 12.33

-- < 0.01
-- 'f'  9.04
-- 't' 15.12  

--  >= 0.90
-- 'f' 9.82
-- 't' 1.10

-- >= 0.99
-- 'f' 9.0
-- 't' NO CASES



-- AAII .hlp definition
-- Free cash flow per share = (Cash from operations – Capital expenditures – Dividends paid) / Average Shares Outstanding


-- ANDRE VARIANT OF ABOVE

-- fcf_over_price_ratio 


select 
    sq.start_date
  , sq.fcf_over_price_ratio
  , count(sq.w52_pradchg_52w_ann) w52_ann_ct
  , avg(sq.w52_pradchg_52w_ann) w52_pradchg_52w_ann
  , stddev_pop(sq.w52_pradchg_52w_ann) w52_ann_ct_sd
  , count(sq.w26_pradchg_26w_ann) w26_ann_ct
  , avg(sq.w26_pradchg_26w_ann) w26_pradchg_26w_ann
  , stddev_pop(sq.w26_pradchg_26w_ann) w26_ann_ct_sd
  , count(sq.w13_pradchg_13w_ann) w13_ann_ct
  , avg(sq.w13_pradchg_13w_ann) w13_pradchg_13w_ann
  , stddev_pop(sq.w13_pradchg_13w_ann) w13_ann_ct_sd
from
( select 
      to_timestamp(dateindex*3600*24)::date start_date 
    , ticker 
    , percent_rank() over (partition by dateindex order by ( 
        ( 
           fcfps_q1::numeric(15,2) * nullif( shr_aq1::numeric(15,2), 0.00) 
         + fcfps_q2::numeric(15,2) * nullif( shr_aq2::numeric(15,2), 0.00)  
         + fcfps_q3::numeric(15,2) * nullif( shr_aq3::numeric(15,2), 0.00) + fcfps_q4::numeric(15,2) * nullif( shr_aq4::numeric(15,2), 0.00) 
     --  + fcfps_q5::numeric(15,2) * nullif( shr_aq5::numeric(15,2), 0.00) + fcfps_q6::numeric(15,2) * nullif( shr_aq6::numeric(15,2), 0.00) 
     --  + fcfps_q7::numeric(15,2) * nullif( shr_aq7::numeric(15,2), 0.00) + fcfps_q8::numeric(15,2) * nullif( shr_aq8::numeric(15,2), 0.00) 
         )  / 
            nullif( price::numeric(15,2), 0.00)  
      ) desc nulls last ) < 0.001 fcf_over_price_ratio  
    , w52_pradchg_52w_ann
    , w26_pradchg_26w_ann
    , w13_pradchg_13w_ann
  from sipro_data_store.si_finecon 
  where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
  -- and dateindex in (16465,16555)
) sq group by cube(sq.start_date, fcf_over_price_ratio);
-- < 0.10
--'f'  8.50
--'t' 14.21

--  < 0.01
--'f' 9.05
--'t' 13.44

 start_date | fcf_over_price_ratio | w52_ann_ct |     w52_pradchg_52w_ann      | w26_ann_ct |     w26_pradchg_26w_ann      | w13_ann_ct |     w13_pradchg_13w_ann
------------+----------------------+------------+------------------------------+------------+------------------------------+------------+------------------------------
            | t                    |       1837 |      13.44694490898093758717 |       2057 |      11.32463693490826451549 |       2165 |      12.13921796938048603023


-- < 0.005 ( THROUGH END OF JUNE 2016 )
-- 'f' 9.07
-- 't' 15.25  

-- < 0.005 ( THROUGH END OF AUG 2016 )
-- 'f' 8.57
-- 't' 14.39 ( + 5.75 )
  
-- < 0.001 ( THROUGH END OF AUG 2016 )
-- 'f' 8.59
-- 't' 16.57 ( + 8.00 )


 start_date | fcf_over_price_ratio | w52_ann_ct |     w52_pradchg_52w_ann      | w26_ann_ct |     w26_pradchg_26w_ann      | w13_ann_ct |     w13_pradchg_13w_ann
------------+----------------------+------------+------------------------------+------------+------------------------------+------------+------------------------------
            | t                    |        935 |      15.25557487472850463006 |       1048 |      12.61688018038663886059 |       1101 |      13.09920200623551214186

-- >= 0.90  -- JUST AVOID THIS BOTTOM AND DO '1 PERCENT BETTER'
-- 'f' 10.26
-- 't' -3.31

-- >= 0.99
-- "start_date"
-- "2014-05-30" -  NO TRUE CASES EXISTED BEFORE THIS DATE
-- UP TRHOUGHT "start_date" EVERYTHING WAS A WINNER
--             "2014-07-31"
-- 9.18
-- -15.83 ( 24% OFF OF 9% ) (*** VOLITILITY WINNER ***)
--                                                                                               ( BETTER OFF SELLING HERE )
 start_date | fcf_over_price_ratio | w52_ann_ct |     w52_pradchg_52w_ann      | w26_ann_ct |     w26_pradchg_26w_ann      | w13_ann_ct |     w13_pradchg_13w_ann
------------+----------------------+------------+------------------------------+------------+------------------------------+------------+------------------------------
            | t                    |        567 |     -15.83433642684486461142 |        775 |     -20.12478442911679305815 |        878 |     -14.73233233645831486938




-- fcf_over_price_ratio_2q ( SIMILAR TO ABOVE, SO I NEED ONLY 2 QUARTERS )

select 
    sq.start_date
  , sq.fcf_over_price_ratio_2q
  , count(sq.w52_pradchg_52w_ann) w52_ann_ct
  , avg(sq.w52_pradchg_52w_ann) w52_pradchg_52w_ann
  , count(sq.w26_pradchg_26w_ann) w26_ann_ct
  , avg(sq.w26_pradchg_26w_ann) w26_pradchg_26w_ann
  , count(sq.w13_pradchg_13w_ann) w13_ann_ct
  , avg(sq.w13_pradchg_13w_ann) w13_pradchg_13w_ann
from
( select 
      to_timestamp(dateindex_ci*3600*24)::date start_date 
    , ticker_ci 
    , percent_rank() over (partition by dateindex_ci order by ( 
      ( fcfps_q1::numeric(15,2) * nullif( shr_aq1::numeric(15,2), 0.00) + fcfps_q2::numeric(15,2) * nullif( shr_aq2::numeric(15,2), 0.00)  
         )  / 
            nullif( price::numeric(15,2), 0.00)  
      ) desc nulls last ) >= 0.99 fcf_over_price_ratio_2q  
    , w52_pradchg_52w_ann
    , w26_pradchg_26w_ann
    , w13_pradchg_13w_ann
  from sipro_data_store.si_finecon 
  where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq_ci is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
  -- and dateindex_ci in (16465,16555)
) sq group by cube(sq.start_date, fcf_over_price_ratio_2q);
-- < 0.10
-- 'f'  8.59
-- 't' 13.50

-- < 0.01
-- 'f'  9.05
-- 't' 13.93

--  >= 0.90
-- 'f'  10.15
-- 't' -2.11

--  >= 0.99
-- 'f'   9.23
-- 't' -15.23





-- VARIANT: fcf_over_price_ratio, different quarter combos

select 
    sq.start_date
  , coalesce(sq.fcf_over_price_ratio1q::text,'cNONE') sq_fcf_over_price_ratio1q
  , coalesce(sq.fcf_over_price_ratio2q::text,'cNONE') sq_fcf_over_price_ratio2q
  , coalesce(sq.fcf_over_price_ratio4q::text,'cNONE') sq_fcf_over_price_ratio4q
  , count(sq.w52_pradchg_52w_ann) w52_ann_ct
  , avg(sq.w52_pradchg_52w_ann) w52_pradchg_52w_ann
  , count(sq.w26_pradchg_26w_ann) w26_ann_ct
  , avg(sq.w26_pradchg_26w_ann) w26_pradchg_26w_ann
  , count(sq.w13_pradchg_13w_ann) w13_ann_ct
  , avg(sq.w13_pradchg_13w_ann) w13_pradchg_13w_ann
from
( select 
      to_timestamp(dateindex_ci*3600*24)::date start_date 
    , ticker_ci 
    , percent_rank() over (partition by dateindex_ci order by ( 
      ( fcfps_q1::numeric(15,2) * nullif( shr_aq1::numeric(15,2), 0.00) + fcfps_q2::numeric(15,2) * nullif( shr_aq2::numeric(15,2), 0.00)  +
          fcfps_q3::numeric(15,2) * nullif( shr_aq3::numeric(15,2), 0.00) + fcfps_q4::numeric(15,2) * nullif( shr_aq4::numeric(15,2), 0.00) )  / 
            nullif( price::numeric(15,2), 0.00)  
      ) desc nulls last ) <= 0.005 fcf_over_price_ratio4q  
    , percent_rank() over (partition by dateindex_ci order by ( 
      ( fcfps_q1::numeric(15,2) * nullif( shr_aq1::numeric(15,2), 0.00) + fcfps_q2::numeric(15,2) * nullif( shr_aq2::numeric(15,2), 0.00)   )  / 
            nullif( price::numeric(15,2), 0.00)  
      ) desc nulls last ) <= 0.005 fcf_over_price_ratio2q 
    , percent_rank() over (partition by dateindex_ci order by ( 
      ( fcfps_q1::numeric(15,2) * nullif( shr_aq1::numeric(15,2), 0.00)                                                                     )  / 
            nullif( price::numeric(15,2), 0.00)  
      ) desc nulls last ) <= 0.005 fcf_over_price_ratio1q
    , w52_pradchg_52w_ann
    , w26_pradchg_26w_ann
    , w13_pradchg_13w_ann
  from sipro_data_store.si_finecon 
  where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq_ci is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
  -- and dateindex_ci in (16465,16555)
) sq group by cube(sq.start_date, sq_fcf_over_price_ratio1q, sq_fcf_over_price_ratio2q, sq_fcf_over_price_ratio4q);
--
-- BEST DEAL: NEVER SEE A 'FALSE'

 start_date | sq_fcf_over_price_ratio1q | sq_fcf_over_price_ratio2q | sq_fcf_over_price_ratio4q | w52_ann_ct |     w52_pradchg_52w_ann      | w26_ann_ct |     w26_pradchg_26w_ann      | w13_ann_ct |     w13_pradchg_13w_ann
------------+---------------------------+---------------------------+---------------------------+------------+------------------------------+------------+------------------------------+------------+------------------------------
            |                           |                           | true                      |        935 |      15.25557487472850463006 |       1048 |      12.61688018038663886059 |       1101 |      13.09920200623551214186
            |                           | true                      | true                      |        694 |      15.50797147641329812515 |        787 |      12.83716264464095645697 |        823 |      13.33575127263842272680
            | true                      | true                      | true                      |        506 |      15.90354003863013986771 |        575 |      13.82256663824691301114 |        603 |      15.04645386339533257522
            | true                      | true                      |                           |        633 |      14.71353212206648500161 |        715 |      12.82344480355290953999 |        752 |      14.11281468217119409806
            | true                      |                           |                           |        908 |      12.52870956749828476948 |       1039 |      10.28503168709740418941 |       1092 |      12.35332033052629564382

-- >= 0.99 ( KEEP HERE BECAUSE OF 'CUSTOMIZED' ORDER BY )

select rq.* from (
select 
    sq.start_date
  , coalesce(sq.fcf_over_price_ratio1q::text,'cNONE') sq_fcf_over_price_ratio1q
  , coalesce(sq.fcf_over_price_ratio2q::text,'cNONE') sq_fcf_over_price_ratio2q
  , coalesce(sq.fcf_over_price_ratio4q::text,'cNONE') sq_fcf_over_price_ratio4q
  , count(sq.w52_pradchg_52w_ann) w52_ann_ct
  , avg(sq.w52_pradchg_52w_ann) w52_pradchg_52w_ann
  , count(sq.w26_pradchg_26w_ann) w26_ann_ct
  , avg(sq.w26_pradchg_26w_ann) w26_pradchg_26w_ann
  , count(sq.w13_pradchg_13w_ann) w13_ann_ct
  , avg(sq.w13_pradchg_13w_ann) w13_pradchg_13w_ann
from
( select 
      to_timestamp(dateindex_ci*3600*24)::date start_date 
    , ticker_ci 
    , percent_rank() over (partition by dateindex_ci order by ( 
      ( fcfps_q1::numeric(15,2) * nullif( shr_aq1::numeric(15,2), 0.00) + fcfps_q2::numeric(15,2) * nullif( shr_aq2::numeric(15,2), 0.00)  +
          fcfps_q3::numeric(15,2) * nullif( shr_aq3::numeric(15,2), 0.00) + fcfps_q4::numeric(15,2) * nullif( shr_aq4::numeric(15,2), 0.00) )  / 
            nullif( price::numeric(15,2), 0.00)  
      ) desc nulls last ) >= 0.99 fcf_over_price_ratio4q  
    , percent_rank() over (partition by dateindex_ci order by ( 
      ( fcfps_q1::numeric(15,2) * nullif( shr_aq1::numeric(15,2), 0.00) + fcfps_q2::numeric(15,2) * nullif( shr_aq2::numeric(15,2), 0.00)   )  / 
            nullif( price::numeric(15,2), 0.00)  
      ) desc nulls last ) >= 0.99 fcf_over_price_ratio2q 
    , percent_rank() over (partition by dateindex_ci order by ( 
      ( fcfps_q1::numeric(15,2) * nullif( shr_aq1::numeric(15,2), 0.00)                                                                     )  / 
            nullif( price::numeric(15,2), 0.00)  
      ) desc nulls last ) >= 0.99 fcf_over_price_ratio1q
    , w52_pradchg_52w_ann
    , w26_pradchg_26w_ann
    , w13_pradchg_13w_ann
  from sipro_data_store.si_finecon 
  where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq_ci is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
  -- and dateindex_ci in (16465,16555)
) sq group by cube(sq.start_date, sq_fcf_over_price_ratio1q, sq_fcf_over_price_ratio2q, sq_fcf_over_price_ratio4q)
) rq where rq.start_date is null
order by  rq.sq_fcf_over_price_ratio1q nulls first, rq.sq_fcf_over_price_ratio2q nulls first, rq.sq_fcf_over_price_ratio4q nulls first;


-- BEST DEAL: ANY '2 of the last 3' seen TRUE
-- ESPECIALLY ANY '2 of the last 3' seen TRUE AND THE 3rd 'NOT SEEN'

 start_date | sq_fcf_over_price_ratio1q | sq_fcf_over_price_ratio2q | sq_fcf_over_price_ratio4q | w52_ann_ct |     w52_pradchg_52w_ann      | w26_ann_ct |     w26_pradchg_26w_ann      | w13_ann_ct |     w13_pradchg_13w_ann
------------+---------------------------+---------------------------+---------------------------+------------+------------------------------+------------+------------------------------+------------+------------------------------
            |                           |                           |                           |     172297 | 9.104111870125267823718005 |     197892 | 7.980821807680966916591249 |     210762 | 9.369671377324513917189430
            |                           |                           | false                     |     171730 | 9.186451008216353045232727 |     197117 | 8.091323919794677372718453 |     209884 | 9.470496400959956941310394
            |                           |                           | true                      |        567 |   -15.83433642684486461142 |        775 |   -20.12478442911679305815 |        878 |   -14.73233233645831486938
            |                           | false                     |                           |     171373 | 9.235366019388771887562231 |     196744 | 8.132492445244840834955350 |     209503 | 9.499161139104991413471973
            |                           | false                     | false                     |     171098 | 9.256927457507526140600166 |     196358 | 8.168569388318506549695685 |     209073 | 9.536144458677539480464846
            |                           | false                     | true                      |        275 |    -4.17961194149346515347 |        386 |   -10.21982980361228977381 |        430 |    -8.48273089110743186653
            |                           | true                      |                           |        924 |   -15.23941336984711522085 |       1148 |   -18.01246034986851931566 |       1259 |   -12.17798037986005868303
            |                           | true                      | false                     |        632 |    -9.89326342346265687752 |        759 |   -11.89255711894320079974 |        811 |    -7.45334622689224306934
            |                           | true                      | true                      |        292 |   -26.81053243188470999134 |        389 |   -29.95335122974594027604 |        448 |   -20.73083372373706418014
            | false                     |                           |                           |     171304 | 9.226200698845929729228869 |     196671 | 8.122403143280157965682594 |     209430 | 9.501260529150371906470624
            | false                     |                           | false                     |     170968 | 9.261719529378520152493462 |     196194 | 8.179717886464868344624542 |     208898 | 9.561486908490853894454129
            | false                     |                           | true                      |        336 |    -8.84696423715383064190 |        477 |   -15.45161933969902041196 |        532 |   -14.14755562022557983371
            | false                     | false                     |                           |     170989 | 9.272574573231602470375610 |     196280 | 8.172802742955535882521700 |     209010 | 9.541047572526654719044671
            | false                     | false                     | false                     |     170723 | 9.292763183434304846755312 |     195903 | 8.207006303156497639665862 |     208589 | 9.575785428890369924592067
            | false                     | false                     | true                      |        266 |    -3.68479422239229904343 |        377 |    -9.60061915107367130531 |        421 |    -7.67019879576548544705
            | false                     | true                      |                           |        315 |   -15.94656884823913800391 |        391 |   -17.17793809529574361278 |        420 |   -10.29847741388979632234
            | false                     | true                      | false                     |        245 |   -12.37038557823670580043 |        291 |   -10.19101302467002439242 |        309 |    -0.09066219058568076717
            | false                     | true                      | true                      |         70 |   -28.46321029324765071611 |        100 |   -37.50989005081658654404 |        111 |   -38.71482790038503692187
            | true                      |                           |                           |        993 |   -11.95762500315193969051 |       1221 |   -14.82420919447177904233 |       1332 |   -11.32005539961950912723
            | true                      |                           | false                     |        762 |    -7.70135545642063644841 |        923 |   -10.69780489590569916265 |        986 |    -9.80712534568234703214
            | true                      |                           | true                      |        231 |   -25.99778688457727765799 |        298 |   -27.60498492459423450860 |        346 |   -15.63146879031905197623
            | true                      | false                     |                           |        384 |    -7.33300224371476593712 |        464 |    -8.91945849151210730367 |        493 |    -8.25881746020910087405
            | true                      | false                     | false                     |        375 |    -7.05769290888564999520 |        455 |    -8.38067660620230333696 |        484 |    -7.54788516058710826758
            | true                      | false                     | true                      |          9 |   -18.80422452826126351700 |          9 |   -36.15787602661886339867 |          9 |   -46.49117668432514771111
            | true                      | true                      |                           |        609 |   -14.87364329481675860891 |        757 |   -18.44350156722381033261 |        839 |   -13.11885194804541052033
            | true                      | true                      | false                     |        387 |    -8.32505947534988688756 |        468 |   -12.95056851089511177096 |        502 |   -11.98535691856301548243
            | true                      | true                      | true                      |        222 |   -26.28941779091441336641 |        289 |   -27.33863191449658170579 |        337 |   -14.80732228869871114058



-- VARIANT:  
-- fcf_p_divs_over_price_ratio

select 
    sq.start_date
  , sq.fcf_p_divs_over_price_ratio
  , count(sq.w52_pradchg_52w_ann) w52_ann_ct
  , avg(sq.w52_pradchg_52w_ann) w52_pradchg_52w_ann
  , count(sq.w26_pradchg_26w_ann) w26_ann_ct
  , avg(sq.w26_pradchg_26w_ann) w26_pradchg_26w_ann
  , count(sq.w13_pradchg_13w_ann) w13_ann_ct
  , avg(sq.w13_pradchg_13w_ann) w13_pradchg_13w_ann
from
( select 
      to_timestamp(dateindex_ci*3600*24)::date start_date 
    , ticker_ci 
    , percent_rank() over (partition by dateindex_ci order by ( 
      ( ( coalesce(fcfps_q1::numeric(15,2), 0.00) + coalesce(dps_q1::numeric(15,2), 0.00) ) * nullif( shr_aq1::numeric(15,2), 0.00) + 
        ( coalesce(fcfps_q2::numeric(15,2), 0.00) + coalesce(dps_q2::numeric(15,2), 0.00)  ) * nullif( shr_aq2::numeric(15,2), 0.00) +
        ( coalesce(fcfps_q3::numeric(15,2), 0.00) + coalesce(dps_q3::numeric(15,2), 0.00)  ) * nullif( shr_aq3::numeric(15,2), 0.00) + 
        ( coalesce(fcfps_q4::numeric(15,2), 0.00) + coalesce(dps_q4::numeric(15,2), 0.00)  ) * nullif( shr_aq4::numeric(15,2), 0.00)   )  / 
            nullif( price::numeric(15,2), 0.00)  
      ) desc nulls last ) <= 0.005 fcf_p_divs_over_price_ratio  
    , w52_pradchg_52w_ann
    , w26_pradchg_26w_ann
    , w13_pradchg_13w_ann
  from sipro_data_store.si_finecon 
  where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq_ci is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
  -- and dateindex_ci in (16465,16555)
) sq group by cube(sq.start_date, fcf_p_divs_over_price_ratio);

-- run with dps_ EXACT SAME number AS ABOVE - DIVIDENDS DO NOT MATTER ( meaning: already baked into the price )
-- run with coalesce(fcfps_q1::numeric(15,2), 0.00) + dps_ EXACT 
-- not enough error
--   SAME number AS ABOVE - DIVIDENDS DO NOT MATTER ( meaning: already baked into the price )



-- VARIANT: sq_fcf_over_4_quarters ( JUST RANDOMNESS )

select rs.* from (
  select 
      sq.start_date
    , coalesce(sq.pfs_eq_offer_sig12::text,'cNONE') sq_fcf_over_4_quarters12 
    , coalesce(sq.pfs_eq_offer_sig23::text,'cNONE') sq_fcf_over_4_quarters23 
    , coalesce(sq.pfs_eq_offer_sig34::text,'cNONE') sq_fcf_over_4_quarters34 
    , coalesce(sq.pfs_eq_offer_sig45::text,'cNONE') sq_fcf_over_4_quarters45 
    , count(sq.w52_pradchg_52w_ann) w52_ann_ct
    , avg(sq.w52_pradchg_52w_ann) w52_pradchg_52w_ann
    , count(sq.w26_pradchg_26w_ann) w26_ann_ct
    , avg(sq.w26_pradchg_26w_ann) w26_pradchg_26w_ann
    , count(sq.w13_pradchg_13w_ann) w13_ann_ct
    , avg(sq.w13_pradchg_13w_ann) w13_pradchg_13w_ann
  from
  ( select 
        to_timestamp(dateindex_ci*3600*24)::date start_date 
      , ticker_ci 
      , fcfps_q1::numeric(15,2) * shr_aq1::numeric(15,2) < fcfps_q2::numeric(15,2) * shr_aq2::numeric(15,2)  pfs_eq_offer_sig12
      , fcfps_q2::numeric(15,2) * shr_aq2::numeric(15,2) < fcfps_q3::numeric(15,2) * shr_aq3::numeric(15,2)  pfs_eq_offer_sig23
      , fcfps_q3::numeric(15,2) * shr_aq3::numeric(15,2) < fcfps_q4::numeric(15,2) * shr_aq4::numeric(15,2)  pfs_eq_offer_sig34
      , fcfps_q4::numeric(15,2) * shr_aq4::numeric(15,2) < fcfps_q5::numeric(15,2) * shr_aq5::numeric(15,2)  pfs_eq_offer_sig45  -- MISTAKE:  shr_aq3::numeric(15,2)
      , w52_pradchg_52w_ann
      , w26_pradchg_26w_ann
      , w13_pradchg_13w_ann
    from sipro_data_store.si_finecon 
    where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq_ci is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
    -- and dateindex_ci in (16465,16555)
  ) sq group by cube(sq.start_date, sq_fcf_over_4_quarters12, sq_fcf_over_4_quarters23, sq_fcf_over_4_quarters34, sq_fcf_over_4_quarters45)
) rs 
  where start_date is null
order by rs.w52_pradchg_52w_ann nulls first;
--order by rs.sq_fcf_over_4_quarters12 nulls first, rs.sq_fcf_over_4_quarters23 nulls first, rs.sq_fcf_over_4_quarters34 nulls first, rs.sq_fcf_over_4_quarters45 nulls first;
--JUST RANDOMNESS



-- biggest inbound
-- fcf_p_divpaid_p_ce_over_price_ratio
-- so 'biggest inbound' does not matter ( it is 'what is 'done with' the biggest inbound.' )

select 
    sq.start_date
  , sq.fcf_p_divpaid_p_ce_over_price_ratio
  , count(sq.w52_pradchg_52w_ann) w52_ann_ct
  , avg(sq.w52_pradchg_52w_ann) w52_pradchg_52w_ann
  , count(sq.w26_pradchg_26w_ann) w26_ann_ct
  , avg(sq.w26_pradchg_26w_ann) w26_pradchg_26w_ann
  , count(sq.w13_pradchg_13w_ann) w13_ann_ct
  , avg(sq.w13_pradchg_13w_ann) w13_pradchg_13w_ann
from
( select 
      to_timestamp(dateindex*3600*24)::date start_date 
    , ticker 
    , percent_rank() over (partition by dateindex order by ( 
      ( 
        ( coalesce(fcfps_q1::numeric(15,2), 0.00) + ( coalesce(divpaid_q1::numeric(15,2),0.00) + coalesce(ce_q1::numeric(15,2),0.00) )/ nullif( shr_aq1::numeric(15,2), 0.00) ) +
        ( coalesce(fcfps_q2::numeric(15,2), 0.00) + ( coalesce(divpaid_q2::numeric(15,2),0.00) + coalesce(ce_q2::numeric(15,2),0.00) )/ nullif( shr_aq1::numeric(15,2), 0.00) ) +
        ( coalesce(fcfps_q3::numeric(15,2), 0.00) + ( coalesce(divpaid_q3::numeric(15,2),0.00) + coalesce(ce_q3::numeric(15,2),0.00) )/ nullif( shr_aq1::numeric(15,2), 0.00) ) +
        ( coalesce(fcfps_q4::numeric(15,2), 0.00) + ( coalesce(divpaid_q4::numeric(15,2),0.00) + coalesce(ce_q4::numeric(15,2),0.00) )/ nullif( shr_aq1::numeric(15,2), 0.00) ) 
      )   / 
          nullif( price::numeric(15,2), 0.00)  
      ) desc nulls last ) >= 0.99 fcf_p_divpaid_p_ce_over_price_ratio 
    , w52_pradchg_52w_ann
    , w26_pradchg_26w_ann
    , w13_pradchg_13w_ann
  from sipro_data_store.si_finecon 
  where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
  -- and dateindex in (16465,16555)
) sq group by cube(sq.start_date, fcf_p_divpaid_p_ce_over_price_ratio);
-- < 0.10
-- 'f' 8.78
-- 't' 7.08

-- < 0.01
-- 'f' 8.66
-- 't' 3.91

--  >= 0.90
-- 'f' 9.46
-- 't' 0.12

--  >= 0.99
-- 'f' 8.66
-- 't' 0.3 -- FLATTENS OUT




-- ALTERNATE? to fcfps? tcf_tci_tco_over_mktcap_ratio

select 
    sq.start_date
  , sq.tcf_tci_tco_over_mktcap_ratio
  , count(sq.w52_pradchg_52w_ann) w52_ann_ct
  , avg(sq.w52_pradchg_52w_ann) w52_pradchg_52w_ann
  , count(sq.w26_pradchg_26w_ann) w26_ann_ct
  , avg(sq.w26_pradchg_26w_ann) w26_pradchg_26w_ann
  , count(sq.w13_pradchg_13w_ann) w13_ann_ct
  , avg(sq.w13_pradchg_13w_ann) w13_pradchg_13w_ann
from
( select 
      to_timestamp(dateindex_ci*3600*24)::date start_date 
    , ticker_ci 
    , percent_rank() over (partition by dateindex_ci order by ( 
     ( 
        coalesce(tco_q1::numeric(15,2), 0.00)  + coalesce(tco_q2::numeric(15,2), 0.00)   +
        coalesce(tco_q3::numeric(15,2), 0.00)  + coalesce(tco_q4::numeric(15,2), 0.00)   +
        coalesce(tci_q1::numeric(15,2), 0.00)  + coalesce(tci_q2::numeric(15,2), 0.00)   +
        coalesce(tci_q3::numeric(15,2), 0.00)  + coalesce(tci_q4::numeric(15,2), 0.00)   +
        coalesce(tcf_q1::numeric(15,2), 0.00)  + coalesce(tcf_q2::numeric(15,2), 0.00)   +
        coalesce(tcf_q3::numeric(15,2), 0.00)  + coalesce(tcf_q4::numeric(15,2), 0.00)      
                                                                                            )  / 
            nullif( mktcap::numeric(15,2), 0.00)  
      ) desc nulls last ) >= 0.99 tcf_tci_tco_over_mktcap_ratio 
    , w52_pradchg_52w_ann
    , w26_pradchg_26w_ann
    , w13_pradchg_13w_ann
  from sipro_data_store.si_finecon 
  where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq_ci is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
  -- and dateindex_ci in (16465,16555)
) sq group by cube(sq.start_date, tcf_tci_tco_over_mktcap_ratio);
-- < 0.10
-- 'f' 9.29  -- DOES NOT MAKE SENSE? fcfps DID SO WELL
-- 't' 7.36  
-- < 0.01
-- 'f' 9.12
-- 't' 6.58
-- >= 0.90  - POOR CASH FLOW COMPANIES HAVE *POORER RETURNS - DOES MAKE SENSE
-- 'f' 9.35
-- 't' 6.78 - DOING WORSE
-- >= 0.99    
-- 'f' 9.15
-- 't' 3.81  -- ONLY THE MOST EXTREME COMPANIES TO WORSE  


-- VARIANT: ( AAII FCFPS )

select 
    sq.start_date
  , sq.tcf_tci_tco_over_price_ratio
  , count(sq.w52_pradchg_52w_ann) w52_ann_ct
  , avg(sq.w52_pradchg_52w_ann) w52_pradchg_52w_ann
  , count(sq.w26_pradchg_26w_ann) w26_ann_ct
  , avg(sq.w26_pradchg_26w_ann) w26_pradchg_26w_ann
  , count(sq.w13_pradchg_13w_ann) w13_ann_ct
  , avg(sq.w13_pradchg_13w_ann) w13_pradchg_13w_ann
from
( select 
      to_timestamp(dateindex_ci*3600*24)::date start_date 
    , ticker_ci 
    , percent_rank() over (partition by dateindex_ci order by ( 
     ( 
        coalesce(tco_q1::numeric(15,2), 0.00) * shr_aq1::numeric(15,2) + coalesce(tco_q2::numeric(15,2), 0.00) * shr_aq2::numeric(15,2)  +
        coalesce(tco_q3::numeric(15,2), 0.00) * shr_aq3::numeric(15,2) + coalesce(tco_q4::numeric(15,2), 0.00) * shr_aq4::numeric(15,2)  +
        coalesce(tci_q1::numeric(15,2), 0.00) * shr_aq1::numeric(15,2) + coalesce(tci_q2::numeric(15,2), 0.00) * shr_aq2::numeric(15,2)  +
        coalesce(tci_q3::numeric(15,2), 0.00) * shr_aq3::numeric(15,2) + coalesce(tci_q4::numeric(15,2), 0.00) * shr_aq4::numeric(15,2)  +
        coalesce(tcf_q1::numeric(15,2), 0.00) * shr_aq1::numeric(15,2) + coalesce(tcf_q2::numeric(15,2), 0.00) * shr_aq2::numeric(15,2)  +
        coalesce(tcf_q3::numeric(15,2), 0.00) * shr_aq3::numeric(15,2) + coalesce(tcf_q4::numeric(15,2), 0.00) * shr_aq4::numeric(15,2)     
                                                                                            )  / 
            nullif( price::numeric(15,2), 0.00)  
      ) desc nulls last ) < 0.10 tcf_tci_tco_over_price_ratio 
    , w52_pradchg_52w_ann
    , w26_pradchg_26w_ann
    , w13_pradchg_13w_ann
  from sipro_data_store.si_finecon 
  where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq_ci is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
  -- and dateindex_ci in (16465,16555)
) sq group by cube(sq.start_date, tcf_tci_tco_over_price_ratio);
-- < 0.10
-- 'f' 9.21
-- 't' 8.14 ( OVER-BOUGHT )

-- < 0.01
-- 'f'  9.05
-- 't' 13.3

-- >= 0.90  
-- 'f' 9.63
-- 't' 3.49 POORER COMPANIES HAVE 'LESS GOOD  RETURN'

-- >= 0.99    
-- 'f'  9.14
-- 't' -3.73


--
-- tcf and shr_aq ( special relation ): sell shr_aq(more) to gather tcf(more)

-- ALTERNATE? to fcfps? not_tcf_over_mktcap_ratio

select 
    sq.start_date
  , sq.not_tcf_over_mktcap_ratio
  , count(sq.w52_pradchg_52w_ann) w52_ann_ct
  , avg(sq.w52_pradchg_52w_ann) w52_pradchg_52w_ann
  , count(sq.w26_pradchg_26w_ann) w26_ann_ct
  , avg(sq.w26_pradchg_26w_ann) w26_pradchg_26w_ann
  , count(sq.w13_pradchg_13w_ann) w13_ann_ct
  , avg(sq.w13_pradchg_13w_ann) w13_pradchg_13w_ann
from
( select 
      to_timestamp(dateindex_ci*3600*24)::date start_date 
    , ticker_ci 
    , percent_rank() over (partition by dateindex_ci order by ( 
    (-1) * ( 
        coalesce(tcf_q1::numeric(15,2), 0.00)  + coalesce(tcf_q2::numeric(15,2), 0.00)   +
        coalesce(tcf_q3::numeric(15,2), 0.00)  + coalesce(tcf_q4::numeric(15,2), 0.00)  
                                                                                            )  /   
            nullif( mktcap::numeric(15,2), 0.00)  
      ) desc nulls last ) >= 0.99 not_tcf_over_mktcap_ratio 
    , w52_pradchg_52w_ann
    , w26_pradchg_26w_ann
    , w13_pradchg_13w_ann
  from sipro_data_store.si_finecon 
  where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq_ci is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
  -- and dateindex_ci in (16465,16555)
) sq group by cube(sq.start_date, not_tcf_over_mktcap_ratio);
-- < 0.10
-- 'f'  8.99
-- 't' 10.77

-- < 0.01
-- 'f' 9.10
-- 't' 9.45 ( GETS WORSE )

--  >= 0.90
-- 'f' 9.38
-- 't' 6.65 POORER COMPANIES HAVE 'LESS GOOD  RETURN'

--  >= 0.99
-- 'f' 9.18
-- 't' 1.81

-- VARIANT ( AAII FCFPS STYLE: MUCH BETER ANSWERS )

-- not_tcf_over_price_ratio
-- number of shares weighted 


select 
    sq.start_date
  , sq.not_tcf_over_price_ratio
  , count(sq.w52_pradchg_52w_ann) w52_ann_ct
  , avg(sq.w52_pradchg_52w_ann) w52_pradchg_52w_ann
  , count(sq.w26_pradchg_26w_ann) w26_ann_ct
  , avg(sq.w26_pradchg_26w_ann) w26_pradchg_26w_ann
  , count(sq.w13_pradchg_13w_ann) w13_ann_ct
  , avg(sq.w13_pradchg_13w_ann) w13_pradchg_13w_ann
from
( select 
      to_timestamp(dateindex_ci*3600*24)::date start_date 
    , ticker_ci 
    , percent_rank() over (partition by dateindex_ci order by ( 
    (-1) * ( 
        coalesce(tcf_q1::numeric(15,2), 0.00) * shr_aq1::numeric(15,2)  + coalesce(tcf_q2::numeric(15,2), 0.00) * shr_aq2::numeric(15,2)  +
        coalesce(tcf_q3::numeric(15,2), 0.00) * shr_aq3::numeric(15,2)  + coalesce(tcf_q4::numeric(15,2), 0.00) * shr_aq4::numeric(15,2) 
                                                                                            )  /   
            nullif( price::numeric(15,2), 0.00)  
      ) desc nulls last ) < 0.10 not_tcf_over_price_ratio
    , w52_pradchg_52w_ann
    , w26_pradchg_26w_ann
    , w13_pradchg_13w_ann
  from sipro_data_store.si_finecon 
  where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq_ci is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
  -- and dateindex_ci in (16465,16555)
) sq group by cube(sq.start_date, not_tcf_over_price_ratio);

-- < 0.10
-- 'f' 8.70
-- 't' 12.52

-- < 0.01
-- 'f'  9.05
-- 't' 13.18

--  >= 0.90
-- 'f' 9.91
-- 't' 0.46 ( AT 10%  -9 PERCENT USEFUL ) (*** SECOND BEST BAD RETURN AT 'WORSE '10%' ***)

--  >= 0.99
-- 'f'  9.14
-- 't' -2.72   CASH FR FINANCING COMPANIES DO TNO DO WELL


-- not_tcf_over_price_ratio_2q ( GENERALLY NEED ONLY 2 QUARTERS  )
                            -- ( BUT STILL 4 QUARTERS ARE 'A LITTLE BETTER AT FINDING THE LOOSERS )

select 
    sq.start_date
  , sq.not_tcf_over_price_ratio_2q
  , count(sq.w52_pradchg_52w_ann) w52_ann_ct
  , avg(sq.w52_pradchg_52w_ann) w52_pradchg_52w_ann
  , count(sq.w26_pradchg_26w_ann) w26_ann_ct
  , avg(sq.w26_pradchg_26w_ann) w26_pradchg_26w_ann
  , count(sq.w13_pradchg_13w_ann) w13_ann_ct
  , avg(sq.w13_pradchg_13w_ann) w13_pradchg_13w_ann
from
( select 
      to_timestamp(dateindex_ci*3600*24)::date start_date 
    , ticker_ci 
    , percent_rank() over (partition by dateindex_ci order by ( 
    (-1) * ( 
        coalesce(tcf_q1::numeric(15,2), 0.00) * shr_aq1::numeric(15,2)  + coalesce(tcf_q2::numeric(15,2), 0.00) * shr_aq2::numeric(15,2)   
                                                                                             )  /   
            nullif( price::numeric(15,2), 0.00)  
      ) desc nulls last ) >= 0.90 not_tcf_over_price_ratio_2q   
    , w52_pradchg_52w_ann
    , w26_pradchg_26w_ann
    , w13_pradchg_13w_ann
  from sipro_data_store.si_finecon 
  where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq_ci is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
  -- and dateindex_ci in (16465,16555)
) sq group by cube(sq.start_date, not_tcf_over_price_ratio_2q);

-- < 0.10
-- 'f'  8.74
-- 't' 12.17

-- < 0.01
-- 'f'  9.05
-- 't' 14.06

--  >= 0.90
-- 'f' 9.85
-- 't' 1.16

--  >= 0.99
-- 'f' 9.15 
-- 't' 0.23 



-- VARIANT ( multply instead of divide )

select 
    sq.start_date
  , sq.not_tcf_over_price_ratio
  , count(sq.w52_pradchg_52w_ann) w52_ann_ct
  , avg(sq.w52_pradchg_52w_ann) w52_pradchg_52w_ann
  , count(sq.w26_pradchg_26w_ann) w26_ann_ct
  , avg(sq.w26_pradchg_26w_ann) w26_pradchg_26w_ann
  , count(sq.w13_pradchg_13w_ann) w13_ann_ct
  , avg(sq.w13_pradchg_13w_ann) w13_pradchg_13w_ann
from
( select 
      to_timestamp(dateindex_ci*3600*24)::date start_date 
    , ticker_ci 
    , percent_rank() over (partition by dateindex_ci order by ( 
    (-1) * ( 
        coalesce(tcf_q1::numeric(15,2), 0.00) / shr_aq1::numeric(15,2)  + coalesce(tcf_q2::numeric(15,2), 0.00) / shr_aq2::numeric(15,2)  +
        coalesce(tcf_q3::numeric(15,2), 0.00) / shr_aq3::numeric(15,2)  + coalesce(tcf_q4::numeric(15,2), 0.00) / shr_aq4::numeric(15,2) 
                                                                                            )  /   
            nullif( price::numeric(15,2), 0.00)  
      ) desc nulls last ) >= 0.99 not_tcf_over_price_ratio
    , w52_pradchg_52w_ann
    , w26_pradchg_26w_ann
    , w13_pradchg_13w_ann
  from sipro_data_store.si_finecon 
  where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq_ci is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
  -- and dateindex_ci in (16465,16555)
) sq group by cube(sq.start_date, not_tcf_over_price_ratio);

-- < 0.10
-- 'f'  8.95
-- 't' 10.41 ( HUMP )

-- < 0.01
-- 'f' 9.11
-- 't' 7.5

--  >= 0.90
-- 'f' 9.7
-- 't' 2.3

--  >= 0.99
-- 'f' 9.15
-- 't' -4.73



-- operating_part_of_dual_cash_flow ( DIRECT f AAII )
-- 'does nothing alone'

select 
    sq.start_date
  , sq.operating_part_of_dual_cash_flow 
  , count(sq.w52_pradchg_52w_ann) w52_ann_ct
  , avg(sq.w52_pradchg_52w_ann) w52_pradchg_52w_ann
  , count(sq.w26_pradchg_26w_ann) w26_ann_ct
  , avg(sq.w26_pradchg_26w_ann) w26_pradchg_26w_ann
  , count(sq.w13_pradchg_13w_ann) w13_ann_ct
  , avg(sq.w13_pradchg_13w_ann) w13_pradchg_13w_ann
from
( select 
      to_timestamp(dateindex*3600*24)::date start_date 
    , ticker 
    , percent_rank() over (partition by dateindex order by ( 
          coalesce(dcfo_q1::numeric(15,2), 0.00)  
      ) desc nulls last ) >= 0.99 operating_part_of_dual_cash_flow 
    , w52_pradchg_52w_ann
    , w26_pradchg_26w_ann
    , w13_pradchg_13w_ann
  from sipro_data_store.si_finecon 
  where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
  -- and dateindex in (16465,16555)
) sq group by cube(sq.start_date, operating_part_of_dual_cash_flow);
-- < 0.10
-- 'f' 8.64
-- 't' 8.32

-- < 0.01
-- 'f' 8.61
-- 't' 8.61 SAME

--  >= 0.90
-- 'f' 8.84
-- 't' 6.59

--  >= 0.99
-- 'f' 8.67
-- 't' 2.57



-- Percent of Sales - balance_sheet_part_of_dual_cash_flow ( DIRECT f AAII )
-- dcfbs_q1 

select 
    sq.start_date
  , sq.balance_sheet_part_of_dual_cash_flow 
  , count(sq.w52_pradchg_52w_ann) w52_ann_ct
  , avg(sq.w52_pradchg_52w_ann) w52_pradchg_52w_ann
  , count(sq.w26_pradchg_26w_ann) w26_ann_ct
  , avg(sq.w26_pradchg_26w_ann) w26_pradchg_26w_ann
  , count(sq.w13_pradchg_13w_ann) w13_ann_ct
  , avg(sq.w13_pradchg_13w_ann) w13_pradchg_13w_ann
from
( select 
      to_timestamp(dateindex*3600*24)::date start_date 
    , ticker 
    , percent_rank() over (partition by dateindex order by ( 
          coalesce(dcfbs_q1::numeric(15,2), 0.00)  
      ) desc nulls last ) < 0.10 balance_sheet_part_of_dual_cash_flow
    , w52_pradchg_52w_ann
    , w26_pradchg_26w_ann
    , w13_pradchg_13w_ann
  from sipro_data_store.si_finecon 
  where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
  -- and dateindex in (16465,16555)
) sq group by cube(sq.start_date, balance_sheet_part_of_dual_cash_flow);
--
-- < 0.10
-- 'f' 8.66
-- 't' 8.15

-- < 0.01
-- 'f' 8.67
-- 't' 3.25  -- POORER PERFORMANCE AT THE TAILS

--  >= 0.90
-- 'f' 8.65
-- 't' 8.32

--  >= 0.99
-- 'f' 8.67
-- 't' 2.77  -- POORER PERFORMANCE AT THE TAILS


-- Percent of Sales - Dual Cash Flow (DCF)
-- The dual cash flow method seeks out companies with increasing cash flow from operations 
-- but falling cash from balance sheet changes. 
-- 
-- The model views the build-up of excess cash itself as the growth of an unproductive asset
-- 
-- dcf_q1 




-- Percent of Sales - Dual Cash Flow (DCF)
-- The dual cash flow method seeks out companies with increasing cash flow from operations 
-- but falling cash from balance sheet changes. 
-- 
-- The model views the build-up of excess cash itself as the growth of an unproductive asset
-- 
-- dcf_q1 ( DIRECT FROM AAII )
-- answer: 'no affect' ( DOES NOTHING )

select 
    sq.start_date
  , sq.dual_cash_flow 
  , count(sq.w52_pradchg_52w_ann) w52_ann_ct
  , avg(sq.w52_pradchg_52w_ann) w52_pradchg_52w_ann
  , count(sq.w26_pradchg_26w_ann) w26_ann_ct
  , avg(sq.w26_pradchg_26w_ann) w26_pradchg_26w_ann
  , count(sq.w13_pradchg_13w_ann) w13_ann_ct
  , avg(sq.w13_pradchg_13w_ann) w13_pradchg_13w_ann
from
( select 
      to_timestamp(dateindex*3600*24)::date start_date 
    , ticker 
    , percent_rank() over (partition by dateindex order by ( 
          coalesce(dcf_q1::numeric(15,2), 0.00)  
      ) desc nulls last ) >= 0.90 dual_cash_flow
    , w52_pradchg_52w_ann
    , w26_pradchg_26w_ann
    , w13_pradchg_13w_ann
  from sipro_data_store.si_finecon 
  where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
  -- and dateindex in (16465,16555)
) sq group by cube(sq.start_date, dual_cash_flow);
--
-- < 0.10
-- 'f' 8.68
-- 't' 8.02

-- < 0.01
-- 'f' 8.61
-- 't' 8.51

--  >= 0.90
-- 'f' 8.74
-- 't' 7.52

--  >= 0.99
-- 'f' 8.74
-- 't' 7.52




-- book_value_over_price_ratio (

select 
    sq.start_date
  , sq.book_over_price_ratio
  , avg(sq.w52_pradchg_52w_ann) w52_pradchg_52w_ann
  , avg(sq.w26_pradchg_26w_ann) w26_pradchg_26w_ann
  , avg(sq.w13_pradchg_13w_ann) w13_pradchg_13w_ann
from
( select 
      to_timestamp(dateindex_ci*3600*24)::date start_date 
    , ticker_ci 
    , percent_rank() over (partition by dateindex_ci order by ( 
        equity_q1::numeric(15,2) / nullif( shr_aq1::numeric(15,2), 0.00) / 
            nullif( price::numeric(15,2), 0.00)  
      ) desc nulls last ) < 0.10 book_over_price_ratio  
    , w52_pradchg_52w_ann
    , w26_pradchg_26w_ann
    , w13_pradchg_13w_ann
  from sipro_data_store.si_finecon 
  where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq_ci is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
  -- and dateindex_ci in (16465,16555)
) sq group by cube(sq.start_date, book_over_price_ratio);


-- LONG TERM: -3 PERCENT BETTER 
-- 'f' 9.39
-- 't' 6.55
-- SHORTEST TERM +60 PERCENT
-- SHORT TERM: +17 PERCENT               
-- LONGER THAN SHORT TERM: -3  PERCENT 
-- LONGER THAN 'LONGER THAT SHORT TERM' +7 PERCENT 




-- book_value_over_price_ratio ( no ci_ )

select 
    sq.start_date
  , sq.book_over_price_ratio
  , count(sq.w52_pradchg_52w_ann) w52_ann_ct
  , avg(sq.w52_pradchg_52w_ann) w52_pradchg_52w_ann
  , count(sq.w26_pradchg_26w_ann) w26_ann_ct
  , avg(sq.w26_pradchg_26w_ann) w26_pradchg_26w_ann
  , count(sq.w13_pradchg_13w_ann) w13_ann_ct
  , avg(sq.w13_pradchg_13w_ann) w13_pradchg_13w_ann
from
( select 
      to_timestamp(dateindex*3600*24)::date start_date 
    , ticker 
    , percent_rank() over (partition by dateindex order by ( 
        equity_q1::numeric(15,2) / nullif( shr_aq1::numeric(15,2), 0.00) / 
            nullif( price::numeric(15,2), 0.00)  
      ) desc nulls last ) >= 0.90 book_over_price_ratio  
    , w52_pradchg_52w_ann
    , w26_pradchg_26w_ann
    , w13_pradchg_13w_ann
  from sipro_data_store.si_finecon 
  where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
  -- and dateindex in (16465,16555)
) sq group by cube(sq.start_date, book_over_price_ratio);
--
-- < 0.10
-- 'f' 8.09
-- 't' 6.08

-- < 0.01
-- 'f'  8.75
-- 't' -4.19  -- BAD AT THE EXTEMES

--  >= 0.90
-- 'f' 8.99
-- 't' 4.64

--  >= 0.99
-- 'f'  8.68
-- 't' -3.23 -- BAD AT THE EXTREMES


-- ANOTHER WAY


select 
    sq.start_date
  , sq.book_over_price_ratio
  , avg(sq.w52_pradchg_52w_ann) w52_pradchg_52w_ann
  , avg(sq.w26_pradchg_26w_ann) w26_pradchg_26w_ann
  , avg(sq.w13_pradchg_13w_ann) w13_pradchg_13w_ann
from
( select 
      to_timestamp(dateindex_ci*3600*24)::date start_date 
    , ticker_ci 
    , percent_rank() over (partition by dateindex_ci order by ( 
        equity_q1::numeric(15,2)  / 
            nullif( mktcap::numeric(15,2), 0.00)  
      ) desc nulls last ) < 0.10 book_over_price_ratio  
    , w52_pradchg_52w_ann
    , w26_pradchg_26w_ann
    , w13_pradchg_13w_ann
  from sipro_data_store.si_finecon 
  where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq_ci is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
  -- and dateindex_ci in (16465,16555)
) sq group by cube(sq.start_date, book_over_price_ratio);
-- LONG TERM: -3  PERCENT BETTER 
-- 'f' 9.36
-- 't' 6.78
-- SHORTEST TERM +60 PERCENT
-- SHORT TERM: +17 PERCENT               
-- LONGER THAN SHORT TERM: -3  PERCENT 
-- LONGER THAN 'LONGER THAT SHORT TERM' -7  PERCENT 


-- free_cash_over_ent_val_ratio 

select 
    sq.start_date
  , sq.free_cash_over_ent_val_ratio
  , avg(sq.w52_pradchg_52w_ann) w52_pradchg_52w_ann
  , avg(sq.w26_pradchg_26w_ann) w26_pradchg_26w_ann
  , avg(sq.w13_pradchg_13w_ann) w13_pradchg_13w_ann
from
( select 
      to_timestamp(dateindex_ci*3600*24)::date start_date 
    , ticker_ci 
    , percent_rank() over (partition by dateindex_ci order by ( 
      ( coalesce(fcfps_q1::numeric(15,2), 0.00) * shr_aq1::numeric(15,2) + 
        coalesce(fcfps_q2::numeric(15,2), 0.00) * shr_aq2::numeric(15,2) + 
        coalesce(fcfps_q3::numeric(15,2), 0.00) * shr_aq3::numeric(15,2) + 
        coalesce(fcfps_q4::numeric(15,2), 0.00) * shr_aq4::numeric(15,2) )  / 
          nullif( entval_q1::numeric(15,2), 0.00)  
      ) desc nulls last ) < 0.10 free_cash_over_ent_val_ratio 
    , w52_pradchg_52w_ann
    , w26_pradchg_26w_ann
    , w13_pradchg_13w_ann
  from sipro_data_store.si_finecon 
  where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq_ci is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
  -- and dateindex_ci in (16465,16555)
) sq group by cube(sq.start_date, free_cash_over_ent_val_ratio);
-- LONG TERM: -2.3  PERCENT BETTER 
-- 'f' 10.07
-- 't' 7.7
-- SHORTEST TERM  -8 PERCENT
-- SHORT TERM: +2  PERCENT               
-- LONGER THAN SHORT TERM: +4   PERCENT 
-- LONGER THAN 'LONGER THAT SHORT TERM' -3 PERCENT 



-- free_cash_over_ent_val_ratio ( no ci_ )

select 
    sq.start_date
  , sq.free_cash_over_ent_val_ratio
  , count(sq.w52_pradchg_52w_ann) w52_ann_ct
  , avg(sq.w52_pradchg_52w_ann) w52_pradchg_52w_ann
  , count(sq.w26_pradchg_26w_ann) w26_ann_ct
  , avg(sq.w26_pradchg_26w_ann) w26_pradchg_26w_ann
  , count(sq.w13_pradchg_13w_ann) w13_ann_ct
  , avg(sq.w13_pradchg_13w_ann) w13_pradchg_13w_ann
from
( select 
      to_timestamp(dateindex*3600*24)::date start_date 
    , ticker 
    , percent_rank() over (partition by dateindex order by ( 
      ( coalesce(fcfps_q1::numeric(15,2), 0.00) * shr_aq1::numeric(15,2) + 
        coalesce(fcfps_q2::numeric(15,2), 0.00) * shr_aq2::numeric(15,2) + 
        coalesce(fcfps_q3::numeric(15,2), 0.00) * shr_aq3::numeric(15,2) + 
        coalesce(fcfps_q4::numeric(15,2), 0.00) * shr_aq4::numeric(15,2) )  / 
          nullif( entval_q1::numeric(15,2), 0.00)  
      ) desc nulls last ) >= 0.99 free_cash_over_ent_val_ratio 
    , w52_pradchg_52w_ann
    , w26_pradchg_26w_ann
    , w13_pradchg_13w_ann
  from sipro_data_store.si_finecon 
  where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
  -- and dateindex in (16465,16555)
) sq group by cube(sq.start_date, free_cash_over_ent_val_ratio);
--
-- < 0.10
-- 'f' 9.29
-- 't' 7.69

-- < 0.01
-- 'f' 9.61
-- 't' 6.80

--  >= 0.90
-- 'f'  9.25
-- 't' -2.68

--  >= 0.99
-- 'f' 8.65
-- 't' -8.00



-- ebitda_over_entval_ratio

select 
    sq.start_date
  , sq.ebitda_over_entval_ratio
  , avg(sq.w52_pradchg_52w_ann) w52_pradchg_52w_ann
  , avg(sq.w26_pradchg_26w_ann) w26_pradchg_26w_ann
  , avg(sq.w13_pradchg_13w_ann) w13_pradchg_13w_ann
from
( select 
      to_timestamp(dateindex_ci*3600*24)::date start_date 
    , ticker_ci 
    , percent_rank() over (partition by dateindex_ci order by ( 
      ( coalesce(ebit_q1::numeric(15,2), 0.00) + coalesce( dep_cf_q1::numeric(15,2), 0.00) + 
        coalesce(ebit_q2::numeric(15,2), 0.00) + coalesce( dep_cf_q1::numeric(15,2), 0.00) + 
        coalesce(ebit_q3::numeric(15,2), 0.00) + coalesce( dep_cf_q1::numeric(15,2), 0.00) + 
        coalesce(ebit_q4::numeric(15,2), 0.00) + coalesce( dep_cf_q1::numeric(15,2), 0.00)   )  / 
          nullif( entval_q1::numeric(15,2), 0.00)  
      ) desc nulls last ) < 0.10 ebitda_over_entval_ratio  
    , w52_pradchg_52w_ann
    , w26_pradchg_26w_ann
    , w13_pradchg_13w_ann
  from sipro_data_store.si_finecon 
  where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq_ci is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
  -- and dateindex_ci in (16465,16555)
) sq group by cube(sq.start_date, ebitda_over_entval_ratio);
-- LONG TERM: -3  PERCENT BETTER 
-- 'f' 10.56
-- 't'  7.07
-- SHORTEST TERM -10  PERCENT
-- SHORT TERM: + 10  PERCENT               
-- LONGER THAN SHORT TERM: -3 PERCENT 
-- LONGER THAN 'LONGER THAT SHORT TERM' +8 PERCENT 


-- shareholder_yield_percent

select 
    sq.start_date
  , sq.shareholder_yield_percent
  , avg(sq.w52_pradchg_52w_ann) w52_pradchg_52w_ann
  , avg(sq.w26_pradchg_26w_ann) w26_pradchg_26w_ann
  , avg(sq.w13_pradchg_13w_ann) w13_pradchg_13w_ann
from
( select 
      to_timestamp(dateindex_ci*3600*24)::date start_date 
    , ticker_ci 
    , percent_rank() over (partition by dateindex_ci order by ( 
        shy::numeric(15,2) 
      ) desc nulls last ) < 0.10 shareholder_yield_percent  
    , w52_pradchg_52w_ann
    , w26_pradchg_26w_ann
    , w13_pradchg_13w_ann
  from sipro_data_store.si_finecon 
  where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq_ci is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
  -- and dateindex_ci in (16465,16555)
) sq group by cube(sq.start_date, shareholder_yield_percent);
-- LONG TERM: -3  PERCENT BETTER 
-- 'f' 10.47
-- 't'  7.25
-- SHORTEST TERM + 7  PERCENT
-- SHORT TERM: + 15  PERCENT               
-- LONGER THAN SHORT TERM: -2 PERCENT 
-- LONGER THAN 'LONGER THAT SHORT TERM' 0 PERCENT 

-- < 0.01
-- 'f' 10.49
-- 't'  6.70

-- >= 0.90  -- JUST WEIRD
-- 'f' 9.46
-- 't' 2.11 ( DO MUCH WORSE GOING AFTER THE *HIGH DIVIDEND* COMPANIES )


----- J_OSAM earnings quality values ---------------

-- net_pct_change_in_operating_assets


select 
    sq.start_date
  , sq.net_pct_change_in_operating_assets
  , avg(sq.w52_pradchg_52w_ann) w52_pradchg_52w_ann
  , avg(sq.w26_pradchg_26w_ann) w26_pradchg_26w_ann
  , avg(sq.w13_pradchg_13w_ann) w13_pradchg_13w_ann
from
( select 
      to_timestamp(dateindex_ci*3600*24)::date start_date 
    , ticker_ci 
    , percent_rank() over (partition by dateindex_ci order by ( 
     ( (  ( tco_q1::numeric(15,2) + tco_q2::numeric(15,2) + tco_q3::numeric(15,2) + tco_q4::numeric(15,2) )  -  
          ( tcf_q1::numeric(15,2) + tcf_q2::numeric(15,2) + tcf_q3::numeric(15,2) + tcf_q4::numeric(15,2) )  -  
          ( tci_q1::numeric(15,2) + tci_q2::numeric(15,2) + tci_q3::numeric(15,2) + tci_q4::numeric(15,2) )  ) - 
       (  ( tco_q5::numeric(15,2) + tco_q6::numeric(15,2) + tco_q7::numeric(15,2) + tco_q8::numeric(15,2) )  -  
          ( tcf_q5::numeric(15,2) + tcf_q6::numeric(15,2) + tcf_q7::numeric(15,2) + tcf_q8::numeric(15,2) )  -  
          ( tci_q5::numeric(15,2) + tci_q6::numeric(15,2) + tci_q7::numeric(15,2) + tci_q8::numeric(15,2) )  ) ) / 
              nullif( abs(  ( tco_q5::numeric(15,2) + tco_q6::numeric(15,2) + tco_q7::numeric(15,2) + tco_q8::numeric(15,2) )  -  
                            ( tcf_q5::numeric(15,2) + tcf_q6::numeric(15,2) + tcf_q7::numeric(15,2) + tcf_q8::numeric(15,2) )  -  
                            ( tci_q5::numeric(15,2) + tci_q6::numeric(15,2) + tci_q7::numeric(15,2) + tci_q8::numeric(15,2) )  ), 0.00) * 100
      ) desc nulls last ) < 0.10 net_pct_change_in_operating_assets  
    , w52_pradchg_52w_ann
    , w26_pradchg_26w_ann
    , w13_pradchg_13w_ann
  from sipro_data_store.si_finecon 
  where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq_ci is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
  -- and dateindex_ci in (16465,16555)
) sq group by cube(sq.start_date, net_pct_change_in_operating_assets);
-- LONG TERM: 0  PERCENT BETTER 
-- 'f' 9.14
-- 't' 8.77
-- SHORTEST TERM  1 PERCENT
-- SHORT TERM: -5  PERCENT               
-- LONGER THAN SHORT TERM:  -3  PERCENT 
-- LONGER THAN 'LONGER THAT SHORT TERM' -1 PERCENT 



-- DIFFERENT operating_assets_over_invest_a_financing

select 
    sq.start_date
  , sq.operating_assets_over_invest_a_financing
  , avg(sq.w52_pradchg_52w_ann) w52_pradchg_52w_ann
  , avg(sq.w26_pradchg_26w_ann) w26_pradchg_26w_ann
  , avg(sq.w13_pradchg_13w_ann) w13_pradchg_13w_ann
from
( select 
      to_timestamp(dateindex_ci*3600*24)::date start_date 
    , ticker_ci 
    , percent_rank() over (partition by dateindex_ci order by ( 
          ( coalesce(tco_q1::numeric(15,2), 0.00) + coalesce(tco_q2::numeric(15,2), 0.00) + coalesce(tco_q3::numeric(15,2), 0.00) + coalesce(tco_q4::numeric(15,2), 0.00) )  / 
            nullif( ( coalesce(tcf_q1::numeric(15,2), 0.00) + coalesce(tcf_q2::numeric(15,2), 0.00) + coalesce(tcf_q3::numeric(15,2), 0.00) + coalesce(tcf_q4::numeric(15,2), 0.00)  +  
              coalesce(tci_q1::numeric(15,2), 0.00) + coalesce(tci_q2::numeric(15,2), 0.00) + coalesce(tci_q3::numeric(15,2), 0.00) + coalesce(tci_q4::numeric(15,2) + 0.01, 0.00) ), 0.00)  
      ) desc nulls last ) < 0.10 operating_assets_over_invest_a_financing  
    , w52_pradchg_52w_ann
    , w26_pradchg_26w_ann
    , w13_pradchg_13w_ann
  from sipro_data_store.si_finecon 
  where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq_ci is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
  -- and dateindex_ci in (16465,16555)
) sq group by cube(sq.start_date, operating_assets_over_invest_a_financing);

-- LONG TERM: -2  PERCENT BETTER 
-- 'f' 9.28
-- 't' 7.45
-- SHORTEST TERM -5  PERCENT
-- SHORT TERM: -4  PERCENT               
-- LONGER THAN SHORT TERM: -4  PERCENT 
-- LONGER THAN 'LONGER THAT SHORT TERM' -4 PERCENT 



-- pct_change_in_total_accruals_over_total_assets

select 
    sq.start_date
  , sq.pct_change_in_total_accruals_over_total_assets
  , avg(sq.w52_pradchg_52w_ann) w52_pradchg_52w_ann
  , avg(sq.w26_pradchg_26w_ann) w26_pradchg_26w_ann
  , avg(sq.w13_pradchg_13w_ann) w13_pradchg_13w_ann
from
( select 
      to_timestamp(dateindex_ci*3600*24)::date start_date 
    , ticker_ci 
    , percent_rank() over (partition by dateindex_ci order by ( 
    (-1.0) * (  ( (coalesce(work_q1::numeric(15,2), 0.00) - coalesce(cash_q1::numeric(15,2), 0.00) ) / nullif( ( coalesce(assets_q1::numeric(15,2), 0.00)  ), 0.00) )  - ( ( coalesce(work_q5::numeric(15,2), 0.00) - coalesce(cash_q5::numeric(15,2), 0.00) ) / nullif( ( coalesce(assets_q5::numeric(15,2), 0.00)  ), 0.00) )  ) / 
                     nullif( abs( ( ( coalesce(liab_q5::numeric(15,2), 0.00) - coalesce(cash_q5::numeric(15,2), 0.00)  ) /  nullif( ( coalesce(assets_q5::numeric(15,2), 0.00)  ), 0.00) )  ), 0.00) * 100.0
      ) desc nulls last ) < 0.10 pct_change_in_total_accruals_over_total_assets  
    , w52_pradchg_52w_ann
    , w26_pradchg_26w_ann
    , w13_pradchg_13w_ann
  from sipro_data_store.si_finecon 
  where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq_ci is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
  -- and dateindex_ci in (16465,16555)
) sq group by cube(sq.start_date, pct_change_in_total_accruals_over_total_assets);
-- LONG TERM: -1.5 PERCENT BETTER 
-- 'f' 9.26
-- 't' 7.77
-- SHORTEST TERM -10  PERCENT
-- SHORT TERM: -24  PERCENT               
-- LONGER THAN SHORT TERM: -5 PERCENT 
-- LONGER THAN 'LONGER THAT SHORT TERM' -3  PERCENT 

-- pct_change_in_current_accruals_over_total_assets


select 
    sq.start_date
  , sq.pct_change_in_current_accruals_over_total_assets
  , avg(sq.w52_pradchg_52w_ann) w52_pradchg_52w_ann
  , avg(sq.w26_pradchg_26w_ann) w26_pradchg_26w_ann
  , avg(sq.w13_pradchg_13w_ann) w13_pradchg_13w_ann
from
( select 
      to_timestamp(dateindex_ci*3600*24)::date start_date 
    , ticker_ci 
    , percent_rank() over (partition by dateindex_ci order by ( 
      (-1.0) * ( ( ( coalesce(ap_q1::numeric(15,2), 0.00) - (coalesce(tco_q1::numeric(15,2), 0.00)  - coalesce(netinc_q1::numeric(15,2), 0.00)) 
                                                        - (coalesce(tco_q2::numeric(15,2), 0.00)  - coalesce(netinc_q2::numeric(15,2), 0.00)) 
                                                        - (coalesce(tco_q3::numeric(15,2), 0.00)  - coalesce(netinc_q3::numeric(15,2), 0.00)) 
                                                        - (coalesce(tco_q4::numeric(15,2), 0.00)  - coalesce(netinc_q4::numeric(15,2), 0.00)) ) /  nullif( coalesce(assets_q1::numeric(15,2), 0.00), 0.00)  ) 
               - ( ( coalesce(ap_q5::numeric(15,2), 0.00) - (coalesce(tco_q5::numeric(15,2), 0.00)  - coalesce(netinc_q5::numeric(15,2), 0.00)) 
                                                        - (coalesce(tco_q6::numeric(15,2), 0.00)  - coalesce(netinc_q6::numeric(15,2), 0.00)) 
                                                        - (coalesce(tco_q7::numeric(15,2), 0.00)  - coalesce(netinc_q7::numeric(15,2), 0.00)) 
                                                        - (coalesce(tco_q8::numeric(15,2), 0.00)  - coalesce(netinc_q8::numeric(15,2), 0.00)) ) /  nullif( coalesce(assets_q5::numeric(15,2), 0.00), 0.00)  ) ) /  
                   nullif( abs( ( coalesce(ap_q5::numeric(15,2), 0.00) - (coalesce(tco_q5::numeric(15,2), 0.00)  - coalesce(netinc_q5::numeric(15,2), 0.00)) 
                                               - (coalesce(tco_q6::numeric(15,2), 0.00)  - coalesce(netinc_q6::numeric(15,2), 0.00)) 
                                               - (coalesce(tco_q7::numeric(15,2), 0.00)  - coalesce(netinc_q7::numeric(15,2), 0.00)) 
                                               - (coalesce(tco_q8::numeric(15,2), 0.00)  - coalesce(netinc_q8::numeric(15,2), 0.00))  ) /  nullif( coalesce(assets_q5::numeric(15,2), 0.00), 0.00)  ), 0.00) * 100
      ) desc nulls last ) < 0.10 pct_change_in_current_accruals_over_total_assets  
    , w52_pradchg_52w_ann
    , w26_pradchg_26w_ann
    , w13_pradchg_13w_ann
  from sipro_data_store.si_finecon 
  where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq_ci is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
  -- and dateindex_ci in (16465,16555)
) sq group by cube(sq.start_date, pct_change_in_current_accruals_over_total_assets);
-- LONG TERM: - 1.5  PERCENT BETTER 
-- 'f' 9.24
-- 't' 7.87
-- SHORTEST TERM +30  PERCENT
-- SHORT TERM: 0  PERCENT               
-- LONGER THAN SHORT TERM:  -4  PERCENT 
-- LONGER THAN 'LONGER THAT SHORT TERM'-4 PERCENT 

-- 


-- depreciation_expense_over_captital_expenditures

select 
    sq.start_date
  , sq.depreciation_expense_over_captital_expenditures
  , avg(sq.w52_pradchg_52w_ann) w52_pradchg_52w_ann
  , avg(sq.w26_pradchg_26w_ann) w26_pradchg_26w_ann
  , avg(sq.w13_pradchg_13w_ann) w13_pradchg_13w_ann
from
( select 
      to_timestamp(dateindex_ci*3600*24)::date start_date 
    , ticker_ci 
    , percent_rank() over (partition by dateindex_ci order by ( 
      ( coalesce(dep_q1::numeric(15,2), 0.00) + coalesce(dep_q2::numeric(15,2), 0.00) + coalesce(dep_q3::numeric(15,2), 0.00) + coalesce(dep_q4::numeric(15,2), 0.00) ) / 
         nullif( ( coalesce(ce_q1::numeric(15,2), 0.00) + coalesce(ce_q2::numeric(15,2), 0.00) + coalesce(ce_q3::numeric(15,2), 0.00) + coalesce(ce_q4::numeric(15,2), 0.00) + 0.01 ), 0.00)
      ) desc nulls last ) < 0.10 depreciation_expense_over_captital_expenditures  
    , w52_pradchg_52w_ann
    , w26_pradchg_26w_ann
    , w13_pradchg_13w_ann
  from sipro_data_store.si_finecon 
  where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq_ci is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
  -- and dateindex_ci in (16465,16555)
) sq group by cube(sq.start_date, depreciation_expense_over_captital_expenditures);
-- LONG TERM: 1.5 PERCENT BETTER 
-- 'f' 8.96
-- 't' 10.34
-- SHORTEST TERM  +8 PERCENT
-- SHORT TERM: + 11 PERCENT               
-- LONGER THAN SHORT TERM: -1 PERCENT 
-- LONGER THAN 'LONGER THAT SHORT TERM' +4 PERCENT ( SUCH A 'NON-VOLITILE )

-- < 0.01
-- 'f' 9.10
-- 't' 9.12


--cash_f_ops_less_ni_over_market == ALSO =  mill_earnings_quality
-- OSAM_DEFENSE

select 
    sq.start_date
  , sq.cash_f_ops_less_ni_over_market
  , avg(sq.w52_pradchg_52w_ann) w52_pradchg_52w_ann
  , avg(sq.w26_pradchg_26w_ann) w26_pradchg_26w_ann
  , avg(sq.w13_pradchg_13w_ann) w13_pradchg_13w_ann
from
( select 
      to_timestamp(dateindex_ci*3600*24)::date start_date 
    , ticker_ci 
    , percent_rank() over (partition by dateindex_ci order by ( 
      ( ( coalesce(tco_q1::numeric(15,2), 0.00) + coalesce(tco_q2::numeric(15,2), 0.00) + coalesce(tco_q3::numeric(15,2), 0.00) + coalesce(tco_q4::numeric(15,2), 0.00) ) - 
        ( coalesce(netinc_q1::numeric(15,2), 0.00) + coalesce(netinc_q2::numeric(15,2), 0.00) + coalesce(netinc_q3::numeric(15,2), 0.00) + coalesce(netinc_q4::numeric(15,2), 0.00) ) ) / 
             nullif( mktcap::numeric(15,2), 0.00)
      ) desc nulls last ) < 0.10 cash_f_ops_less_ni_over_market  
    , w52_pradchg_52w_ann
    , w26_pradchg_26w_ann
    , w13_pradchg_13w_ann
  from sipro_data_store.si_finecon 
  where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq_ci is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
  -- and dateindex_ci in (16465,16555)
) sq group by cube(sq.start_date, cash_f_ops_less_ni_over_market);
-- LONG TERM: - 4.25 PERCENT BETTER
-- 'f' 9.5
-- 't' 5.29
-- SHORTEST TERM +85 PERCENT
-- SHORT TERM: +21 PERCENT               
-- LONGER THAN SHORT TERM: -10 PERCENT 
-- LONGER THAN 'LONGER THAT SHORT TERM' -7 PERCENT 

-- < 0.01
-- 'f'  9.20
-- 't' -1.13

-- < 0.005
-- 'f'  9.16
-- 't' -1.85

-- >= 0.90
-- 'f' 9.22
-- 't' 7.97

-- >= 0.995
-- 'f' 9.09
-- 't' 10.14

----- J_OSAM financialstrength ---------------

-- pct_change_debt

select 
    sq.start_date
  , sq.pct_change_debt
  , avg(sq.w52_pradchg_52w_ann) w52_pradchg_52w_ann
  , avg(sq.w26_pradchg_26w_ann) w26_pradchg_26w_ann
  , avg(sq.w13_pradchg_13w_ann) w13_pradchg_13w_ann
from
( select 
      to_timestamp(dateindex_ci*3600*24)::date start_date 
    , ticker_ci 
    , percent_rank() over (partition by dateindex_ci order by ( 
      (-1.0) *( liab_q1::numeric(15,2) - liab_q5::numeric(15,2) ) /  
        nullif( abs(liab_q5::numeric(15,2)), 0.00) * 100.0
      ) desc nulls last ) < 0.10 pct_change_debt  
    , w52_pradchg_52w_ann
    , w26_pradchg_26w_ann
    , w13_pradchg_13w_ann
  from sipro_data_store.si_finecon 
  where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq_ci is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
  -- and dateindex_ci in (16465,16555)
) sq group by cube(sq.start_date, pct_change_debt);
-- LONG TERM: -2 PERCENT BETTER
-- 'f' 9.32
-- 't' 7.112
-- SHORTEST TERM +30 PERCENT
-- SHORT TERM: -13 PERCENT               
-- LONGER THAN SHORT TERM:  -3 PERCENT 
-- LONGER THAN 'LONGER THAT SHORT TERM' -3 PERCENT 
--  < 0.01
-- 'f' 6.17
-- 't' 9.13

-- VARIANT debt_over_assets ( ALSO SEE BELOW debt_over_equity )

select 
    sq.start_date
  , sq.debt_over_assets
  , avg(sq.w52_pradchg_52w_ann) w52_pradchg_52w_ann
  , avg(sq.w26_pradchg_26w_ann) w26_pradchg_26w_ann
  , avg(sq.w13_pradchg_13w_ann) w13_pradchg_13w_ann
from
( select 
      to_timestamp(dateindex*3600*24)::date start_date 
    , ticker 
    , percent_rank() over (partition by dateindex order by ( 
      (-1.0) * liab_q1::numeric(15,2) /  nullif( abs(assets_q1::numeric(15,2)), 0.00) * 100.00
      ) desc nulls last ) < 0.10 debt_over_assets  
    , w52_pradchg_52w_ann
    , w26_pradchg_26w_ann
    , w13_pradchg_13w_ann
  from sipro_data_store.si_finecon 
  where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
  -- and dateindex_ci in (16465,16555)
) sq group by cube(sq.start_date, debt_over_assets);
-- LONG TERM: -6.3 PERCENT BETTER ( I HAVE SEEN THIS BEFORE )
-- 'f' 9.6
-- 't' 3.9
-- SHORTEST TERM -5 PERCENT
-- SHORT TERM: -40 PERCENT               
-- LONGER THAN SHORT TERM: -11 PERCENT 
-- LONGER THAN 'LONGER THAT SHORT TERM' -7 PERCENT 




-- debt_over_equity ( almost the same as debt over assets - ABOVE )

select 
    sq.start_date
  , sq.debt_over_equity
  , avg(sq.w52_pradchg_52w_ann) w52_pradchg_52w_ann
  , avg(sq.w26_pradchg_26w_ann) w26_pradchg_26w_ann
  , avg(sq.w13_pradchg_13w_ann) w13_pradchg_13w_ann
from
( select 
      to_timestamp(dateindex_ci*3600*24)::date start_date 
    , ticker_ci 
    , percent_rank() over (partition by dateindex_ci order by ( 
      (-1.0) * liab_q1::numeric(15,2) /  nullif( abs(equity_q1::numeric(15,2)), 0.00) * 100.00
      ) desc nulls last )   >= 0.90 debt_over_equity 
    , w52_pradchg_52w_ann
    , w26_pradchg_26w_ann
    , w13_pradchg_13w_ann
  from sipro_data_store.si_finecon 
  where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq_ci is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
  -- and dateindex_ci in (16465,16555)
) sq group by cube(sq.start_date, debt_over_equity);
-- LONG TERM: -6 PERCENT BETTER
-- 'f' 9.62
-- 't' 3.96
-- SHORTEST TERM -11 PERCENT
-- SHORT TERM: - 40 PERCENT               
-- LONGER THAN SHORT TERM: -14  PERCENT 
-- LONGER THAN 'LONGER THAT SHORT TERM' -5 PERCENT 
-- < 0.01 
-- 'f' 9.16
-- 't' 1.84

-- >= 0.90
-- 'f' 9.26
-- 't' 7.38


-- financing_cash_flow_over_assets

select 
    sq.start_date
  , sq.financing_cash_flow_over_assets
  , avg(sq.w52_pradchg_52w_ann) w52_pradchg_52w_ann
  , avg(sq.w26_pradchg_26w_ann) w26_pradchg_26w_ann
  , avg(sq.w13_pradchg_13w_ann) w13_pradchg_13w_ann
from
( select 
      to_timestamp(dateindex_ci*3600*24)::date start_date 
    , ticker_ci 
    , percent_rank() over (partition by dateindex_ci order by ( 
    (-1) * ( coalesce(tcf_q1::numeric(15,2), 0.00) + coalesce(tcf_q2::numeric(15,2), 0.00) + coalesce(tcf_q3::numeric(15,2), 0.00) + coalesce(tcf_q4::numeric(15,2), 0.00) ) / 
        nullif( abs(assets_q1::numeric(15,2)), 0.00) * 100.0
      ) desc nulls last ) < 0.10 financing_cash_flow_over_assets  
    , w52_pradchg_52w_ann
    , w26_pradchg_26w_ann
    , w13_pradchg_13w_ann
  from sipro_data_store.si_finecon 
  where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq_ci is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
  -- and dateindex_ci in (16465,16555)
) sq group by cube(sq.start_date, financing_cash_flow_over_assets);
-- LONG TERM: 0 PERCENT BETTER
-- 'f' 9.10
-- 't' 9.07
-- SHORTEST TERM -10 PERCENT
-- SHORT TERM: + 20 PERCENT               
-- LONGER THAN SHORT TERM: +5 PERCENT 
-- LONGER THAN 'LONGER THAT SHORT TERM' -1 PERCENT 


-- VARIANT financing_cash_flow_over_assets: REMOVE "(-1)"
--( OPPOSTITE END OF THE SPECTRUM )

select 
    sq.start_date
  , sq.financing_cash_flow_over_assets
  , avg(sq.w52_pradchg_52w_ann) w52_pradchg_52w_ann
  , avg(sq.w26_pradchg_26w_ann) w26_pradchg_26w_ann
  , avg(sq.w13_pradchg_13w_ann) w13_pradchg_13w_ann
from
( select 
      to_timestamp(dateindex_ci*3600*24)::date start_date 
    , ticker_ci 
    , percent_rank() over (partition by dateindex_ci order by ( 
           ( coalesce(tcf_q1::numeric(15,2), 0.00) + coalesce(tcf_q2::numeric(15,2), 0.00) + coalesce(tcf_q3::numeric(15,2), 0.00) + coalesce(tcf_q4::numeric(15,2), 0.00) ) / 
        nullif( abs(assets_q1::numeric(15,2)), 0.00) * 100.0
      ) desc nulls last ) < 0.10 financing_cash_flow_over_assets  
    , w52_pradchg_52w_ann
    , w26_pradchg_26w_ann
    , w13_pradchg_13w_ann
  from sipro_data_store.si_finecon 
  where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq_ci is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
  -- and dateindex_ci in (16465,16555)
) sq group by cube(sq.start_date, financing_cash_flow_over_assets);
-- LONG TERM: -5  PERCENT BETTER
-- 'f' 9.58
-- 't' 4.76  
-- SHORTEST TERM -13 PERCENT
-- SHORT TERM: -80  PERCENT               
-- LONGER THAN SHORT TERM: -32 PERCENT 
-- LONGER THAN 'LONGER THAT SHORT TERM' -5 PERCENT 

-------

-- net_cash_flow_over_debt ( no _ci )

explain
select 
    sq.start_date
  , sq.net_cash_flow_over_debt
  , avg(sq.w52_pradchg_52w_ann) w52_pradchg_52w_ann
  , avg(sq.w26_pradchg_26w_ann) w26_pradchg_26w_ann
  , avg(sq.w13_pradchg_13w_ann) w13_pradchg_13w_ann
from
( select 
      to_timestamp(dateindex*3600*24)::date start_date 
    , ticker 
    , percent_rank() over (partition by dateindex order by ( 
           ( coalesce(ncc_q1::numeric(15,2), 0.00) + coalesce(ncc_q2::numeric(15,2), 0.00) + coalesce(ncc_q3::numeric(15,2), 0.00) + coalesce(ncc_q4::numeric(15,2), 0.00) ) / 
        nullif( abs(liab_q1::numeric(15,2)), 0.00) * 100.0
      ) desc nulls last ) >= 0.995 net_cash_flow_over_debt  
    , w52_pradchg_52w_ann
    , w26_pradchg_26w_ann
    , w13_pradchg_13w_ann
  from sipro_data_store.si_finecon 
  where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
  -- and dateindex in (16465,16555)
) sq group by cube(sq.start_date, net_cash_flow_over_debt);


-- LONG TERM:    PERCENT BETTER
-- < 0.10
-- 'f' 8.9
-- 't' 5.7

-- < 0.01
-- 'f' 8.6
-- 't' 5.38

-- < 0.005
-- 'f'  
-- 't' 

-- >= 0.90
-- 'f' 
-- 't' 

-- >= 0.995 ( 52w )
-- 'f'   8.67
-- 't' -18.57

-- >= 0.995 ( 26w ) ( 52w - 26W: GREAT DIP )
-- 'f'   8.64
-- 't'  -8.83


-- END OF J_OSAM financialstrength and J_OSAM


------------------------------------------------

-- ANDRE TRIES --

-- free_cash_fl_min_financing_over_price_q1 ( non _ci )

explain
select 
    sq.start_date
  , sq.free_cash_fl_min_financing_over_price_q1
  , avg(sq.w52_pradchg_52w_ann) w52_pradchg_52w_ann
  , avg(sq.w26_pradchg_26w_ann) w26_pradchg_26w_ann
  , avg(sq.w13_pradchg_13w_ann) w13_pradchg_13w_ann
from
( select 
      to_timestamp(dateindex*3600*24)::date start_date 
    , ticker 
    , percent_rank() over (partition by dateindex order by ( 
      ( coalesce(fcfps_q1::numeric(15,2), 0.00) - coalesce(tcf_q1::numeric(15,2), 0.00) / nullif( abs(shr_aq1::numeric(15,2)), 0.00) ) / 
          nullif( abs(price::numeric(15,2)), 0.00) 
      ) desc nulls last ) >= 0.995 free_cash_fl_min_financing_over_price_q1  
    , w52_pradchg_52w_ann
    , w26_pradchg_26w_ann
    , w13_pradchg_13w_ann
  from sipro_data_store.si_finecon 
  where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
  -- and dateindex_ci in (16465,16555)
) sq group by cube(sq.start_date, free_cash_fl_min_financing_over_price_q1);
-- LONG TERM:    PERCENT BETTER
-- < 0.10 
-- 'f' 8.48
-- 't' 9.86

-- < 0.01
-- 'f' 8.6
-- 't' 6.7

-- < 0.005
-- 'f'  
-- 't' 

-- >= 0.90
-- 'f' 
-- 't' 

-- >= 0.995
-- 'f'  8.6
-- 't' -6.00


-- NOT FULLY RIGHT! ( I WANT MY 'nulls in the expression to be null and not max(RANK)
-- EXAMPLE ( ranks 1 through 10 )
-- free_cash_fl_min_financing_over_price_q1 ( non _ci )

select 
      sq.start_date
    , count(1) ct_all
    , coalesce(sq.free_cash_fl_min_financing_over_price_q1::text,'ALL') free_cash_fl_min_financing_over_price_q1
    , count(sq.w52_pradchg_52w_ann) w52_ann_ct
    , avg(sq.w52_pradchg_52w_ann) w52_pradchg_52w_ann
    , count(sq.w26_pradchg_26w_ann) w26_ann_ct
    , avg(sq.w26_pradchg_26w_ann) w26_pradchg_26w_ann
    , count(sq.w13_pradchg_13w_ann) w13_ann_ct
    , avg(sq.w13_pradchg_13w_ann) w13_pradchg_13w_ann
from
( select 
      to_timestamp(dateindex*3600*24)::date start_date 
    , ticker 
    , trunc(least(case when 
      ( coalesce(fcfps_q1::numeric(15,2), 0.00) - coalesce(tcf_q1::numeric(15,2), 0.00) / nullif( abs(shr_aq1::numeric(15,2)), 0.00) ) / 
          nullif( abs(price::numeric(15,2)), 0.00) 
      is not null then
      percent_rank() over (partition by dateindex order by ( 
      ( coalesce(fcfps_q1::numeric(15,2), 0.00) - coalesce(tcf_q1::numeric(15,2), 0.00) / nullif( abs(shr_aq1::numeric(15,2)), 0.00) ) / 
          nullif( abs(price::numeric(15,2)), 0.00) 
      ) desc nulls last )  
      else null end,0.99)::numeric * 10.00,0)::int + 1 free_cash_fl_min_financing_over_price_q1  
    , w52_pradchg_52w_ann
    , w26_pradchg_26w_ann
    , w13_pradchg_13w_ann
  from sipro_data_store.si_finecon 
  where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
  -- and dateindex_ci in (16465,16555)
) sq group by cube(sq.start_date, free_cash_fl_min_financing_over_price_q1);






-- best performing sector/sectors
-- mg_desc_sect

select 
    sq.start_date
  , coalesce(sq.mg_desc_sect::text,'cNONE') mg_desc_sect
  , count(sq.w52_pradchg_52w_ann) w52_ann_ct
  , avg(sq.w52_pradchg_52w_ann) w52_pradchg_52w_ann
  , count(sq.w26_pradchg_26w_ann) w26_ann_ct
  , avg(sq.w26_pradchg_26w_ann) w26_pradchg_26w_ann
  , count(sq.w13_pradchg_13w_ann) w13_ann_ct
  , avg(sq.w13_pradchg_13w_ann) w13_pradchg_13w_ann
from
( select 
      to_timestamp(dateindex*3600*24)::date start_date 
    , ticker 
    , mg_desc_sect  
    , w52_pradchg_52w_ann
    , w26_pradchg_26w_ann
    , w13_pradchg_13w_ann
  from sipro_data_store.si_finecon 
  where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
  -- and dateindex in (16465,16555)
) sq group by cube(sq.start_date, mg_desc_sect)
order by sq.start_date, w52_pradchg_52w_ann;

-- "mg_desc_sect" ( about 24000 entries ) @ ~ 14 percent ( 52w ) # so + (14-9)=5% better
-- "Consumer Non-Cyclical"
-- "Health Care"
-- "Conglomerates"



-- best performing industry/industries
-- mg_desc_ind

-- 60 seconds - returns 7315 rows ( best performing industries over the last 5 years )
select 
    sq.start_date
  , coalesce(sq.mg_desc_ind::text,'cNONE') mg_desc_ind
  , count(sq.w52_pradchg_52w_ann) w52_ann_ct
  , avg(sq.w52_pradchg_52w_ann) w52_pradchg_52w_ann
  , count(sq.w26_pradchg_26w_ann) w26_ann_ct
  , avg(sq.w26_pradchg_26w_ann) w26_pradchg_26w_ann
  , count(sq.w13_pradchg_13w_ann) w13_ann_ct
  , avg(sq.w13_pradchg_13w_ann) w13_pradchg_13w_ann
from
( select 
      to_timestamp(dateindex*3600*24)::date start_date 
    , ticker 
    , mg_desc_ind  
    , w52_pradchg_52w_ann
    , w26_pradchg_26w_ann
    , w13_pradchg_13w_ann
  from sipro_data_store.si_finecon 
  where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
  -- and dateindex in (16465,16555)
) sq group by cube(sq.start_date, mg_desc_ind)
order by sq.start_date, w52_pradchg_52w_ann;

-- "mg_desc_ind" ( about 1000 entries ) @ ~ 32 percent ( 52w ) # so + (32-9)=23% better
-- 
-- "Fish/Livestock"
-- "Airline"
-- "Retail (Home Improvement)"

-----------------------------------------------------------

-- doing Monday Sept 5 ( Memorial Day Holiday )
-- using Wednesday ( August 31st (Wedneday night ), end of month AAII data (  )

-- for Stock Options: 'Buy Stock' + 'Sell Call' + 'Buy Put'
-- (direct) Profit:  PREMIUM_RECEIVED_SELL_CALL - PREMIUM_PAID_BUY_PUT
-- Dividends should? be reflected AND still SHOULD: Profit = PREMIUM_RECEIVED_SELL_CALL - PREMIUM_PAID_BUY_PUT

-- highest 

-- R 3.3.1

library(flipsideR)
getOptionChainFS <- getOptionChain 
AAPL_o <- getOptionChainFS("AAPL") 

library(quantmod)
fixInNamespace(x="getOptionChain.yahoo",ns="quantmod") # on.exit(NULL)   CTRL+S CTRL+S( SAVE ) 

2nd Param
getOptionChain
Exp: One or more expiration dates, NULL, or an ISO-8601 style
          string.  If 'Exp' is missing, only the front month contract
          will be returned.

AAPL_o <- quantmod:::getOptionChain.yahoo("AAPL")  


-- ROUGH METHOD
-- highest dividend/dollar returns ( SEE BELOW, FOR THE * MORE * CORRECT * SOLUTION )
-- div_ret_annuallized ( NOTE: pradchg IS NOT EXACTLY PERFECT )

select 
    sq.start_date
  , sq.div_ret_annuallized
  , avg(sq.w52_pradchg_52w_ann) w52_pradchg_52w_ann
  , avg(sq.w26_pradchg_26w_ann) w26_pradchg_26w_ann
  , avg(sq.w13_pradchg_13w_ann) w13_pradchg_13w_ann
from
( select 
      to_timestamp(dateindex*3600*24)::date start_date 
    , ticker 
    , percent_rank() over (partition by dateindex order by ( 
        coalesce(dps_q1::numeric(15,2), 0.00)  * 4.00 /  
          nullif( abs(price::numeric(15,2)), 0.00) 
      ) desc nulls last ) >= 0.50   div_ret_annuallized  
    , w52_pradchg_52w_ann
    , w26_pradchg_26w_ann
    , w13_pradchg_13w_ann
  from sipro_data_store.si_finecon 
  where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
  -- and dateindex_ci in (16465,16555)
) sq group by cube(sq.start_date, div_ret_annuallized);

-- < 0.10 
-- 'f' 8.86
-- 't' 6.34

-- < 0.01
-- 'f' 8.60 -- already INCLUDES pradchg
-- 't' 8.56  

-- < 0.005
-- 'f' 8.61
-- 't' 7.90

-- >= 0.50 -- very few case(s)
-- 'f' 10.91  -- does better in the 'bottom half of dividends )
-- 't' -1.26

-- 0.90  >= 0.80 >= 0.70  >= 0.60 -- NO CASES
-- 'f' 
-- 't'  

-- i

-- highest 'annualized return' dividend returning stocks ( AS OF:  "2016-08-31" ( 17044 ) )

-- temporary INDEX ( a very long time to create: . . . 5:54 minutes+ )

CREATE INDEX si_finecon_jamesos_partial_17044_idx
  ON sipro_data_store.si_finecon
  USING btree
  (adr, exchange COLLATE pg_catalog."default", mktcap COLLATE pg_catalog."default", company_id_unq COLLATE pg_catalog."default", company COLLATE pg_catalog."default")
  WHERE adr = false 
  AND exchange <> 'O'::text 
  AND mktcap::numeric(15,2) >= 200.00 
  AND company_id_unq IS NOT NULL AND (company !~~ ANY (ARRAY['%iShares%'::text, '%Vanguard%'::text, 'SPDR'::text, '%PowerShares%'::text, '%Fund%'::text]))
  AND dateindex = 17044
  ;  -- below ONE_SECOND response instead of 20 seconds

-- check on these to find 'premium_sold - premium_paid' -- compared to return

-- I DO NOT HAVE note: DPS_IND is just a 'math function
-- total_dividends_paid in that last (q1)quarter would be more reliable 

-- of those, dividend 'who gets paid' date
-- (*A*) if a dividend has not been paid within the last 91 days, 
--   then do not expect a dividend to be paid in the future

-- 17044 ticker HQL  "Tekla Life Sciences Investors" ( 6M and IS expected to make next dividend payment )
-- 17044 ticker IFN  "The India Fund, Inc."  ( 6M but missed last dividend payment )

-- NEED TO [ ] REDO 'LATERAL' AND ADD IN '(MORE)CORRECT 'returns from dividends'

--
-- ASSUME I AM 'TRYING TO DO OPTIONS: BUY_THE_STOCK + BUY_A_PUT_PREMIUM
--                                    AFTER THE DATE_OF_RECORD(I GET DIVIDEND) + SELL THE STOCK
--                                        ... END OF DAY ( PROFIT = DIVIDEND   + GAIN_ON_STOCK - BUY_A_PUT_PREMIUM
--                                    AFTER THE DATE_OF_RECORD(I GET DIVIDEND) + SELL THE STOCK(LOSS) + EXCERCISE_PUT
--                                        ... END OF DAY ( PROFIT = DIVIDEND   + (SELL THE STOCK(LOSS) + EXCERCISE_PUT =  0) - BUY_A_PUT_PREMIUM
--                                    SO **PROFIT PROTECTION FROM LOSS**: DIVIDEND_RETURN > BUY_A_PUT_PREMIUM_*RETURN*
-- NOTE: EMBEDDED:  date(now())  ( SO I MUST BE EXACTLY 'AT THIS DATE' )
-- USES dateindex = 17044

-- [X] ALSO, SHOULD HAVE A COLUMN THAT TELLS ME  
-- pred_fut_date_owner_gets_div_announed OR NOT (BOOLEAN)
-- so, I can tell, if the 'dividend'is REALLY coming and not estimated

-- div_pred_fut_ret_if_sell_after_record_annuallized
-- FIND THE *BEST* STOCKS

select 
    sqi.start_date
  , sqi.ticker
  , sqi.company
  , sqi.q1_units_length
  , sqi.period_unit
  , sqi.q1_end_date
  , sqi.date_of_now
  , sqi.numb_days_in_period
  , sqi.dps_q8::numeric(15,2) dps_q8
  , sqi.dps_q7::numeric(15,2) dps_q7
  , sqi.dps_q6::numeric(15,2) dps_q6
  , sqi.dps_q5::numeric(15,2) dps_q5
  , sqi.dps_q4::numeric(15,2) dps_q4
  , sqi.dps_q3::numeric(15,2) dps_q3
  , sqi.dps_q2::numeric(15,2) dps_q2
  , sqi.dps_q1::numeric(15,2) dps_q1
  , sqi.fut_div_annced
  , sqi.fut_div_annced_within_31
  , sqi.fut_const_div_p_share
  , sqi.last_date_owner_gets_div
  , sqi.pred_fut_date_owner_gets_div
  , sqi.div_ret_annuallized div_past_ret_annuallized
  , case when sqi.pred_fut_date_owner_gets_div is not null then sqi.div_ret_annuallized else null end div_pred_fut_ret_annuallized
  , sqi.pred_fut_date_owner_gets_div - date(now()) days_to_go_to_fut_div_date
  , case when sqi.pred_fut_date_owner_gets_div is not null then 
    coalesce(sqi.dps_q1::numeric(15,2), 0.00)  *  ( extract(epoch from '1 years'::interval)/(3600*24) /  nullif((sqi.pred_fut_date_owner_gets_div - date(now()))::numeric(15,2),0.00) )  /  
          nullif( abs(sqi.price::numeric(15,2)), 0.00)  
    else 
      null 
   end div_pred_fut_ret_if_sell_after_record_annuallized
  , sqi.price
  , sqi.dps_q1::numeric(15,2) dps_q1_again
  , sqi.mktcap
  , sqi.shr_p
  , sqi.w52_pradchg_52w_ann
  , sqi.w26_pradchg_26w_ann
  , sqi.w13_pradchg_13w_ann
from 
( select 
      dateindex 
    , to_timestamp(dateindex*3600*24)::date start_date 
    , ticker 
    , company
    , perlen_q1::int q1_units_length
    , pertyp_q1 period_unit
    , perend_q1 q1_end_date
    , date(now()) date_of_now                            
    , case when pertyp_q1 = 'M' then perlen_q1::int * '1 months'::interval else perlen_q1::int * '1 weeks'::interval end numb_days_in_period                     
                                                   --      last_past or near future ( 30 days ahead )
                                                   --   SEEMS LASTTIME/NEAR_FUTURE div HAS_BEEN_PROMISED
    , divnqxdt::date - 1 last_date_owner_gets_div  -- generally ( date(now()) + 30 ) ... going to past . . . far past
    , case when date(now()) < (divnqxdt::date - 1)                                                 then true else false end fut_div_annced
    , case when date(now()) < (divnqxdt::date - 1) and  (divnqxdt::date - 1) <= (date(now()) + 31) then true else false end fut_div_annced_within_31
    , dps_q5::numeric(15,2) <= dps_q4::numeric(15,2) and
      dps_q4::numeric(15,2) <= dps_q3::numeric(15,2) and
      dps_q3::numeric(15,2) <= dps_q2::numeric(15,2) and
      dps_q2::numeric(15,2) <= dps_q1::numeric(15,2) fut_const_div_p_share
    -- , divnqpdt::date     dividend_payment_date 
    , dps_q8
    , dps_q7
    , dps_q6
    , dps_q5
    , dps_q4
    , dps_q3
    , dps_q2
    , dps_q1
    , (case when (divnqxdt::date - 1) < date(now()) then    
        case when (divnqxdt::date - 1) +   -- typically (90 days XOR 3 mons) + 1 [DAY]  
          case when pertyp_q1 = 'M' then perlen_q1::int * '1 months'::interval else perlen_q1::int * '1 weeks'::interval end + '1 days'::interval
          <  date(now())  -- if paid a dividend within the last 90 days
        then
          NULL   -- expect no dividend to be paid within the next 90 days
        else
          (divnqxdt::date - 1) + -- -- typically (90 days XOR 3 mons) + 1 [DAY] -- predicted future date that the owner is on record to get a dividend
          case when pertyp_q1 = 'M' then perlen_q1::int * '1 months'::interval else perlen_q1::int * '1 weeks'::interval end + '1 days'::interval 
        end
      else 
       (divnqxdt::date - 1) 
      end)::date pred_fut_date_owner_gets_div         -- typically about 4.0 for '4 quarters' ( NOTE: /(3600*24) // /(3600*24): cancel out )
    ,   coalesce(dps_q1::numeric(15,2), 0.00)  *  ( extract(epoch from '1 years'::interval) /  ( perlen_q1::int * case when pertyp_q1 = 'M' then extract(epoch from '1 months'::interval) else extract(epoch from '1 weeks'::interval) end ) )  /  
          nullif( abs(price::numeric(15,2)), 0.00) 
                                    div_ret_annuallized  
    , price::numeric(15,2)  price
    , mktcap::numeric(15,2) mktcap
    , mktcap::numeric(15,2)/price::numeric(15,2) shr_p -- shares - regular - point amount - now
    , w52_pradchg_52w_ann
    , w26_pradchg_26w_ann
    , w13_pradchg_13w_ann
  from sipro_data_store.si_finecon 
  where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
  and dateindex = 17044
) sqi order by div_pred_fut_ret_if_sell_after_record_annuallized  desc nulls last 


-- 46 cases out of 3000 ( 1/6 ) ... 2% of a time 'six month periods'
-- select * from ( 
-- ) sq where sq.q1_units_length = 6

-- for the '6 month' cases, if the dividend was anounced within 31 one days was always true
-- 4 total cases 
--, sqi.fut_div_annced           -- true
--, sqi.fut_div_annced_within_31 -- and always true 



  ;
-- WORKS


-- TODAY IS MONDAY NIGHT SEP 05
"start_date","ticker","company","q1_units_length","period_unit","q1_end_date","date_of_now","numb_days_in_period","last_date_owner_gets_div","pred_fut_date_owner_gets_div","div_past_ret_annuallized","div_pred_fut_ret_annuallized","days_to_go_to_fut_div_date","div_pred_fut_ret_if_sell_after_record_annuallized","price","dps_q1","mktcap","shr_p","w52_pradchg_52w_ann","w26_pradchg_26w_ann","w13_pradchg_13w_ann"
"2016-08-31","PNNT","PennantPark Investment Corp.",3,"M","2016-06-30","2016-09-06","3 mons","2016-06-15","2016-09-16",0.142576327896278,0.142576327896278,10,1.2831869510665,7.97,0.28,565.60,70.9661229611041405,,,


library(flipsideR)

getOptionChainFS <- getOptionChain
AAPL_o <- getOptionChainFS("AAPL")

library(quantmod)
fixInNamespace(x="getOptionChain.yahoo",ns="quantmod") # on.exit(NULL)   CTRL+S CTRL+S( SAVE ) 

> Cl(tail({quantmod:::getSymbols("AAPL"); AAPL}))

AAPL_o <- getOptionChain.yahoo("AAPL")  


> PNNT_o <- quantmod:::getOptionChain.yahoo("PNNT")
# DATE OF RECORD (2016-09-16) - BY GOOD/BAD LUCK ALSO THE THIRD FRIDAY OF THE MONTH

> Cl(tail({quantmod:::getSymbols("PNNT"); PNNT},1))
           PNNT.Close
2016-09-02       8.05

# THERE-after

>  Cl(tail({PNNT},1))
           PNNT.Close
2016-09-02       8.05


> PNNT_o <- quantmod:::getOptionChain.yahoo("PNNT")

> PNNT_o
$calls
                    Strike Last        Chg  Bid  Ask Vol  OI
PNNT160916C00002500    2.5 0.00 0.00000000 2.85 4.20   0   0
PNNT160916C00005000    5.0 0.95 0.00000000 0.75 2.20   0   0
PNNT160916C00007500    7.5 0.55 0.02000004 0.30 0.65  10 422 -- WAY 1 - BUY A CALL ONLY ( WRONG - NO DIVIDEND )
PNNT160916C00010000   10.0 0.05 0.00000000 0.00 0.10   0  41

$puts
                    Strike Last Chg  Bid  Ask Vol  OI
PNNT160916P00002500    2.5 0.00   0 0.00 0.45   0   0  -- WAY 2 - BUY A STOCK + BUY A PUT
PNNT160916P00005000    5.0 0.05   0 0.00 0.10  60 109  ** BUT 'PUT' HAS TO BE VERY CLOSE TO STRIKE ( NOT CLOSE ENOUGH HERE ) **
PNNT160916P00007500    7.5 0.20   0 0.15 0.35   5 150  ** PROFILE BUY_A_PUT@LAST  0.20 < DIVIDEND 0.28 ** HERE **
PNNT160916P00010000   10.0 2.40   0 2.05 2.60  16  16              ( 0.08 * 12 ) / 8.05 = 11.9% year   ** HERE **

I AM GOING TO GET A 0.28 DIVIDEND ON SEPT 16 (FRI 3RD FRI)  -- WAY 3: CONVERSION: BUY STOCK + BUY PUT + SELL CALL

(NOTE: HYPOTHTICAL ACTUALLY, I WANT TO *OWN* THE STOCK AT THE END OF SEPT16 
** SO, 8 WOULD NOT DO THIS ONE **

I buy the stock: 8.05
CLOSEST TO MARKET PRICE NOW Strike=7.50
I sell a covered call@bid: +0.30  ( REALISTICALLY@Last: 0.55  ) # SO, IF 'I GET CALLED + 0.35x
I buy a           put@ask: -0.35, ( REALISTICALLY@Last:-0.20  ) 
SOMEONE EXERCISES 
              premium gain/loss: -0.05 ... + dividend: 0.28 ... net: 0.23

                 NOTE: IF I ONLY_ (I buy a put@ask: -0.35) . . . 0.28 - 0.35 = - 0.07

        days to go, dividend per share, market price  per share today ( yahoo )
( 365 / 10.0 ) * 0.23 / 8.05 = [1] 1.042857  yearly rate of return ( of course have to pay taxes )
                             =     104% return
    36.5   *    0.02857143   =

BUT *realistically*, I COULD DO THIS '12 times'/year

    12 * [1] 0.3428572              34% return ( IF I NEVER 'GET CALLED')

(BUT, IF THE STOCK DOES BAD, I EXERCISE THE PUT ON EXPIRE_DATE * AND GET MY  LOSSES BACK)
(BUT, IF THE STOCK DOES GOOD, IT COULD BE CALLED, BEFORE DATE_OF_RECORD, AND I WOULD NOT GET THE DIVIDEND)
(SO, IF THE STOCK IS DOING GOOD, 
  I WANT TO 
    SELL THE STOCK ON THE OPEN MARKET(FOR A PROFIT) AND 
    'BUY BACK THE COVERED CALL' ( NEXT HIGHEST PRIOR )  7.5 @ Ask @ 0.65 ... - 0.65  
    'SEL MY 'BOUGHT PUT' ( NEXT HIGHET PRIOR )              @ Bid @ 0.15 ...   0.15


(SO, IF THE STOCK IS DOING GOOD ( THE 'COVERED CALL' I SOLD IS EXERCISED ), 
  I WANT TO 'SELL THE STOCK ON THE MARKET' GET A PROFI - BUY BACK
         THE STOCK IS SOLD TO THE 'COVERED CALL' OWNER @ STRIKE  ( I HAVE A 'BIG' LOSS )
    UNLESS I 'BUY BACK THE COVERED CALL' ( NEXT HIGHEST PRIOR )  7.5 @ Ask @ 0.65 ... - 0.65  
    UNLESS I 'SELL MY 'BOUGHT PUT' ( NEXT HIGHET PRIOR )             @ Bid @ 0.15 ...   0.15

                                                                           NET -0.50

NOTE: the real answer: 
I have to buy/sell PREMIUMS close to 'last' using stockes with a smaller(ask-bid) spread:(smaller stocks))
diffuculty: strike is 'not near' current 'buy at market'

  (SHOULD SCRAPE)
  Most Active Options ( many catgories )
  http://finance.yahoo.com/options/lists/?bypass=true



-- assume dateindex IS TODAY'S DATE
-- NOTE: 'NOT EMBEDDED date(now())'  
-- ( SO I MUST BE EXACTLY 'AT THIS DATE' ) to_timestamp(dateindex*3600*24)::date


select 
    sqi.start_date
  , sqi.ticker
  , sqi.company
  , sqi.q1_units_length
  , sqi.period_unit
  , sqi.q1_end_date
  , sqi.date_of_now
  , sqi.numb_days_in_period
  , sqi.dps_q8::numeric(15,2) dps_q8
  , sqi.dps_q7::numeric(15,2) dps_q7
  , sqi.dps_q6::numeric(15,2) dps_q6
  , sqi.dps_q5::numeric(15,2) dps_q5
  , sqi.dps_q4::numeric(15,2) dps_q4
  , sqi.dps_q3::numeric(15,2) dps_q3
  , sqi.dps_q2::numeric(15,2) dps_q2
  , sqi.dps_q1::numeric(15,2) dps_q1
  , sqi.fut_div_annced
  , sqi.fut_div_annced_within_31
  , sqi.fut_const_div_p_share
  , sqi.last_date_owner_gets_div
  , sqi.pred_fut_date_owner_gets_div
  , sqi.div_ret_annuallized div_past_ret_annuallized
  , case when sqi.pred_fut_date_owner_gets_div is not null then sqi.div_ret_annuallized else null end div_pred_fut_ret_annuallized
  , sqi.pred_fut_date_owner_gets_div - to_timestamp(sqi.dateindex*3600*24)::date days_to_go_to_fut_div_date
  , case when sqi.pred_fut_date_owner_gets_div is not null then 
    coalesce(sqi.dps_q1::numeric(15,2), 0.00)  *  ( extract(epoch from '1 years'::interval)/(3600*24) /  nullif((sqi.pred_fut_date_owner_gets_div - to_timestamp(sqi.dateindex*3600*24)::date)::numeric(15,2),0.00) )  /  
          nullif( abs(sqi.price::numeric(15,2)), 0.00)  
    else 
      null 
   end div_pred_fut_ret_if_sell_after_record_annuallized
  , sqi.price
  , sqi.dps_q1::numeric(15,2) dps_q1_again
  , sqi.mktcap
  , sqi.shr_p
  , sqi.w52_pradchg_52w_ann
  , sqi.w26_pradchg_26w_ann
  , sqi.w13_pradchg_13w_ann
from 
( select 
      dateindex 
    , to_timestamp(dateindex*3600*24)::date start_date 
    , ticker 
    , company
    , perlen_q1::int q1_units_length
    , pertyp_q1 period_unit
    , perend_q1 q1_end_date
    , to_timestamp(dateindex*3600*24)::date date_of_now                            
    , case when pertyp_q1 = 'M' then perlen_q1::int * '1 months'::interval else perlen_q1::int * '1 weeks'::interval end numb_days_in_period                     
                                                   --      last_past or near future ( 30 days ahead )
                                                   --   SEEMS LASTTIME/NEAR_FUTURE div HAS_BEEN_PROMISED
    , divnqxdt::date - 1 last_date_owner_gets_div  -- generally ( to_timestamp(dateindex*3600*24)::date + 30 ) ... going to past . . . far past
    -- , divnqpdt::date     dividend_payment_date 
    , case when to_timestamp(dateindex*3600*24)::date < (divnqxdt::date - 1)                                                 then true else false end fut_div_annced
    , case when to_timestamp(dateindex*3600*24)::date < (divnqxdt::date - 1) and  (divnqxdt::date - 1) <= (to_timestamp(dateindex*3600*24)::date + 31) then true else false end fut_div_annced_within_31
    , dps_q8::numeric(15,2) > 0.00 and dps_q7::numeric(15,2) > 0.00 and dps_q6::numeric(15,2) > 0.00 and dps_q5::numeric(15,2) > 0.00 and
      dps_q4::numeric(15,2) > 0.00 and dps_q3::numeric(15,2) > 0.00 and dps_q2::numeric(15,2) > 0.00 and dps_q1::numeric(15,2) > 0.00 and
      dps_q5::numeric(15,2) <= dps_q4::numeric(15,2) and
      dps_q4::numeric(15,2) <= dps_q3::numeric(15,2) and
      dps_q3::numeric(15,2) <= dps_q2::numeric(15,2) and
      dps_q2::numeric(15,2) <= dps_q1::numeric(15,2) fut_const_div_p_share
    , dps_q8
    , dps_q7
    , dps_q6
    , dps_q5
    , dps_q4
    , dps_q3
    , dps_q2
    , dps_q1
    , (case when (divnqxdt::date - 1) < to_timestamp(dateindex*3600*24)::date then    
        case when (divnqxdt::date - 1) +   -- typically (90 days XOR 3 mons) + 1 [DAY]  
          case when pertyp_q1 = 'M' then perlen_q1::int * '1 months'::interval else perlen_q1::int * '1 weeks'::interval end + '1 days'::interval
          <  to_timestamp(dateindex*3600*24)::date  -- if paid a dividend within the last 90 days
        then
          NULL   -- expect no dividend to be paid within the next 90 days
        else
          (divnqxdt::date - 1) + -- -- typically (90 days XOR 3 mons) + 1 [DAY] -- predicted future date that the owner is on record to get a dividend
          case when pertyp_q1 = 'M' then perlen_q1::int * '1 months'::interval else perlen_q1::int * '1 weeks'::interval end + '1 days'::interval 
        end
      else 
       (divnqxdt::date - 1) 
      end)::date pred_fut_date_owner_gets_div         -- typically about 4.0 for '4 quarters' ( NOTE: /(3600*24) // /(3600*24): cancel out )
    ,   coalesce(dps_q1::numeric(15,2), 0.00)  *  ( extract(epoch from '1 years'::interval) /  ( perlen_q1::int * case when pertyp_q1 = 'M' then extract(epoch from '1 months'::interval) else extract(epoch from '1 weeks'::interval) end ) )  /  
          nullif( abs(price::numeric(15,2)), 0.00) 
                                    div_ret_annuallized  
    , price::numeric(15,2)  price
    , mktcap::numeric(15,2) mktcap
    , mktcap::numeric(15,2)/price::numeric(15,2) shr_p -- shares - regular - point amount - now
    , w52_pradchg_52w_ann
    , w26_pradchg_26w_ann
    , w13_pradchg_13w_ann
  from sipro_data_store.si_finecon 
  where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
  and dateindex = 17044
) sqi order by div_pred_fut_ret_if_sell_after_record_annuallized  desc nulls last 
  ;

-- where
-- ALSO, SHOULD ELIM: "Trust" AND "REIT"

-- 
-- "FRO","Frontline Ltd" ( best 'returning dividend' but 'not announced' )
-- VERY LATE IN ANNOUNCEMENT
-- but did declare it ( but AAII did not pick it up ON THAT DAY 8/31/2016 )
-- Ex/Eff Date	Type	Cash Amount	Declaration Date	Record Date	Payment Date
-- 9/8/2016         Cash   0.2             8/31/2016               9/12/2016       9/19/2016
-- 6/9/2016         Cash   0.4             5/31/2016               6/13/2016       6/20/2016
-- http://www.nasdaq.com/symbol/fro/dividend-history#ixzz4JavWw8BC ( MAYBE USEFULE TO SCRAPE? )

-- NOTE: dps_q8 ... dps_q1
--       IS FAR IN NUMBERS FROM . . . http://www.nasdaq.com/symbol/fro/dividend-history#ixzz4JavWw8BC
-- Zaks Investment Research

-- Record Date 
-- 9/12/2016 - 1 = 9/11/2016
-- I PREDICTED pred_fut_date_owner_gets_div = 9/09/2016 -- BUT HAS VOLITILE HISTORY 0.35 -> 0.40 -> 0.20
-- SO, THIS IS 'NOT AN EXAMPLE: LAST_PAST_DIVIDEND  ==  FUTURE_DIVIDEND')

-- BUT, HARD_NOTE: NOTHING IN AAII on 'announced dividend' amount'
-- THIS WOULD * STILL * HAVE TO BE GIVEN FROM EXTERNAL SOURCES
-- XOR: I WOULD JUST INCLUDE 'CONSTANT_DIVIDEND_SHARE COMPANIES  dps_q4 <= dps_q3 <= dps_q3 <= dps_q2 <= dps_q1


-- WORKS

-- BETTER_THEN_ROUGH
-- [X] TO BE FIXED, GET RID OF 'NOW' 
-- ( NOTE date(now()) : 2 MINUTE RUN 
-- ( NOTE to_timestamp(dateindex*3600*24)::date : 25 SECONDS ( 8X FASTER ) 
-- highest dividend/dollar returns ( SEE BELOW, FOR THE * MORE * CORRECT * SOLUTION )
--
-- div_ret_annuallized ( NOTE: pradchg IS NOT EXACTLY PERFECT )


select 
    sq.start_date
  , sq.div_ret_annuallized_pct_rnk
  , avg(sq.w52_pradchg_52w_ann) w52_pradchg_52w_ann
  , avg(sq.w26_pradchg_26w_ann) w26_pradchg_26w_ann
  , avg(sq.w13_pradchg_13w_ann) w13_pradchg_13w_ann
from 
( 
  select 
      sqi.start_date
    , sqi.ticker
    , sqi.company
    , sqi.q1_units_length
    , sqi.period_unit
    , sqi.q1_end_date
    , sqi.date_of_now
    , sqi.numb_days_in_period
    , sqi.dps_q8::numeric(15,2) dps_q8
    , sqi.dps_q7::numeric(15,2) dps_q7
    , sqi.dps_q6::numeric(15,2) dps_q6
    , sqi.dps_q5::numeric(15,2) dps_q5
    , sqi.dps_q4::numeric(15,2) dps_q4
    , sqi.dps_q3::numeric(15,2) dps_q3
    , sqi.dps_q2::numeric(15,2) dps_q2
    , sqi.dps_q1::numeric(15,2) dps_q1
    , sqi.fut_div_annced
    , sqi.fut_div_annced_within_31
    , sqi.fut_const_div_p_share
    , sqi.last_date_owner_gets_div
    , sqi.pred_fut_date_owner_gets_div
    , sqi.div_ret_annuallized div_past_ret_annuallized
    , case when sqi.pred_fut_date_owner_gets_div is not null then sqi.div_ret_annuallized else null end div_pred_fut_ret_annuallized
    , sqi.pred_fut_date_owner_gets_div - to_timestamp(sqi.dateindex*3600*24)::date days_to_go_to_fut_div_date
    , case when sqi.pred_fut_date_owner_gets_div is not null then 
      coalesce(sqi.dps_q1::numeric(15,2), 0.00)  *  ( extract(epoch from '1 years'::interval)/(3600*24) /  nullif((sqi.pred_fut_date_owner_gets_div - to_timestamp(sqi.dateindex*3600*24)::date)::numeric(15,2),0.00) )  /  
            nullif( abs(sqi.price::numeric(15,2)), 0.00)  
      else 
        null 
      end div_pred_fut_ret_if_sell_after_record_annuallized
    , percent_rank() over (partition by sqi.dateindex order by ( 
        case when sqi.pred_fut_date_owner_gets_div is not null then sqi.div_ret_annuallized else null end
      ) desc nulls last ) >= 0.50   div_ret_annuallized_pct_rnk
    , sqi.price
    , sqi.dps_q1::numeric(15,2) dps_q1_again
    , sqi.mktcap
    , sqi.shr_p
    , sqi.w52_pradchg_52w_ann
    , sqi.w26_pradchg_26w_ann
    , sqi.w13_pradchg_13w_ann
  from 
  ( select 
        dateindex
      , to_timestamp(dateindex*3600*24)::date start_date 
      , ticker 
      , company
      , perlen_q1::int q1_units_length
      , pertyp_q1 period_unit
      , perend_q1 q1_end_date
      , to_timestamp(dateindex*3600*24)::date date_of_now                            
      , case when pertyp_q1 = 'M' then perlen_q1::int * '1 months'::interval else perlen_q1::int * '1 weeks'::interval end numb_days_in_period                     
                                                     --      last_past or near future ( 30 days ahead )
                                                     --   SEEMS LASTTIME/NEAR_FUTURE div HAS_BEEN_PROMISED
      , divnqxdt::date - 1 last_date_owner_gets_div  -- generally ( to_timestamp(dateindex*3600*24)::date + 30 ) ... going to past . . . far past
      , case when to_timestamp(dateindex*3600*24)::date < (divnqxdt::date - 1)                                                 then true else false end fut_div_annced
      , case when to_timestamp(dateindex*3600*24)::date < (divnqxdt::date - 1) and  (divnqxdt::date - 1) <= (to_timestamp(dateindex*3600*24)::date + 31) then true else false end fut_div_annced_within_31
      , dps_q5::numeric(15,2) <= dps_q4::numeric(15,2) and
        dps_q4::numeric(15,2) <= dps_q3::numeric(15,2) and
        dps_q3::numeric(15,2) <= dps_q2::numeric(15,2) and
        dps_q2::numeric(15,2) <= dps_q1::numeric(15,2) fut_const_div_p_share
      -- , divnqpdt::date     dividend_payment_date 
      , dps_q8
      , dps_q7
      , dps_q6
      , dps_q5
      , dps_q4
      , dps_q3
      , dps_q2
      , dps_q1
      , (case when (divnqxdt::date - 1) < to_timestamp(dateindex*3600*24)::date then    
          case when (divnqxdt::date - 1) +   -- typically (90 days XOR 3 mons) + 1 [DAY]  
            case when pertyp_q1 = 'M' then perlen_q1::int * '1 months'::interval else perlen_q1::int * '1 weeks'::interval end + '1 days'::interval
            <  to_timestamp(dateindex*3600*24)::date  -- if paid a dividend within the last 90 days
          then
            NULL   -- expect no dividend to be paid within the next 90 days
          else
            (divnqxdt::date - 1) + -- -- typically (90 days XOR 3 mons) + 1 [DAY] -- predicted future date that the owner is on record to get a dividend
            case when pertyp_q1 = 'M' then perlen_q1::int * '1 months'::interval else perlen_q1::int * '1 weeks'::interval end + '1 days'::interval 
          end
        else 
         (divnqxdt::date - 1) 
        end)::date pred_fut_date_owner_gets_div         -- typically about 4.0 for '4 quarters' ( NOTE: /(3600*24) // /(3600*24): cancel out )
      ,   coalesce(dps_q1::numeric(15,2), 0.00)  *  ( extract(epoch from '1 years'::interval) /  ( perlen_q1::int * case when pertyp_q1 = 'M' then extract(epoch from '1 months'::interval) else extract(epoch from '1 weeks'::interval) end ) )  /  
            nullif( abs(price::numeric(15,2)), 0.00) 
                                      div_ret_annuallized  
      , price::numeric(15,2)  price
      , mktcap::numeric(15,2) mktcap
      , mktcap::numeric(15,2)/price::numeric(15,2) shr_p -- shares - regular - point amount - now
      , w52_pradchg_52w_ann
      , w26_pradchg_26w_ann
      , w13_pradchg_13w_ann
    from sipro_data_store.si_finecon 
    where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
    --and dateindex = 17044
  ) sqi -- order by case when sqi.pred_fut_date_owner_gets_div is not null then sqi.div_ret_annuallized else null end  desc nulls last 
) sq group by cube(sq.start_date, div_ret_annuallized_pct_rnk);
-- < 0.10 
-- 'f' 10.16
-- 't' 6.37

-- < 0.01
-- 'f' 9.71
-- 't' 6.54

-- < 0.005
-- 'f' 9.36
-- 't' 6.66

-- >= 0.90 -- NO CASES
-- 'f' 
-- 't' 

-- >= 0.50 -- bottom half
-- 'f' 9.88  -- companies that 'DO NOT pay a dividend' have BETTER returns
-- 't' 5.29



-----------------------------------------------------------


      sq.start_date
    , count(1) ct_all
    , coalesce(sq.sales_over_price_ratio::text,'ALL') sales_over_price_ratio
    , count(sq.w52_pradchg_52w_ann) w52_ann_ct
    , avg(sq.w52_pradchg_52w_ann) w52_pradchg_52w_ann
    , count(sq.w26_pradchg_26w_ann) w26_ann_ct
    , avg(sq.w26_pradchg_26w_ann) w26_pradchg_26w_ann
    , count(sq.w13_pradchg_13w_ann) w13_ann_ct
    , avg(sq.w13_pradchg_13w_ann) w13_pradchg_13w_ann
from
( select 
      to_timestamp(dateindex*3600*24)::date start_date 
    , ticker 
    , trunc(least(case when 
       ( sales_q1::numeric(15,2) / nullif( shr_aq1::numeric(15,2), 0.00) + sales_q2::numeric(15,2) / nullif( shr_aq2::numeric(15,2), 0.00)  +
          sales_q3::numeric(15,2) / nullif( shr_aq3::numeric(15,2), 0.00) + sales_q4::numeric(15,2) / nullif( shr_aq4::numeric(15,2), 0.00) )  / 
            nullif( price::numeric(15,2), 0.00)  
      is not null then
      percent_rank() over (partition by dateindex order by ( 
      ( sales_q1::numeric(15,2) / nullif( shr_aq1::numeric(15,2), 0.00) + sales_q2::numeric(15,2) / nullif( shr_aq2::numeric(15,2), 0.00)  +
          sales_q3::numeric(15,2) / nullif( shr_aq3::numeric(15,2), 0.00) + sales_q4::numeric(15,2) / nullif( shr_aq4::numeric(15,2), 0.00) )  / 
            nullif( price::numeric(15,2), 0.00)  
      ) desc nulls last )  
      else null end,0.99)::numeric * 100.00,0)::int + 1 
      sales_over_price_ratio  
    , w52_pradchg_52w_ann
    , w26_pradchg_26w_ann
    , w13_pradchg_13w_ann
  from sipro_data_store.si_finecon 
  where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
  -- and dateindex_ci in (16465,16555)
) sq group by cube(sq.start_date, sales_over_price_ratio);
--
-- 100.00
-- top 2% average 14.75 '3600 grand total entries' ( 6.0% better than average? ), 
--   but then at 3 . . .sudden drop to 9.86
--
-- ( percentile:2(15.25) performs better than percentile:1(14.27)))

-----------------------
-----------------------



-- MADE RIGHT - DONE 
-- ( BECAUSE PostgreSQL does not have that 'IGNORE NULLS' ) that is in the SQL standard 

-- ( I WANT MY 'nulls in the expression to be null and not max(RANK) )
-- 
-- ( ranks 1 through 100 )
-- sales_over_price_ratio


select 
      sq.start_date
    , count(1)                                                                                            ct_all
    , count(1)                                        filter(where sq.sales_over_price_ratio is not null) ct_all_sales_over_price_ratio
    , coalesce(sq.sales_over_price_ratio::text,'ALL')     sales_over_price_ratio -- aesthetics
    , count(sq.w52_pradchg_52w_ann)                   filter(where sq.sales_over_price_ratio is not null) w52_ann_ct
    , avg(sq.w52_pradchg_52w_ann)                     filter(where sq.sales_over_price_ratio is not null) w52_pradchg_52w_ann
    , count(sq.w26_pradchg_26w_ann)                   filter(where sq.sales_over_price_ratio is not null) w26_ann_ct
    , avg(sq.w26_pradchg_26w_ann)                     filter(where sq.sales_over_price_ratio is not null) w26_pradchg_26w_ann
    , count(sq.w13_pradchg_13w_ann)                   filter(where sq.sales_over_price_ratio is not null) w13_ann_ct
    , avg(sq.w13_pradchg_13w_ann)                     filter(where sq.sales_over_price_ratio is not null) w13_pradchg_13w_ann
from
( select 
      to_timestamp(dateindex*3600*24)::date start_date 
    , ticker 
    , trunc(least(case when 
       ( sales_q1::numeric(15,2) / nullif( shr_aq1::numeric(15,2), 0.00) + sales_q2::numeric(15,2) / nullif( shr_aq2::numeric(15,2), 0.00)  +
          sales_q3::numeric(15,2) / nullif( shr_aq3::numeric(15,2), 0.00) + sales_q4::numeric(15,2) / nullif( shr_aq4::numeric(15,2), 0.00) )  / 
            nullif( price::numeric(15,2), 0.00)  
      is not null then
      percent_rank() over (partition by dateindex order by ( 
      ( sales_q1::numeric(15,2) / nullif( shr_aq1::numeric(15,2), 0.00) + sales_q2::numeric(15,2) / nullif( shr_aq2::numeric(15,2), 0.00)  +
          sales_q3::numeric(15,2) / nullif( shr_aq3::numeric(15,2), 0.00) + sales_q4::numeric(15,2) / nullif( shr_aq4::numeric(15,2), 0.00) )  / 
            nullif( price::numeric(15,2), 0.00)  
      ) desc nulls last )  
      else null end,0.99)::numeric * 100.00,0)::int + 1 
      sales_over_price_ratio  
    , w52_pradchg_52w_ann
    , w26_pradchg_26w_ann
    , w13_pradchg_13w_ann
  from sipro_data_store.si_finecon 
  where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%'])
  -- and dateindex_ci in (16465,16555)
) sq group by cube(sq.start_date, sales_over_price_ratio);
--
-- seconds: 33
-- 100.00
-- top 2% average 14.75 '3600 grand total entries' ( 6.0% better than average? ), 
--   but then at 3 . . .sudden drop to 9.86
--
-- ( percentile:2(15.25) performs better than percentile:1(14.27)))

-- 1000.00 
--? ( SEE BELOW )


-- NOT USING, I NEED RELATIVE TO SALES
      , trunc(least(case when 
         ( fcfps_q1::numeric(15,2) * nullif( shr_aq1::numeric(15,2), 0.00) + fcfps_q2::numeric(15,2) * nullif( shr_aq2::numeric(15,2), 0.00)  +
            fcfps_q3::numeric(15,2) * nullif( shr_aq3::numeric(15,2), 0.00) + fcfps_q4::numeric(15,2) * nullif( shr_aq4::numeric(15,2), 0.00) )  / 
              nullif( price::numeric(15,2), 0.00)  
        is not null then
        percent_rank() over (partition by dateindex order by ( 
          ( 
              fcfps_q1::numeric(15,2) * nullif( shr_aq1::numeric(15,2), 0.00) 
            + fcfps_q2::numeric(15,2) * nullif( shr_aq2::numeric(15,2), 0.00)  
         -- + fcfps_q3::numeric(15,2) * nullif( shr_aq3::numeric(15,2), 0.00) 
         -- + fcfps_q4::numeric(15,2) * nullif( shr_aq4::numeric(15,2), 0.00) 
          )  / 
              nullif( price::numeric(15,2), 0.00)  
        ) desc nulls last )  
        else null end,0.99)::numeric * 10.00,0)::int + 1 
        fcf_over_price_ratio
      , trunc(least(case when 
         ( cgs_q1::numeric(15,2) / nullif( shr_aq1::numeric(15,2), 0.00) + cgs_q2::numeric(15,2) / nullif( shr_aq2::numeric(15,2), 0.00)  +
            cgs_q3::numeric(15,2) / nullif( shr_aq3::numeric(15,2), 0.00) + cgs_q4::numeric(15,2) / nullif( shr_aq4::numeric(15,2), 0.00) ) * (-1.0) / 
              nullif( price::numeric(15,2), 0.00)  
        is not null then
        percent_rank() over (partition by dateindex order by ( 
          ( (
              cgs_q1::numeric(15,2) / nullif( shr_aq1::numeric(15,2), 0.00) 
            + cgs_q2::numeric(15,2) / nullif( shr_aq2::numeric(15,2), 0.00)  
         -- + cgs_q3::numeric(15,2) / nullif( shr_aq3::numeric(15,2), 0.00) 
         -- + cgs_q4::numeric(15,2) / nullif( shr_aq4::numeric(15,2), 0.00)
            ) * (-1.0) 
          )  / 
              nullif( price::numeric(15,2), 0.00)  
        ) desc nulls last )  
        else null end,0.99)::numeric * 10.00,0)::int + 1 
        neg_cgs_over_price_ratio  
      , trunc(least(case when 
         ( ( sales_q1::numeric(15,2) - cgs_q1::numeric(15,2) ) / nullif( shr_aq1::numeric(15,2), 0.00) + 
           ( sales_q2::numeric(15,2) - cgs_q2::numeric(15,2) ) / nullif( shr_aq2::numeric(15,2), 0.00) +
           ( sales_q3::numeric(15,2) - cgs_q3::numeric(15,2) ) / nullif( shr_aq3::numeric(15,2), 0.00) + 
           ( sales_q4::numeric(15,2) - cgs_q4::numeric(15,2) ) / nullif( shr_aq4::numeric(15,2), 0.00) )  / 
              nullif( price::numeric(15,2), 0.00)  
        is not null then
        percent_rank() over (partition by dateindex order by ( 
          ( 
              ( sales_q1::numeric(15,2) - cgs_q1::numeric(15,2) ) / nullif( shr_aq1::numeric(15,2), 0.00) 
            + ( sales_q1::numeric(15,2) - cgs_q1::numeric(15,2) ) / nullif( shr_aq2::numeric(15,2), 0.00)  
         -- + ( sales_q1::numeric(15,2) - cgs_q1::numeric(15,2) ) / nullif( shr_aq3::numeric(15,2), 0.00) 
         -- + ( sales_q1::numeric(15,2) - cgs_q1::numeric(15,2) ) / nullif( shr_aq4::numeric(15,2), 0.00) 
          )  / 
              nullif( price::numeric(15,2), 0.00)  
        ) desc nulls last )  
        else null end,0.99)::numeric * 10.00,0)::int + 1 
        sales_less_cgs_over_price_ratio  


-- ( ranks 1 through 1000 )
-- sales_over_price_ratio
-- WHAT DOES THAT 1-2 % top percentile rank REALLY look like

--(SALVATION)
--six minute SQL run down to 38 seconds
---------------------------------

--REINDEX INDEX si_finecon_jamesos_partial_idx; -- took 6 minutes to rebuild

--  replacing the old copy of the index

--DONE in PgAdminIII on NOV 09 2016

-- REQUIRED: beceause all this time, I had the WRONG where CLAUSE
-- drop index sipro_data_store.si_finecon_jamesos_partial_idx2;
CREATE INDEX si_finecon_jamesos_partial_idx2
  ON sipro_data_store.si_finecon
  USING btree
  (adr, exchange COLLATE pg_catalog."default", mktcap COLLATE pg_catalog."default", company_id_unq COLLATE pg_catalog."default", company COLLATE pg_catalog."default")
  WHERE adr = false AND exchange <> 'O'::text AND mktcap::numeric(15,2) >= 200.00 AND ((company !~~ '%iShares%'::text) AND (company !~~ '%Vanguard%'::text) AND (company !~~ 'SPDR'::text) AND (company !~~ '%PowerShares%'::text) AND (company !~~ '%Fund%'::text))

-- drop index sipro_data_store.si_finecon_jamesos_partial_idx3;
CREATE INDEX si_finecon_jamesos_partial_idx3
  ON sipro_data_store.si_finecon
  USING btree
  (adr, exchange COLLATE pg_catalog."default", mktcap COLLATE pg_catalog."default", company_id_unq COLLATE pg_catalog."default", company COLLATE pg_catalog."default")
  WHERE adr = false AND exchange <> 'O'::text AND mktcap::numeric(15,2) >= 200.00 AND ((company !~~ '%iShares%'::text) AND (company !~~ '%Vanguard%'::text) AND (company !~~ 'SPDR'::text) AND (company !~~ '%PowerShares%'::text) AND (company !~~ '%Fund%'::text))  
  AND (company !~~ '%Holding%'::text) AND (mg_desc_ind !~~ '%Investment Service%'::text)


-- drop table sipro_data_store.my_0001_cnt_in_pctrank;
create table sipro_data_store.my_0001_cnt_in_pctrank as
--FULL QUERY
select sqe.* from (
  select 
        coalesce(sq.start_date::text,'ALL')                start_date  -- aesthetics
      , count(1)                                                                                            ct_all
      , count(1)                                        filter(where sq.sales_over_price_ratio is not null) ct_all_sales_over_price_ratio
      , coalesce(sq.sales_over_price_ratio::text,'ALL')     sales_over_price_ratio -- aesthetics
   -- , coalesce(sq.fcf_over_price_ratio::text,'ALL')       fcf_over_price_ratio   -- aesthetics
      , count(sq.w52_pradchg_52w_ann)                   filter(where sq.sales_over_price_ratio is not null) w52_ann_ct
      , avg(sq.w52_pradchg_52w_ann)                     filter(where sq.sales_over_price_ratio is not null) w52_pradchg_52w_ann
      , stddev_pop(sq.w52_pradchg_52w_ann) filter(where sq.sales_over_price_ratio is not null) w52_pradchg_52w_ann_sd
      -- higher the better ( long postition )
      , ( avg(sq.w52_pradchg_52w_ann) filter(where sq.sales_over_price_ratio is not null) - 0.0 ) / nullif(stddev_pop(sq.w52_pradchg_52w_ann) filter(where sq.sales_over_price_ratio is not null) ,0) w52_pradchg_52w_ann_sharpe 
      -- higher the better ( long position )
      , ( avg(sq.w52_pradchg_52w_ann) filter(where sq.sales_over_price_ratio is not null) - 0.0 ) / nullif(stddev_pop(case when  sq.w52_pradchg_52w_ann > 0.00 then NULL else  sq.w52_pradchg_52w_ann end ) filter(where sq.sales_over_price_ratio is not null) ,0) w52_pradchg_52w_ann_sortino
      -- higher the better ( long postition )
      , ( 0.0 - avg(sq.w52_pradchg_52w_ann) filter(where sq.sales_over_price_ratio is not null) ) / nullif(stddev_pop(sq.w52_pradchg_52w_ann) filter(where sq.sales_over_price_ratio is not null) ,0) w52_pradchg_52w_ann_sharpe_short
      -- higher the better ( short position )
      , ( avg(sq.w52_pradchg_52w_ann) filter(where sq.sales_over_price_ratio is not null) - 0.0 ) / nullif(stddev_pop(case when  sq.w52_pradchg_52w_ann > 0.00 then 0.00 else  sq.w52_pradchg_52w_ann end ) filter(where sq.sales_over_price_ratio is not null) ,0) w52_pradchg_52w_ann_sortino_true
      --  higher the better ( short position )
      , ( 0.0 - avg(sq.w52_pradchg_52w_ann) filter(where sq.sales_over_price_ratio is not null) ) / nullif(stddev_pop(case when  sq.w52_pradchg_52w_ann < 0.00 then NULL else  sq.w52_pradchg_52w_ann end ) filter(where sq.sales_over_price_ratio is not null) ,0) w52_pradchg_52w_ann_sortino_short
      -- higher the better ( short position )
      , ( 0.0 - avg(sq.w52_pradchg_52w_ann) filter(where sq.sales_over_price_ratio is not null) ) / nullif(stddev_pop(case when  sq.w52_pradchg_52w_ann < 0.00 then 0.00 else  sq.w52_pradchg_52w_ann end ) filter(where sq.sales_over_price_ratio is not null) ,0) w52_pradchg_52w_ann_sortino_true_short
      , count(sq.w26_pradchg_26w_ann)                   filter(where sq.sales_over_price_ratio is not null) w26_ann_ct
      , avg(sq.w26_pradchg_26w_ann)                     filter(where sq.sales_over_price_ratio is not null) w26_pradchg_26w_ann
      , stddev_pop(sq.w26_pradchg_26w_ann) filter(where sq.sales_over_price_ratio is not null) w26_pradchg_26w_ann_sd
      -- higher the better ( long postition )
      , ( avg(sq.w26_pradchg_26w_ann) filter(where sq.sales_over_price_ratio is not null) - 0.0 ) / nullif(stddev_pop(sq.w26_pradchg_26w_ann) filter(where sq.sales_over_price_ratio is not null) ,0) w26_pradchg_26w_ann_sharpe 
      -- higher the better ( long position )
      , ( avg(sq.w26_pradchg_26w_ann) filter(where sq.sales_over_price_ratio is not null) - 0.0 ) / nullif(stddev_pop(case when  sq.w26_pradchg_26w_ann > 0.00 then NULL else  sq.w26_pradchg_26w_ann end ) filter(where sq.sales_over_price_ratio is not null) ,0) w26_pradchg_26w_ann_sortino
      -- higher the better ( long position )
      , ( avg(sq.w26_pradchg_26w_ann) filter(where sq.sales_over_price_ratio is not null) - 0.0 ) / nullif(stddev_pop(case when  sq.w26_pradchg_26w_ann > 0.00 then 0.00 else  sq.w26_pradchg_26w_ann end ) filter(where sq.sales_over_price_ratio is not null) ,0) w26_pradchg_26w_ann_sortino_true
      -- higher the better ( short postition )
      , ( 0.0 - avg(sq.w26_pradchg_26w_ann) filter(where sq.sales_over_price_ratio is not null) ) / nullif(stddev_pop(sq.w26_pradchg_26w_ann) filter(where sq.sales_over_price_ratio is not null) ,0) w26_pradchg_26w_ann_sharpe_short
      --  higher the better ( short position )
      , ( 0.0 - avg(sq.w26_pradchg_26w_ann) filter(where sq.sales_over_price_ratio is not null) ) / nullif(stddev_pop(case when  sq.w26_pradchg_26w_ann < 0.00 then NULL else  sq.w26_pradchg_26w_ann end ) filter(where sq.sales_over_price_ratio is not null) ,0) w26_pradchg_26w_ann_sortino_short
      -- higher the better ( short position )
      , ( 0.0 - avg(sq.w26_pradchg_26w_ann) filter(where sq.sales_over_price_ratio is not null) ) / nullif(stddev_pop(case when  sq.w26_pradchg_26w_ann < 0.00 then 0.00 else  sq.w26_pradchg_26w_ann end ) filter(where sq.sales_over_price_ratio is not null) ,0) w26_pradchg_26w_ann_sortino_true_short
      , count(sq.w13_pradchg_13w_ann)                   filter(where sq.sales_over_price_ratio is not null) w13_ann_ct
      , avg(sq.w13_pradchg_13w_ann)                     filter(where sq.sales_over_price_ratio is not null) w13_pradchg_13w_ann
      , stddev_pop(sq.w13_pradchg_13w_ann) filter(where sq.sales_over_price_ratio is not null) w13_pradchg_13w_ann_sd
      -- higher the better ( long postition )
      , ( avg(sq.w13_pradchg_13w_ann) filter(where sq.sales_over_price_ratio is not null) - 0.0 ) / nullif(stddev_pop(sq.w13_pradchg_13w_ann) filter(where sq.sales_over_price_ratio is not null) ,0) w13_pradchg_13w_ann_sharpe 
      -- higher the better ( long position )
      , ( avg(sq.w13_pradchg_13w_ann) filter(where sq.sales_over_price_ratio is not null) - 0.0 ) / nullif(stddev_pop(case when  sq.w13_pradchg_13w_ann > 0.00 then NULL else  sq.w13_pradchg_13w_ann end ) filter(where sq.sales_over_price_ratio is not null) ,0) w13_pradchg_13w_ann_sortino
      -- higher the better ( long position )
      , ( avg(sq.w13_pradchg_13w_ann) filter(where sq.sales_over_price_ratio is not null) - 0.0 ) / nullif(stddev_pop(case when  sq.w13_pradchg_13w_ann > 0.00 then 0.00 else  sq.w13_pradchg_13w_ann end ) filter(where sq.sales_over_price_ratio is not null) ,0) w13_pradchg_13w_ann_sortino_true
      -- higher the better ( short postition )
      , ( 0.0 - avg(sq.w13_pradchg_13w_ann) filter(where sq.sales_over_price_ratio is not null) ) / nullif(stddev_pop(sq.w13_pradchg_13w_ann) filter(where sq.sales_over_price_ratio is not null) ,0) w13_pradchg_13w_ann_sharpe_short
      --  higher the better ( short position )
      , ( 0.0 - avg(sq.w13_pradchg_13w_ann) filter(where sq.sales_over_price_ratio is not null) ) / nullif(stddev_pop(case when  sq.w13_pradchg_13w_ann < 0.00 then NULL else  sq.w13_pradchg_13w_ann end ) filter(where sq.sales_over_price_ratio is not null) ,0) w13_pradchg_13w_ann_sortino_short
      -- higher the better ( short position )
      , ( 0.0 - avg(sq.w13_pradchg_13w_ann) filter(where sq.sales_over_price_ratio is not null) ) / nullif(stddev_pop(case when  sq.w13_pradchg_13w_ann < 0.00 then 0.00 else  sq.w13_pradchg_13w_ann end ) filter(where sq.sales_over_price_ratio is not null) ,0) w13_pradchg_13w_ann_sortino_true_short
  from
  ( 
  select sqi.* from (  -- BEGIN find my 0001 WINNERS
    select 
        to_timestamp(dateindex*3600*24)::date start_date 
      , ticker_unq 
      , company
      , company_id_unq
      , mktcap::numeric(15,2) mktcap
      , mg_desc_ind
      , mg_desc_sect
      , trunc(least(case when 
         (   sales_q1::numeric(15,2) / nullif( shr_aq1::numeric(15,2), 0.00) 
           + sales_q2::numeric(15,2) / nullif( shr_aq2::numeric(15,2), 0.00)  
        -- + sales_q3::numeric(15,2) / nullif( shr_aq3::numeric(15,2), 0.00) 
        -- + sales_q4::numeric(15,2) / nullif( shr_aq4::numeric(15,2), 0.00) 
        )  / 
              nullif( price::numeric(15,2), 0.00)  
        is not null then
        percent_rank() over (partition by dateindex order by ( 
          ( 
              sales_q1::numeric(15,2) / nullif( shr_aq1::numeric(15,2), 0.00) 
            + sales_q2::numeric(15,2) / nullif( shr_aq2::numeric(15,2), 0.00)  
         -- + sales_q3::numeric(15,2) / nullif( shr_aq3::numeric(15,2), 0.00) 
         -- + sales_q4::numeric(15,2) / nullif( shr_aq4::numeric(15,2), 0.00) 
          )  / 
              nullif( price::numeric(15,2), 0.00)  
        ) desc nulls last )  
        else null end,0.99)::numeric * 1000.00,0)::int + 1 
        sales_over_price_ratio  
      , trunc(least(case when 
         (  
            (
              cgs_q1::numeric(15,2)  
            + cgs_q2::numeric(15,2)  
         -- + cgs_q3::numeric(15,2)  
         -- + cgs_q4::numeric(15,2)  
            ) / (
              nullif( 
                  sales_q1::numeric(15,2) 
                + sales_q2::numeric(15,2) 
                + sales_q3::numeric(15,2) 
                + sales_q4::numeric(15,2)
              , 0.0)
            ) * (-1.0)
         )  
        is not null then
        percent_rank() over (partition by dateindex order by ( 
          ( 
            (
              cgs_q1::numeric(15,2)  
            + cgs_q2::numeric(15,2)  
         -- + cgs_q3::numeric(15,2)  
         -- + cgs_q4::numeric(15,2)  
            ) / (
              nullif( 
                  sales_q1::numeric(15,2) 
                + sales_q2::numeric(15,2) 
                + sales_q3::numeric(15,2) 
                + sales_q4::numeric(15,2)
              , 0.0)
            ) * (-1.0)
          )  
        ) desc nulls last )  
        else null end,0.99)::numeric * 10.00,0)::int + 1 
        neg_cgs_over_sales
      , trunc(least(case when 
         (  
            (
              fcfps_q1::numeric(15,2) * nullif( shr_aq1::numeric(15,2), 0.00) 
            + fcfps_q2::numeric(15,2) * nullif( shr_aq2::numeric(15,2), 0.00)  
         -- + fcfps_q3::numeric(15,2) * nullif( shr_aq3::numeric(15,2), 0.00) 
         -- + fcfps_q4::numeric(15,2) * nullif( shr_aq4::numeric(15,2), 0.00) 
            ) / (
              nullif( 
                  sales_q1::numeric(15,2) 
                + sales_q2::numeric(15,2) 
                + sales_q3::numeric(15,2) 
                + sales_q4::numeric(15,2)
              , 0.0)
            ) 
         )  
        is not null then
        percent_rank() over (partition by dateindex order by ( 
          ( 
            (
              fcfps_q1::numeric(15,2) * nullif( shr_aq1::numeric(15,2), 0.00) 
            + fcfps_q2::numeric(15,2) * nullif( shr_aq2::numeric(15,2), 0.00)  
         -- + fcfps_q3::numeric(15,2) * nullif( shr_aq3::numeric(15,2), 0.00) 
         -- + fcfps_q4::numeric(15,2) * nullif( shr_aq4::numeric(15,2), 0.00) 
            ) / (
              nullif( 
                  sales_q1::numeric(15,2) 
                + sales_q2::numeric(15,2) 
                + sales_q3::numeric(15,2) 
                + sales_q4::numeric(15,2)
              , 0.0)
            )
          )  
        ) desc nulls last )  
        else null end,0.99)::numeric * 10.00,0)::int + 1 
        fcf_over_sales
      , trunc(least(case when 
         (  
            (
              fcfps_q1::numeric(15,2) * nullif( shr_aq1::numeric(15,2), 0.00) 
            + fcfps_q2::numeric(15,2) * nullif( shr_aq2::numeric(15,2), 0.00)  
         -- + fcfps_q3::numeric(15,2) * nullif( shr_aq3::numeric(15,2), 0.00) 
         -- + fcfps_q4::numeric(15,2) * nullif( shr_aq4::numeric(15,2), 0.00) 
            ) / (
              nullif( 
                  cgs_q1::numeric(15,2) 
                + cgs_q2::numeric(15,2) 
                + cgs_q3::numeric(15,2) 
                + cgs_q4::numeric(15,2)
              , 0.0)
            )
         )  
        is not null then
        percent_rank() over (partition by dateindex order by ( 
          ( 
            (
              fcfps_q1::numeric(15,2) * nullif( shr_aq1::numeric(15,2), 0.00) 
            + fcfps_q2::numeric(15,2) * nullif( shr_aq2::numeric(15,2), 0.00)  
         -- + fcfps_q3::numeric(15,2) * nullif( shr_aq3::numeric(15,2), 0.00) 
         -- + fcfps_q4::numeric(15,2) * nullif( shr_aq4::numeric(15,2), 0.00) 
            ) / (
              nullif( 
                  cgs_q1::numeric(15,2) 
                + cgs_q2::numeric(15,2) 
                + cgs_q3::numeric(15,2) 
                + cgs_q4::numeric(15,2)
              , 0.0)
            )
          )  
        ) desc nulls last )  
        else null end,0.99)::numeric * 10.00,0)::int + 1 
        fcf_over_cgs
      , w52_pradchg_52w_ann
      , w26_pradchg_26w_ann
      , w13_pradchg_13w_ann
    from sipro_data_store.si_finecon 
    where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 
    and company_id_unq is not null 
    -- AND company NOT LIKE '%iShares%' and company NOT LIKE '%Vanguard%' and company NOT LIKE 'SPDR' and company NOT LIKE '%PowerShares%' and company NOT LIKE '%Fund%'
    -- SAME
    AND ((company !~~ '%iShares%'::text) AND (company !~~ '%Vanguard%'::text) AND (company !~~ 'SPDR'::text) AND (company !~~ '%PowerShares%'::text) AND (company !~~ '%Fund%'::text))
    AND (company !~~ '%Holding%'::text) AND (mg_desc_ind !~~ '%Investment Service%'::text)
    -- -- try to stop DIP_AT_3_PERCENT_PROBLEM
    -- LAST - KEEPER - NOT COMMENTED OUT (26%@13w)
    -- BUT NOTICE 6_MO_SALES range in 6_MO_PRICE_CHANGE range
    and prchg_26w::numeric(15,2) > 0 -- better
         and fcfps_q1::numeric(15,2) > 0
      -- and prchg_04w::numeric(15,2) < 0.00 -- hills  but no better than ave -- -5.00 - better off searching for a 'better' stock
      -- AWEFUL
      -- and fcfps_q1::numeric(15,2) > 0 and fcfps_q1::numeric(15,2) > fcfps_q2::numeric(15,2) and fcfps_q2::numeric(15,2) > fcfps_q3::numeric(15,2)
      -- TRY
      -- and prchg_52w::numeric(15,2) > 0 
      -- TRY ( TRENDING SEVERLY WORSTENS IT )
      -- and sales_q1::numeric(15,2) > sales_q2::numeric(15,2)
      -- TRY ( TRENDING SEVERLY WORSTENS IT )
      -- and fcfps_q1::numeric(15,2) > fcfps_q2::numeric(15,2)
      -- ISNT WORTH IT
    -- and prchg_04w::numeric(15,2) > 0 -- ISNT WORTH IT
    -- SEVERLY NO
    -- and prchg_13w::numeric(15,2) > -15.00 
    -- SEVERLY NO
    -- and prchg_13w::numeric(15,2) > -15.00
      -- -- try to stop DIP_AT_3_PERCENT_PROBLEM
      -- and prchg_13w::numeric(15,2) > 0 -- ?
      -- -- try to stop DIP_AT_3_PERCENT_PROBLEM
      -- and prchg_52w::numeric(15,2) > 0 -- ?
    -- -- DIP_AT_3_PERCENT_PROBLEM
    -- -- no good help 20/58 instead of 21/56 ( BUT GOOD: DIP IS AT 3(12%) INSTEAD OF 3(9%) ) 
    -- and mg_desc_sect != 'Energy'
    -- -- ZERO ce - better result on the 26 week, by the same otherwise
    -- and coalesce(ce_q1::numeric(15,0),0.00) = 0.00 and coalesce(ce_q2::numeric(15,0),0.00) = 0.00
    -- -- sales momentum try
    -- -- sales_over_price_ratio 0001-0010 each is more consistenly the same
    -- -- TOP 1% AVE 18% ( BUT 0001 IS ONLY 15.6% ), otherwise TOP 1% IS 21.34
    -- -- and coalesce(sales_q1::numeric(15,0),0.00) > coalesce(sales_q2::numeric(15,0),0.00) and coalesce(sales_q2::numeric(15,0),0.00) > coalesce(sales_q3::numeric(15,0),0.00)
    -- -- OSAM_DEFENSE ( VARIANT ) - MADE ONLY 52W SLIGHTLY BETTER  ( 25.67 ) ( BUT A LARGER VARIANCE )
    -- and coalesce(tco_q1::numeric(15,2), 0.00) > coalesce(netinc_q1::numeric(15,2), 0.00) and  coalesce(tco_q2::numeric(15,2), 0.00) > coalesce(netinc_q2::numeric(15,2), 0.00)
    -- and dateindex_ci in (16465,16555)
  ) sqi   -- I did not see any *pattern* of industry or sector
    -- where sqi.sales_over_price_ratio <= 10 # =           -- inside query: I just want the names of the top 0001 companies
    -- and sql.dateindex = 17044                            -- ( AT 'now' just get the future companies to invest IN )
    -- END find my 0001 WINNERS ( LINE BELOW)
    -- order by start_date, sales_over_price_ratio  -- inside query: I just want the names of the top 0001 companies
  ) sq group by cube(
      sq.start_date
    , sq.sales_over_price_ratio
 -- ERROR? CAN I USE THIS? HOW WILL AVG() filter() BE AFFECTED ON A DUAL?
 -- , sq.fcf_over_price_ratio
    )
) sqe where sqe.start_date = 'ALL' 
      and   sqe.sales_over_price_ratio in ('1','2','3','4','5','6','7','8','9','10')
   -- and   sqe.fcf_over_price_ratio   in ('1','2','3','4','5','6','7','8','9','10')
-- group by ( ABOVE - ALREADY ORDERS
-- 85 SECONDS ( ALL SHARP/SORT + 2ND PERCENT_RANK )



-- NEED A FIX
-- 0002 PERCENT RETURN DIP % PROBLEM: ( I HAVE SEEN THIS BEFORE ... ENERGY )
--   AS BAD NEW SPREADS ( BUT 'IS FUTURE CORRECT ) SALES/PRICE INCREASES ( LOOKING ATTRACTIVE BY ACTUALLY NOT )
--     I NEED AN INDUSTRY( OR SECTOR ) COMPARISON . . . 

-- THROUGH AUG 2016 DATA
-- seconds: 36.9 ( 3 seconds MORE than 100.00 )
-- BUT with all sharpe and sortino : 65 seconds
-- 1000 %
-- 0001(18.46%) and 0002(18.53%): 10% BETTER THAN THE AVERAGE 

-- *** 0001(23.04%) *** BEST 13 WEEK WINNER  *** 4 quarters of sales OVER price
--                                           *** 1 quarter  of sales OVER price ( NOT MUCH DIFFERENCE )

-- *** 0001(26.57%) *** BEST 13 WEEK WINNER  *** 2 quarters of sales OVER price
--     0001(21.34%) ( + 13% ) 52 WEEK                - VOLITILITY 56.00



-- TO DO
-- compare to INDUSTRY AVE ( SUNDAY+ MORNING ) -- SO, I NOTICE, NOT? TO INVEST IN AN INDUSTRY WITH POOR RESUTS
-- compare to 'Gold and Silver' INDUSTRY(Fear)
-- compare to 'externally loaded bonds' FRED/

-- TO DO
-- splite into quarters, 
-- run though a random_forest or a gradient boosting machine



set search_path to sipro_data_store,sipro_stage;
set time zone 'utc';
set work_mem to '1200MB';
set constraint_exclusion = on;



create table sipro_data_store.my_0001_cnt_in_pctrank as
--FULL QUERY ( ALREADY DONE ABOVE )) -- so I am looking for the 'top 'how many'?'

-- select * from sipro_data_store.my_0001_cnt_in_pctrank;
---- 0001 123  24.8
---- 0002 82   19.8
---- 0003 89   7.12
---- 0004 79  12.37

-- -- Table: sipro_data_store.my_0001_cnt_in_pctrank
-- 
-- -- DROP TABLE sipro_data_store.my_0001_cnt_in_pctrank;
-- 
-- CREATE TABLE sipro_data_store.my_0001_cnt_in_pctrank
-- (
--   start_date text,  -- ALL
--   ct_all bigint,
--   ct_all_sales_over_price_ratio bigint,
--   sales_over_price_ratio text,
--   w52_ann_ct bigint,
--   w52_pradchg_52w_ann numeric,
--   w52_pradchg_52w_ann_sd numeric,
--   w52_pradchg_52w_ann_sharpe numeric,
--   w52_pradchg_52w_ann_sortino numeric,
--   w52_pradchg_52w_ann_sharpe_short numeric,
--   w52_pradchg_52w_ann_sortino_true numeric,
--   w52_pradchg_52w_ann_sortino_short numeric,
--   w52_pradchg_52w_ann_sortino_true_short numeric,
--   w26_ann_ct bigint,
--   w26_pradchg_26w_ann numeric,
--   w26_pradchg_26w_ann_sd numeric,
--   w26_pradchg_26w_ann_sharpe numeric,
--   w26_pradchg_26w_ann_sortino numeric,
--   w26_pradchg_26w_ann_sortino_true numeric,
--   w26_pradchg_26w_ann_sharpe_short numeric,
--   w26_pradchg_26w_ann_sortino_short numeric,
--   w26_pradchg_26w_ann_sortino_true_short numeric,
--   w13_ann_ct bigint,
--   w13_pradchg_13w_ann numeric,
--   w13_pradchg_13w_ann_sd numeric,
--   w13_pradchg_13w_ann_sharpe numeric,
--   w13_pradchg_13w_ann_sortino numeric,
--   w13_pradchg_13w_ann_sortino_true numeric,
--   w13_pradchg_13w_ann_sharpe_short numeric,
--   w13_pradchg_13w_ann_sortino_short numeric,
--   w13_pradchg_13w_ann_sortino_true_short numeric
-- )
-- WITH (
--   OIDS=FALSE
-- );
-- ALTER TABLE sipro_data_store.my_0001_cnt_in_pctrank
--   OWNER TO postgres;




-- drop table sipro_data_store.my_0001_winners;
create table sipro_data_store.my_0001_winners as
--COPY -- 85,000 rows (SQL EXTRACT FROM ABOVE)
  select sqi.* from (  -- BEGIN find my 0001 WINNERS
    select 
        to_timestamp(dateindex*3600*24)::date start_date 
      , ticker_unq 
      , prchg_13w
      , company
      , company_id_unq
      , shr_aq1
      , now_price
      , mktcap::numeric(15,2) mktcap
      , mg_desc_ind
      , mg_desc_sect
      , trunc(least(case when 
         (   sales_q1::numeric(15,2) / nullif( shr_aq1::numeric(15,2), 0.00) 
           + sales_q2::numeric(15,2) / nullif( shr_aq2::numeric(15,2), 0.00)  
        -- + sales_q3::numeric(15,2) / nullif( shr_aq3::numeric(15,2), 0.00) 
        -- + sales_q4::numeric(15,2) / nullif( shr_aq4::numeric(15,2), 0.00) 
        )  / 
              nullif( price::numeric(15,2), 0.00)  
        is not null then
        percent_rank() over (partition by dateindex order by ( 
          ( 
              sales_q1::numeric(15,2) / nullif( shr_aq1::numeric(15,2), 0.00) 
            + sales_q2::numeric(15,2) / nullif( shr_aq2::numeric(15,2), 0.00)  
         -- + sales_q3::numeric(15,2) / nullif( shr_aq3::numeric(15,2), 0.00) 
         -- + sales_q4::numeric(15,2) / nullif( shr_aq4::numeric(15,2), 0.00) 
          )  / 
              nullif( price::numeric(15,2), 0.00)  
        ) desc nulls last )  
        else null end,0.99)::numeric * 1000.00,0)::int + 1 
        sales_over_price_ratio  
      , trunc(least(case when 
         (  
            (
              cgs_q1::numeric(15,2)  
            + cgs_q2::numeric(15,2)  
         -- + cgs_q3::numeric(15,2)  
         -- + cgs_q4::numeric(15,2)  
            ) / (
              nullif( 
                  sales_q1::numeric(15,2) 
                + sales_q2::numeric(15,2) 
                + sales_q3::numeric(15,2) 
                + sales_q4::numeric(15,2)
              , 0.0)
            ) * (-1.0)
         )  
        is not null then
        percent_rank() over (partition by dateindex order by ( 
          ( 
            (
              cgs_q1::numeric(15,2)  
            + cgs_q2::numeric(15,2)  
         -- + cgs_q3::numeric(15,2)  
         -- + cgs_q4::numeric(15,2)  
            ) / (
              nullif( 
                  sales_q1::numeric(15,2) 
                + sales_q2::numeric(15,2) 
                + sales_q3::numeric(15,2) 
                + sales_q4::numeric(15,2)
              , 0.0)
            ) * (-1.0)
          )  
        ) desc nulls last )  
        else null end,0.99)::numeric * 10.00,0)::int + 1 
        neg_cgs_over_sales
      , trunc(least(case when 
         (  
            (
              fcfps_q1::numeric(15,2) * nullif( shr_aq1::numeric(15,2), 0.00) 
            + fcfps_q2::numeric(15,2) * nullif( shr_aq2::numeric(15,2), 0.00)  
         -- + fcfps_q3::numeric(15,2) * nullif( shr_aq3::numeric(15,2), 0.00) 
         -- + fcfps_q4::numeric(15,2) * nullif( shr_aq4::numeric(15,2), 0.00) 
            ) / (
              nullif( 
                  sales_q1::numeric(15,2) 
                + sales_q2::numeric(15,2) 
                + sales_q3::numeric(15,2) 
                + sales_q4::numeric(15,2)
              , 0.0)
            ) 
         )  
        is not null then
        percent_rank() over (partition by dateindex order by ( 
          ( 
            (
              fcfps_q1::numeric(15,2) * nullif( shr_aq1::numeric(15,2), 0.00) 
            + fcfps_q2::numeric(15,2) * nullif( shr_aq2::numeric(15,2), 0.00)  
         -- + fcfps_q3::numeric(15,2) * nullif( shr_aq3::numeric(15,2), 0.00) 
         -- + fcfps_q4::numeric(15,2) * nullif( shr_aq4::numeric(15,2), 0.00) 
            ) / (
              nullif( 
                  sales_q1::numeric(15,2) 
                + sales_q2::numeric(15,2) 
                + sales_q3::numeric(15,2) 
                + sales_q4::numeric(15,2)
              , 0.0)
            )
          )  
        ) desc nulls last )  
        else null end,0.99)::numeric * 10.00,0)::int + 1 
        fcf_over_sales
      , trunc(least(case when 
         (  
            (
              fcfps_q1::numeric(15,2) * nullif( shr_aq1::numeric(15,2), 0.00) 
            + fcfps_q2::numeric(15,2) * nullif( shr_aq2::numeric(15,2), 0.00)  
         -- + fcfps_q3::numeric(15,2) * nullif( shr_aq3::numeric(15,2), 0.00) 
         -- + fcfps_q4::numeric(15,2) * nullif( shr_aq4::numeric(15,2), 0.00) 
            ) / (
              nullif( 
                  cgs_q1::numeric(15,2) 
                + cgs_q2::numeric(15,2) 
                + cgs_q3::numeric(15,2) 
                + cgs_q4::numeric(15,2)
              , 0.0)
            )
         )  
        is not null then
        percent_rank() over (partition by dateindex order by ( 
          ( 
            (
              fcfps_q1::numeric(15,2) * nullif( shr_aq1::numeric(15,2), 0.00) 
            + fcfps_q2::numeric(15,2) * nullif( shr_aq2::numeric(15,2), 0.00)  
         -- + fcfps_q3::numeric(15,2) * nullif( shr_aq3::numeric(15,2), 0.00) 
         -- + fcfps_q4::numeric(15,2) * nullif( shr_aq4::numeric(15,2), 0.00) 
            ) / (
              nullif( 
                  cgs_q1::numeric(15,2) 
                + cgs_q2::numeric(15,2) 
                + cgs_q3::numeric(15,2) 
                + cgs_q4::numeric(15,2)
              , 0.0)
            )
          )  
        ) desc nulls last )  
        else null end,0.99)::numeric * 10.00,0)::int + 1 
        fcf_over_cgs
      , w52_pradchg_52w_ann
      , w26_pradchg_26w_ann
      , w13_pradchg_13w_ann
    from sipro_data_store.si_finecon 
    where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq is not null 
    -- AND company NOT LIKE '%iShares%' and company NOT LIKE '%Vanguard%' and company NOT LIKE 'SPDR' and company NOT LIKE '%PowerShares%' and company NOT LIKE '%Fund%'
    -- SAME
    AND ((company !~~ '%iShares%'::text) AND (company !~~ '%Vanguard%'::text) AND (company !~~ 'SPDR'::text) AND (company !~~ '%PowerShares%'::text) AND (company !~~ '%Fund%'::text))
    --
    AND (company !~~ '%Holding%'::text) AND (mg_desc_ind !~~ '%Investment Service%'::text)
    -- try to stop DIP_AT_3_PERCENT_PROBLEM
    -- LAST - KEEPER - NOT COMMENTED OUT (26%@13w)
    -- BUT NOTICE 6_MO_SALES range in 6_MO_PRICE_CHANGE range
    and prchg_26w::numeric(15,2) > 0 -- better
         and fcfps_q1::numeric(15,2) > 0
      -- and prchg_04w::numeric(15,2) < 0.00 -- hills  but no better than ave -- -5.00 - better off searching for a 'better' stock
      -- AWEFUL
      -- and fcfps_q1::numeric(15,2) > 0 and fcfps_q1::numeric(15,2) > fcfps_q2::numeric(15,2) and fcfps_q2::numeric(15,2) > fcfps_q3::numeric(15,2)
      -- TRY
      -- and prchg_52w::numeric(15,2) > 0 
      -- TRY ( TRENDING SEVERLY WORSTENS IT )
      -- and sales_q1::numeric(15,2) > sales_q2::numeric(15,2)
      -- TRY ( TRENDING SEVERLY WORSTENS IT )
      -- and fcfps_q1::numeric(15,2) > fcfps_q2::numeric(15,2)
      -- ISNT WORTH IT
    -- and prchg_04w::numeric(15,2) > 0 -- ISNT WORTH IT
    -- SEVERLY NO
    -- and prchg_13w::numeric(15,2) > -15.00 
    -- SEVERLY NO
    -- and prchg_13w::numeric(15,2) > -15.00
      -- -- try to stop DIP_AT_3_PERCENT_PROBLEM
      -- and prchg_13w::numeric(15,2) > 0 -- ?
      -- -- try to stop DIP_AT_3_PERCENT_PROBLEM
      -- and prchg_52w::numeric(15,2) > 0 -- ?
    -- -- DIP_AT_3_PERCENT_PROBLEM
    -- -- no good help 20/58 instead of 21/56 ( BUT GOOD: DIP IS AT 3(12%) INSTEAD OF 3(9%) ) 
    -- and mg_desc_sect != 'Energy'
    -- -- ZERO ce - better result on the 26 week, by the same otherwise
    -- and coalesce(ce_q1::numeric(15,0),0.00) = 0.00 and coalesce(ce_q2::numeric(15,0),0.00) = 0.00
    -- -- sales momentum try
    -- -- sales_over_price_ratio 0001-0010 each is more consistenly the same
    -- -- TOP 1% AVE 18% ( BUT 0001 IS ONLY 15.6% ), otherwise TOP 1% IS 21.34
    -- -- and coalesce(sales_q1::numeric(15,0),0.00) > coalesce(sales_q2::numeric(15,0),0.00) and coalesce(sales_q2::numeric(15,0),0.00) > coalesce(sales_q3::numeric(15,0),0.00)
    -- -- OSAM_DEFENSE ( VARIANT ) - MADE ONLY 52W SLIGHTLY BETTER  ( 25.67 ) ( BUT A LARGER VARIANCE )
    -- and coalesce(tco_q1::numeric(15,2), 0.00) > coalesce(netinc_q1::numeric(15,2), 0.00) and  coalesce(tco_q2::numeric(15,2), 0.00) > coalesce(netinc_q2::numeric(15,2), 0.00)
    -- and dateindex_ci in (16465,16555)
  ) sqi   -- I did not see any *pattern* of industry or sector
-- where sales_over_price_ratio in (1,2,3,4)  -- IF COMMENTED OUT: 85,000 ROWS
-- where sales_over_price_ratio in (1);
order by sales_over_price_ratio 

--  FOUND
--  order by sales_over_price_ratio , neg_cgs_over_price_ratio(8-10) # companies with strong sales ARE ALSO sending out cogs 




-- IS THERE A 'AVAERAGE NUMBER OF SHARES' BIAS?

         (  fcfps_q1::numeric(15,2) * nullif( shr_aq1::numeric(15,2), 0.00) / sales_q1::numeric(15,2) 
          + fcfps_q2::numeric(15,2) * nullif( shr_aq2::numeric(15,2), 0.00) / sales_q2::numeric(15,2) +
          + fcfps_q3::numeric(15,2) * nullif( shr_aq3::numeric(15,2), 0.00) / sales_q3::numeric(15,2) + 
          + fcfps_q4::numeric(15,2) * nullif( shr_aq4::numeric(15,2), 0.00) / sales_q4::numeric(15,2) )  
        is not null then
        percent_rank() over (partition by dateindex order by ( 
          ( 
            (
              fcfps_q1::numeric(15,2) * nullif( shr_aq1::numeric(15,2), 0.00) 
            + fcfps_q2::numeric(15,2) * nullif( shr_aq2::numeric(15,2), 0.00)  
         -- + fcfps_q3::numeric(15,2) * nullif( shr_aq3::numeric(15,2), 0.00) 
         -- + fcfps_q4::numeric(15,2) * nullif( shr_aq4::numeric(15,2), 0.00) 
            ) / (
              nullif( 
                  sales_q1::numeric(15,2) 
                + sales_q1::numeric(15,2) 
                + sales_q1::numeric(15,2) 
                + sales_q1::numeric(15,2)
              )
            )
          )  
        ) desc nulls last )  
        else null end,0.99)::numeric * 10.00,0)::int + 1 
        fcf_over_price_ratio


select * from sipro_data_store.my_0001_winners where 0 = 1;

-- only 25ct, ENERGY SEEMS  TOO_VOLITILE TO PREDICT
--
-- ANY PRICE-BOTTOM_SCRAPERS?
--
-- 25ct,avg49,sd105
--
--select count(w13_pradchg_13w_ann), avg(w13_pradchg_13w_ann), stddev_pop(w13_pradchg_13w_ann)  from 
--sipro_data_store.my_0001_winners
--where sales_over_price_ratio <= 1 and neg_cgs_over_sales <= 3

select avg(w13_pradchg_13w_ann) from sipro_data_store.my_0001_winners; -- sales_over_price_ratio in (1,2,3,4) OF 1000 
-- "avg"
-- 21.41683289340954493342

select avg(w13_pradchg_13w_ann) from sipro_data_store.my_0001_winners where sales_over_price_ratio in (1);
-- "avg"
-- 36.36228933604826111596

select count(*) from sipro_data_store.my_0001_winners;
-- "count" 344

-- what is the average impact
select avg(sr.sales_over_price_ratio) sales_over_price_ratio -- NA # original where sales_over_price_ratio in (1,2,3,4) OF 1000 
     , avg(sr.neg_cgs_over_sales    ) neg_cgs_over_sales -- 1 to 10
     , avg(sr.fcf_over_sales        ) fcf_over_sales     -- 1 to 10
     , avg(sr.fcf_over_cgs          ) fcf_over_cgs       -- 1 to 10
from sipro_data_store.my_0001_winners sr;

--"sales_over_price_ratio","neg_cgs_over_sales","fcf_over_sales",     "fcf_over_cgs"
-- 2.3633720930232558,      8.0406976744186047,  8.4738372093023256,   7.3488372093023256

-- what is the average impact
select avg(sr.sales_over_price_ratio) sales_over_price_ratio -- NA # original where sales_over_price_ratio in (1,2,3,4) OF 1000 
     , avg(sr.neg_cgs_over_sales    ) neg_cgs_over_sales -- 1 to 10
     , avg(sr.fcf_over_sales        ) fcf_over_sales     -- 1 to 10
     , avg(sr.fcf_over_cgs          ) fcf_over_cgs       -- 1 to 10
from sipro_data_store.my_0001_winners sr where sr.sales_over_price_ratio in (1);
--"sales_over_price_ratio","neg_cgs_over_sales","fcf_over_sales","fcf_over_cgs"
--1.00000000000000000000,   8.0982142857142857,  8.4642857142857143,  7.4553571428571429

select coalesce(sq.sales_over_price_ratio,'ALL') sales_over_price_ratio
     , coalesce(sq.neg_cgs_over_sales,'ALL')     neg_cgs_over_sales
     , coalesce(sq.fcf_over_sales,'ALL')         fcf_over_sales
     , coalesce(sq.fcf_over_cgs,'ALL')           fcf_over_cgs
     --
     , count(     w13_pradchg_13w_ann) w13_pradchg_13w_ann_ct
     , avg(       w13_pradchg_13w_ann) w13_pradchg_13w_ann_avg
     , stddev_pop(w13_pradchg_13w_ann) w13_pradchg_13w_ann_stddev_pop
from (
  select case when sales_over_price_ratio::text is null then 'EMPTY' else sales_over_price_ratio::text end
       , case when neg_cgs_over_sales::text     is null then 'EMPTY' else neg_cgs_over_sales::text     end
       , case when fcf_over_sales::text         is null then 'EMPTY' else fcf_over_sales::text         end
       , case when fcf_over_cgs::text           is null then 'EMPTY' else fcf_over_cgs::text           end
       --
       , w13_pradchg_13w_ann
  from sipro_data_store.my_0001_winners
) sq
group by cube(
                   sales_over_price_ratio
                 , neg_cgs_over_sales
                 , fcf_over_sales
                 , fcf_over_cgs
) order by w13_pradchg_13w_ann_avg desc nulls last
;
-- 608 rows ( sales_over_price_ratio in (1,2,3,4) OF 1000 )
-- "sales_over_price_ratio","neg_cgs_over_sales","fcf_over_sales","fcf_over_cgs","w13_pradchg_13w_ann_ct","w13_pradchg_13w_ann_avg","w13_pradchg_13w_ann_stddev_pop"


-- most 90% of my loosers are 'Oil & Gas'
-- sales_over_price_ratio in (1)
-- I NEED industry/sector INFO and/or ee evaluations

--"mg_desc_ind" "Oil & Gas Operations"
-- NOT RELATIVE SD: SD/AVG
-- YES ABSOLUTE SD: SD

select 
       coalesce(sq.sales_over_price_ratio,'ALL') sales_over_price_ratio
     , coalesce(sq.mg_desc_ind           ,'ALL') mg_desc_ind
     --
     , count(     shr_aq1::numeric)   shr_aq1_ct
     , avg(       shr_aq1::numeric)   shr_aq1_avg
     , stddev_pop(shr_aq1::numeric)   shr_aq1_sd
     , stddev_pop(shr_aq1::numeric)   / avg(         shr_aq1::numeric)   shr_aq1_rat_sd_o_avg
     , count(     now_price::numeric) now_price_ct
     , avg(       now_price::numeric) now_price_avg
     , stddev_pop(now_price::numeric) now_price_sd
     , stddev_pop(now_price::numeric) / avg(         now_price::numeric) now_price_rat_sd_o_avg

     , count(     w13_pradchg_13w_ann::numeric) w13_pradchg_13w_ann_ct
     , avg(       w13_pradchg_13w_ann::numeric) w13_pradchg_13w_ann_avg
     , stddev_pop(w13_pradchg_13w_ann::numeric) w13_pradchg_13w_ann_sd
     , stddev_pop(w13_pradchg_13w_ann::numeric) / avg(         w13_pradchg_13w_ann::numeric) w13_pradchg_13w_ann_rat_sd_o_avg

     , count(     mktcap::numeric) mktcap_ct
     , avg(       mktcap::numeric) mktcap_avg
     , stddev_pop(mktcap::numeric) mktcap_sd
     , stddev_pop(mktcap::numeric) / avg(         mktcap::numeric) mktcap_rat_sd_o_avg
     
from (
  select case when sales_over_price_ratio::text is null then 'EMPTY' else sales_over_price_ratio::text end
       , case when mg_desc_ind                  is null then 'EMPTY' else mg_desc_ind                  end
       --
       , shr_aq1
       , now_price
       , w13_pradchg_13w_ann
       , mktcap
  -- drop table sipro_data_store.my_0001_winners;
  from sipro_data_store.my_0001_winners where sales_over_price_ratio in (1,2,3,4)
) sq
group by cube(
                   sales_over_price_ratio
                 , mg_desc_ind
) order by mktcap_sd desc nulls last
;


-- THIS ONE -- remove those ind that  have a high now_price_sd membership in sales_over_price(1-4)
-- order by now_price_sd desc nulls last
--
-- any DISTINCT > ALL,ALL, get rid of it
--
-- these are all above: ALL,ALL
--
-- "mg_desc_ind" "Retail (Technology)"
-- "mg_desc_ind" "Crops"
-- "mg_desc_ind" "Oil & Gas Operations"


select * from my_0001_winners where sales_over_price_ratio in (1);

select sales_over_price_ratio
     , count(     w13_pradchg_13w_ann::numeric) w13_pradchg_13w_ann_ct
     , avg(       w13_pradchg_13w_ann::numeric) w13_pradchg_13w_ann_avg
     , stddev_pop(w13_pradchg_13w_ann::numeric) w13_pradchg_13w_ann_sd
     , stddev_pop(w13_pradchg_13w_ann::numeric) / avg(         w13_pradchg_13w_ann::numeric) w13_pradchg_13w_ann_rat_sd_o_avg
from sipro_data_store.my_0001_winners 
where sales_over_price_ratio in (1,2,3,4) -- and mg_desc_ind not in ('Retail (Technology)','Crops','Oil & Gas Operations') 
group by cube(sales_over_price_ratio) 
order by      sales_over_price_ratio;

"sales_over_price_ratio","w13_pradchg_13w_ann_ct","w13_pradchg_13w_ann_avg","w13_pradchg_13w_ann_sd","w13_pradchg_13w_ann_rat_sd_o_avg"
1, 92,36.36228933604826111596,101.9672268713595022192401784463243476202957, 2.8042026157652530998392415476470443463336
2, 59, 6.46982464668801449017,75.9286459773340407538701952802676483719984 ,11.7358120387703058030121292810496468275333 ( HI SD IS BAD )
3, 58,21.32287875763952266145,79.1110420070477217203991274494043724716417 , 3.7101482828018219555178404473588106157701
4, 62,13.55136246935260459684,99.3790648048132263974279491444105872864940 , 7.3335109314333695675591741848137454266640
 ,271,21.41683289340954493342,92.3171436304793901912506378525440494486509 , 4.3104946510969654856875977863448366707263
      *

select sales_over_price_ratio
     , count(     w13_pradchg_13w_ann::numeric) w13_pradchg_13w_ann_ct
     , avg(       w13_pradchg_13w_ann::numeric) w13_pradchg_13w_ann_avg
     , stddev_pop(w13_pradchg_13w_ann::numeric) w13_pradchg_13w_ann_sd
     , stddev_pop(w13_pradchg_13w_ann::numeric) / avg(         w13_pradchg_13w_ann::numeric) w13_pradchg_13w_ann_rat_sd_o_avg
from sipro_data_store.my_0001_winners 
where sales_over_price_ratio in (1,2,3,4) and mg_desc_ind not in ('Retail (Technology)','Crops','Oil & Gas Operations') 
group by cube(sales_over_price_ratio) 
order by      sales_over_price_ratio;

"sales_over_price_ratio","w13_pradchg_13w_ann_ct","w13_pradchg_13w_ann_avg","w13_pradchg_13w_ann_sd","w13_pradchg_13w_ann_rat_sd_o_avg"
1, 57,47.36426734518417096940,112.8232816839746726297197807721628886248493, 2.3820337146088282044206671543091019386620
2, 29, 5.99655912358438498303, 89.6842188057374652651693080232720066316997,14.9559467283513740134809150785265723931904 ( HI SD IS BAD )
3, 39,32.03722682463163427200, 88.0709717083226532357752233856419551535403, 2.7490198259173232271559350681728227438253
4, 44,27.78442979078560726582,109.3656174439335910197708503909116033571812, 3.9362196117554827204144168142934769173967
 ,169,31.63094798943577139685,103.8152846059315225483855254760251838172330, 3.2820794571381218238319982217295676617548
-- IF I NEED 120 FIRMS ( 2/ MO ) + avg_10 ( + same sd ) -- CONCLUSION

-- WHAT MADE 2 SO DAMN VOLITILE ( THAT I CAN NOT FIGURE OUT )
select * from my_0001_winners where sales_over_price_ratio in (2) and mg_desc_ind not in ('Retail (Technology)','Crops','Oil & Gas Operations');

"w13_pradchg_13w_ann" -- WHAT IS WRONG WITH MY MATH?
-118.16               -- WHAT IS WRONG WITH MY MATH?

-- TON OF MISSING DATA IN (2)

"start_date","ticker_unq","company","company_id_unq","shr_aq1","now_price","mktcap","mg_desc_ind","mg_desc_sect","sales_over_price_ratio","neg_cgs_over_sales","fcf_over_sales","fcf_over_cgs","w52_pradchg_52w_ann","w26_pradchg_26w_ann","w13_pradchg_13w_ann"
"2015-06-30","TA","TravelCenters of America LLC","AE809","36.4035","14.850",569.40,"Retail (Specialty Non-Apparel)","Services",2,4,8,7,-44.34,-74.76,-118.16

-- (2): NO "now_price" BELOW 20 ( HISTORY on NON-MAINTAINING ) performance? NO - BADE


select sales_over_price_ratio
     , count(     w13_pradchg_13w_ann::numeric) w13_pradchg_13w_ann_ct
     , avg(       w13_pradchg_13w_ann::numeric) w13_pradchg_13w_ann_avg
     , stddev_pop(w13_pradchg_13w_ann::numeric) w13_pradchg_13w_ann_sd
     , stddev_pop(w13_pradchg_13w_ann::numeric) / avg(         w13_pradchg_13w_ann::numeric) w13_pradchg_13w_ann_rat_sd_o_avg
from sipro_data_store.my_0001_winners 
where sales_over_price_ratio in (1,2,3,4) and mg_desc_ind not in ('Retail (Technology)','Crops','Oil & Gas Operations') and now_price::numeric > 20.0
group by cube(sales_over_price_ratio) 
order by      sales_over_price_ratio;
-- NO 57f@47% ABOVE IS BETTER THAN 60f@30%

-- BUT 18 SUPERFIMRS SHOW UP ( 86% RETURN )
"sales_over_price_ratio","w13_pradchg_13w_ann_ct","w13_pradchg_13w_ann_avg","w13_pradchg_13w_ann_sd","w13_pradchg_13w_ann_rat_sd_o_avg"
1,18,86.38836828991138475778,98.5840503842824977364212049330187455064750,1.1411727335032365736863653609257205898691

select *
from sipro_data_store.my_0001_winners 
where sales_over_price_ratio in (1,2,3,4) and mg_desc_ind not in ('Retail (Technology)','Crops','Oil & Gas Operations') and now_price::numeric > 20.0
order by sales_over_price_ratio
-- OF 18, (3X YEAR) ONE LOOSER/ THREE TIES ( THE OTHERS ARE BIG WINNERS )

-- industry returns
-- "mg_desc_ind" -- "Gold & Silver"

alter table sipro_data_store.my_0001_winners drop column avg_prchg_13w_date_ind_wtd;
alter table sipro_data_store.my_0001_winners add         avg_prchg_13w_date_ind_wtd numeric;

update sipro_data_store.my_0001_winners win
set avg_prchg_13w_date_ind_wtd = sq.avg_prchg_13w_date_ind_wtd
from (
with wtd as (
select start_date, mg_desc_ind, sum(mktcap::numeric) mktcap_date_ind_wtd
from sipro_data_store.my_0001_winners
where mg_desc_ind = mg_desc_ind
group by start_date, mg_desc_ind
order by start_date, mg_desc_ind
) 
select std.start_date, std.mg_desc_ind, avg( std.prchg_13w::numeric * std.mktcap::numeric / nullif(wtd.mktcap_date_ind_wtd,0) ) avg_prchg_13w_date_ind_wtd
from sipro_data_store.my_0001_winners std, wtd

where std.start_date  = wtd.start_date and
      std.mg_desc_ind = wtd.mg_desc_ind
group by std.start_date, std.mg_desc_ind
order by std.start_date, std.mg_desc_ind
) sq
where   win.start_date  = sq.start_date 
    and win.mg_desc_ind = sq.mg_desc_ind
-- WORKS

-- BUT NEED THE INDUSTRY RETURN COMPARED TO ALL THE OTHER INDUSTRIES

--

-- only
-- "mg_desc_ind" -- "Gold & Silver"

alter table sipro_data_store.my_0001_winners drop column avg_prchg_13w_date_ind_gs_wtd;

alter table sipro_data_store.my_0001_winners add         avg_prchg_13w_date_ind_gs_wtd numeric;
update sipro_data_store.my_0001_winners win
set avg_prchg_13w_date_ind_gs_wtd = sq.avg_prchg_13w_date_ind_gs_wtd
from (
with wtd as (
select start_date, mg_desc_ind, sum(mktcap::numeric) mktcap_date_ind_wtd
from sipro_data_store.my_0001_winners
where mg_desc_ind = 'Gold & Silver'
group by start_date, mg_desc_ind
order by start_date, mg_desc_ind
) 
select std.start_date, std.mg_desc_ind, avg( std.prchg_13w::numeric * std.mktcap::numeric / nullif(wtd.mktcap_date_ind_wtd,0) ) avg_prchg_13w_date_ind_gs_wtd
from sipro_data_store.my_0001_winners std, wtd
where std.start_date  = wtd.start_date and
      std.mg_desc_ind = wtd.mg_desc_ind and std.mg_desc_ind =  'Gold & Silver'
group by std.start_date, std.mg_desc_ind
order by std.start_date, std.mg_desc_ind
) sq
where   win.start_date  = sq.start_date 
-- returning *
 -- and win.mg_desc_ind = sq.mg_desc_ind

--       6 +     = 7
--       3 to  5 = 6
--       1 to  3 = 5
-- need -1 to  1 = 4
--      -1 to -3 = 3
--      -3 to -5 = 2
--      -6 +     = 1


-- TECHNIQUE ( TWO UPDATES and ONE STATEMENT )




-- UPDATE
-- later case when 

-- THINK CAN NOT BE IN q10 in the OTHER 3 categories ( else I will not 'buy' )










-- LEFT_OFF: HOW FAR DOWN IN RISKY FIRMS TO I GO 'AND GET A DECENT RETURN' and LOWER RISK

-- order by now_price_sd desc nulls last
-- notice that BELOW ALL,ALL 
-- small numbers of firms avg(<10)show up for each ind but with VERY small (<4) sddev_pop


----

-- shr_aq
-- LESS SHARES OUT ... SLIGHTLY DO BETTER

-- mktcap ? ... NO PATTERN
--  order by mktcap_avg desc nulls last
-- SLIGHLY BETTER with a HIGH MKTCAP

-- order by mktcap_sd desc nulls last
-- SAME CONCLUSION AS now_price_sd ( APROX SAME FIRMS TO GET RID OF )






-----------

-- -- Table: sipro_data_store.my_0001_winners
-- 
-- -- DROP TABLE sipro_data_store.my_0001_winners;
-- 
-- CREATE TABLE sipro_data_store.my_0001_winners
-- (
--   start_date date,
--   ticker_unq text,
--   company text,
--   company_id_unq text,
--   mktcap numeric(15,2),
--   mg_desc_ind text,
--   mg_desc_sect text,
--   sales_over_price_ratio integer,  -- 1 to 1000 ( 1 is the best(most) sales/price ) 
--   fcf_over_price_ratio integer,    -- 1 to 50   ( 1 is the best(most)   fcf/price )
--   w52_pradchg_52w_ann numeric,
--   w26_pradchg_26w_ann numeric,
--   w13_pradchg_13w_ann numeric
-- )
-- WITH (
--   OIDS=FALSE
-- );
-- ALTER TABLE sipro_data_store.my_0001_winners
--   OWNER TO postgres;



-- select count(*) from sipro_data_store.my_0001_winners;
-- 84557

-- LEFT_OFF create table my_investigation as
-- LEFT_OFF 


-----------------------
-----------------------

-- only 25ct, ENERGY SEEMS  TOO_VOLITILE TO PREDICT
-- ANY PRICE-BOTTOM_SCRAPERS?
-- 25ct,avg49,sd105
--select count(w13_pradchg_13w_ann), avg(w13_pradchg_13w_ann), stddev_pop(w13_pradchg_13w_ann)  from 
--sipro_data_store.my_0001_winners
--where sales_over_price_ratio <= 1 and neg_cgs_over_sales <= 3



(PART 2)
How to load exernal FRED/other data into PostgreSQL ( BONDS(COMPETING) )
-------------------------------------------------------------------------

# WORKS ... made ... bonds_chg <- to.monthly.lwd(bonds_chg)
# WORKS ... made ... UpsizeAAIItoPostgreSQL(conn, bonds_chg)

select * from sipro_data_store.bonds_chg;



# PART 1 IS BELOW
...


alter table sipro_data_store.si_finecon add mg_desc_ind_sum_mktcap_jamesos numeric(15,2);
-- instantaneous

explain -- 649,000 ( write speed is 20x+ slower )
update sipro_data_store.si_finecon trg set
  mg_desc_ind_sum_mktcap_jamesos = sq.mg_desc_ind_sum_mktcap_jamesos
from (
select dateindex, mg_desc_ind, sum( mktcap::numeric(15,2) )::numeric(15,2) mg_desc_ind_sum_mktcap_jamesos
  from sipro_data_store.si_finecon  
      where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%']) 
  group by dateindex, mg_desc_ind
) sq where trg.dateindex = sq.dateindex and trg.mg_desc_ind = sq.mg_desc_ind;
-- Query returned successfully: 584936 rows affected, 24:25 minutes execution time.

-- LEFT_OFF ( back from San Fancisco )
-- [ ] STORE w_avg_mg_ind_jamesos IN A SEPARTE small TABLE

alter table sipro_data_store.si_finecon add prchg_04w_w_avg_mg_ind_jamesos numeric(15,2);
alter table sipro_data_store.si_finecon add prchg_13w_w_avg_mg_ind_jamesos numeric(15,2);
alter table sipro_data_store.si_finecon add prchg_26w_w_avg_mg_ind_jamesos numeric(15,2);
alter table sipro_data_store.si_finecon add prchg_52w_w_avg_mg_ind_jamesos numeric(15,2);

-- SHOULD WORK

explain --653,000
update sipro_data_store.si_finecon trg set 
    prchg_04w_w_avg_mg_ind_jamesos = sq.prchg_04w_w_avg_mg_ind_jamesos
  , prchg_13w_w_avg_mg_ind_jamesos = sq.prchg_13w_w_avg_mg_ind_jamesos
  , prchg_26w_w_avg_mg_ind_jamesos = sq.prchg_26w_w_avg_mg_ind_jamesos
  , prchg_52w_w_avg_mg_ind_jamesos = sq.prchg_52w_w_avg_mg_ind_jamesos
from (
  select dateindex, mg_desc_ind, 
     avg(prchg_04w::numeric(15,2) * mg_desc_ind_sum_mktcap_jamesos)::numeric(15,2) prchg_04w_w_avg_mg_ind_jamesos
   , avg(prchg_13w::numeric(15,2) * mg_desc_ind_sum_mktcap_jamesos)::numeric(15,2) prchg_13w_w_avg_mg_ind_jamesos        
   , avg(prchg_26w::numeric(15,2) * mg_desc_ind_sum_mktcap_jamesos)::numeric(15,2) prchg_26w_w_avg_mg_ind_jamesos 
   , avg(prchg_52w::numeric(15,2) * mg_desc_ind_sum_mktcap_jamesos)::numeric(15,2) prchg_52w_w_avg_mg_ind_jamesos                   
  from sipro_data_store.si_finecon  
      where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%']) 
  group by dateindex, mg_desc_ind-- order by 1,2
) sq where trg.dateindex = sq.dateindex and trg.mg_desc_ind = sq.mg_desc_ind;


-- TRYING TO ADD IN GOLD & SILVER INDUSTRY RETURNS FOR EACH RECORD

alter table sipro_data_store.si_finecon add prchg_04w_w_avg_mg_ind_gs_jamesos numeric(15,2);
alter table sipro_data_store.si_finecon add prchg_13w_w_avg_mg_ind_gs_jamesos numeric(15,2);
alter table sipro_data_store.si_finecon add prchg_26w_w_avg_mg_ind_gs_jamesos numeric(15,2);
alter table sipro_data_store.si_finecon add prchg_52w_w_avg_mg_ind_gs_jamesos numeric(15,2);

explain
update sipro_data_store.si_finecon trg set 
    prchg_04w_w_avg_mg_ind_gs_jamesos = sq.prchg_04w_w_avg_mg_ind_gs_jamesos
  , prchg_13w_w_avg_mg_ind_gs_jamesos = sq.prchg_13w_w_avg_mg_ind_gs_jamesos
  , prchg_26w_w_avg_mg_ind_gs_jamesos = sq.prchg_26w_w_avg_mg_ind_gs_jamesos
  , prchg_52w_w_avg_mg_ind_gs_jamesos = sq.prchg_52w_w_avg_mg_ind_gs_jamesos
from (
  -- IS THERE A 'BETTER' WAY? ( INTERIOR TAKES FOREVER: BETTER, STORE w_avg_mg_ind_jamesos IN A SEPARTE small TABLE
  -- distinct on 'now working for me' http://www.vertabelo.com/blog/technical-articles/postgresql-select-distinct-on
  select dateindex
    , mg_desc_ind
    , avg(prchg_04w_w_avg_mg_ind_jamesos)  prchg_04w_w_avg_mg_ind_jamesos -- they are all the same value
    , avg(prchg_13w_w_avg_mg_ind_jamesos)  prchg_13w_w_avg_mg_ind_jamesos
    , avg(prchg_26w_w_avg_mg_ind_jamesos)  prchg_26w_w_avg_mg_ind_jamesos
    , avg(prchg_52w_w_avg_mg_ind_jamesos)  prchg_52w_w_avg_mg_ind_jamesos
  from sipro_data_store.si_finecon  
      where adr = 'f' and exchange != 'O' and mktcap::numeric(15,2) >= 200.00 and company_id_unq is not null and company !~~ any(array['%iShares%','%Vanguard%','SPDR','%PowerShares%','%Fund%']) 
      and mg_desc_ind = 'Gold & Silver'
  group by dateindex, mg_desc_ind
) sq where trg.dateindex = sq.dateindex and trg.mg_desc_ind = sq.mg_desc_ind;


select distinct on  dateindex from sipro_data_store.si_finecon;


vacuum;


